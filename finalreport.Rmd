# Pathways to Graduation
```{r setup, echo=F}
opts_chunk$set(echo=FALSE, 
               warning=FALSE,
               message=FALSE, 
               results='hide', 
               dev='quartz_png', 
               dev.args=list(family='Open Sans'), 
               fig.height=5.375, fig.width=8.75)
```
Since 2003, the Rhode Island Board of Regents has developed, refined, and implemented regulations for Proficiency-Based Graduation Requirements (PBGRs) to ensure that each diploma recipient has attained an acceptable level of achievement in each of six core academic areas in order to be successful in college and careers (R.I. Admin. Code 21-2-46).

In 2011, the state Board of Regents for Elementary and Secondary Education adopted revised regulations including the state assessment component (R.I. Admin. Code 21-2-46), that would go into effect with the graduating class of 2014. The PBGRs require students to:

* meet partial proficiency or above  on the state assessment or assessments in reading and in math (a 2 or greater on a 4 point scale for the New England Common Assessment Program);
* successfully complete state and local course requirements;
* successfully complete two performance-based diploma assessments.

With these new criteria, Providence Public School District (PPSD) faces a potential graduation crisis; roughly 65% of the class of 2014 is in jeopardy of not meeting this standard.

The PBGRs also require that local education agencies provide individualized supports for their students to meet these requirements. The most prominent mechanisms for these supports are individual learning plans for students in grades 6–12 that monitor their progress against the requirements and an early warning system to identify students in need of supports.

PPSD developed the Personal Graduation Plan (PGP) and On-track to Graduate Progress Plan (OTGPP) to collect and communicate student progress toward meeting the new PBGR requirements. A new software package (Richer Picture), allows guidance counselors, teachers, parents, and students to precisely monitor the requirements each student needs to complete to graduate. The district has always collected information for this purpose but has never automated its collection and presentation in one place for staff, students, and families. Previously, guidance counselors analyzed transcripts manually to determine if students met their credit requirements and collected hard copy artifacts of student work.

## Personal Graduation Plans as a Process
The Personal Graduation Plan Process has a sophisticated concept of student success. Rather than understanding graduation as meeting compliance-driven requirements, the PGP views graduation as a demonstration that PPSD successfully met that student’s needs to attain success. In practice this is articulated through a belief that the district has to build a comprehensive system of supports for students so that intervention is individualized to meet each student's academic and non-academic needs. This is in contrast, for example, with a system that universally responds to under-credited students with credit recovery and retesting opportunities without any opportunity to understand why each of those students was unsuccessful in their initial attempts.

PPSD envisions its staff identifying individual needs through a data-informed decision making process and select only evidence-based programmatic interventions as part of the PGP. Students will not be identified and matched to programs entirely through a fixed set of business rules or a decision tree. Instead, PPSD is enabling its staff to review several forms of complex data on individual students to facilitate matching them to a vast array of interventions, which themselves have detailed information about target groups, purpose, and evidence on program efficacy.

However, of the decisions the staff needs to make during the PGP process, identification of students is often the least complex and the most time consuming. Teachers, guidance counselors, and other staff with close relationships to their students often know those who are most at risk. However, identifying staff who knows each student and having that staff member review each student they know best is time consuming, even if simply assigning risk is straightforward. The key innovations of predictive models are, therefore:

* setting expectations objectively based on past performance that leads to results, quickly, for all students.
* distinguishing more precisely between levels of risk, reducing the likelihood that a student who is falling behind is not identified
* achieving greater sensitivity to signs that students are falling behind before it is evident that staff should be paying extra attention.

Providing clear information about which students are at risk of not graduating permits PPSD staff engaged in the PGP process to focus on uncovering why students are off track and how to address those needs.

## Early Warning Systems
The PGP was motivated by the need to monitor each student's status on the PBGRs as well as provide helpful leading indicators of success. Leading indicators are data that can reveal information about likely success before directly experiencing the tasks associated with the PBGRs (Foley and Mishook). Research led by the Chicago Consortium for School Research (Allensworth and Easton, 2005; Allensworth and Easton, 2007; Allensworth, 2013;), the Everyone Graduates Center at Johns Hopkins University (Balfanz et al., 2007; Bruce et al., 2011), and the Annenberg Institute for School Reform (Suppovitz et al., 2012) and others for the past 15 years have focused on strategies for early identification of students in needs of support. These systems are often referred to as Early Warning Systems. Much of the research has focused on identifying student demographics, performance benchmarks, and behaviors that separately or together predict graduation. Some examples of these indicators are: reading by the end of third grade, math proficiency before entering high school, number of disciplinary infractions or suspensions, and on-time promotion to the tenth grade. 

Increasingly, researchers and analysts are using techniques common in forecasting and predictive modeling to identify students at-risk of not meeting a particular benchmark. These techniques promise greater accuracy while identifying a larger proportion of the students who will ultimately not meet their benchmarks, where previous techniques often traded accuracy for failing to identify many students who were falling behind (Bowers et. al., 2013).

Bowers, Sprott, and Taff (2013) have a thorough meta-analysis of 36 studies and 110 drop out indicators cataloging this research as far back as the early 1980s. They have helpfully documented the features used in each of these studies, grade span of included students, and key measures of the predictive properties of each indicator.

We have generated new models for identifying which students are at risk of failing to graduate based on this rich body of research using Providence Public Schools Data. Utilizing readily available administrative and student performance data, we can have multiple modeling techniques and combination of drop out indicators suggested by previous work on predicting high school graduation. Like Bower, Sprott, and Taff (2013), we use the Relative-operator characteristic (ROC) and confusion matrices as the primary tool for comparing the predictive properties of these models. Because of their work, we are also able to include the ROC properties of other models and indicator systems to compare against our locally developed models. As a result, we can assess the predictive qualities of these models compared to the leading research in predicting high school success nationwide.

```{r Initialization}
setwd('/Users/jason/Dropbox/code/PPSDCollegeReadiness/')
source('dependencies.R')
require(sjPlot)
file.sources <- list.files('/Users/jason/Dropbox/code/PPSDCollegeReadiness/R', 
                          pattern='*.R$', full.names=TRUE, ignore.case=TRUE)
invisible(sapply(file.sources, source, .GlobalEnv))
# invisible(source('load.R'))
# invisible(source('buildTables.R'))
# tables2005_2006$course$studentid <- as.character(tables2005_2006$course$studentid)
# tables2006_2007$course$studentid <- as.character(tables2006_2007$course$studentid)
# tables2007_2008$course$studentid <- as.character(tables2007_2008$course$studentid)
# tables2008_2009$course$studentid <- as.character(tables2008_2009$course$studentid)
# tables2009_2010$course$studentid <- as.character(tables2009_2010$course$studentid)
# tables2010_2011$course$studentid <- as.character(tables2010_2011$course$studentid)
# tables2011_2012$course$studentid <- as.character(tables2011_2012$course$studentid)
# tables2012_2013$course$studentid <- as.character(tables2012_2013$course$studentid)
# invisible(source('person.R'))
# tables2005_2006$course <- left_join(tables2005_2006$course,
#                                     person[, c('sasid', 'studentid')])
# tables2006_2007$course <- left_join(tables2006_2007$course,
#                                     person[, c('sasid', 'studentid')])
# tables2007_2008$course <- left_join(tables2007_2008$course,
#                                     person[, c('sasid', 'studentid')])
# tables2008_2009$course <- left_join(tables2008_2009$course,
#                                     person[, c('sasid', 'studentid')])
# tables2009_2010$course <- left_join(tables2009_2010$course,
#                                     person[, c('sasid', 'studentid')])
# tables2010_2011$course <- left_join(tables2010_2011$course,
#                                     person[, c('sasid', 'studentid')])
# tables2011_2012$course <- left_join(tables2011_2012$course,
#                                     person[, c('sasid', 'studentid')])
# tables2012_2013$course <- left_join(tables2012_2013$course,
#                                     person[, c('sasid', 'studentid')])
# 
# invisible(source('attendance.R'))
# attendance$sasid <- as.character(attendance$sasid)
# charters <- c(114, 117, 189, 185)
# rm(list=c('reg0405', 'reg0506', 'reg0607', 'reg0708', 
#           'reg0809', 'reg0910', 'reg1011'))
load('Cache/initialEnv.RData')
theme_set(theme_jb())
```

```{r 8GMData}
# Build cohort for predictive model
hs0708 <- subset(person, (schoolyear_first=='2007_2008' & grade_first==9) | 
                         (schoolyear_first=='2008_2009' & grade_first==10) | 
                         (schoolyear_first=='2009_2010' & grade_first==11) | 
                         (schoolyear_first=='2010_2011' & grade_first==12))
hs0809 <- subset(person, (schoolyear_first=='2008_2009' & grade_first==9) | 
                         (schoolyear_first=='2009_2010' & grade_first==10) | 
                         (schoolyear_first=='2010_2011' & grade_first==11) | 
                         (schoolyear_first=='2011_2012' & grade_first==12))
hs0910 <- subset(person, (schoolyear_first=='2009_2010' & grade_first==9) | 
                         (schoolyear_first=='2010_2011' & grade_first==10) | 
                         (schoolyear_first=='2011_2012' & grade_first==11) | 
                         (schoolyear_first=='2012_2013' & grade_first==12))
hs0708$sasid <- as.character(hs0708$sasid)
hs0809$sasid <- as.character(hs0809$sasid)
hs0910$sasid <- as.character(hs0910$sasid)

hs0708 <- left_join(hs0708, attendance %.% filter(schoolyear == '2006_2007',
                                                  grade == 8)
                                       %.% select(sasid, attendance, 
                                                  tardy, suspended))
hs0809 <- left_join(hs0809, attendance %.% filter(schoolyear == '2007_2008',
                                                  grade == 8)
                                       %.% select(sasid, attendance, 
                                                  tardy, suspended))
hs0910 <- left_join(hs0910, attendance %.% filter(schoolyear == '2008_2009',
                                                  grade == 8)
                                       %.% select(sasid, attendance, 
                                                  tardy, suspended))

names(hs0708)[which(names(hs0708) %in% c('suspended'))] <- 'suspend8th'
names(hs0708)[which(names(hs0708) %in% c('tardy'))] <- 'tardy8th'
names(hs0708)[which(names(hs0708) %in% c('attendance'))] <- 'attendance8th'
names(hs0809)[which(names(hs0809) %in% c('suspended'))] <- 'suspend8th'
names(hs0809)[which(names(hs0809) %in% c('tardy'))] <- 'tardy8th'
names(hs0809)[which(names(hs0809) %in% c('attendance'))] <- 'attendance8th'
names(hs0910)[which(names(hs0910) %in% c('suspended'))] <- 'suspend8th'
names(hs0910)[which(names(hs0910) %in% c('tardy'))] <- 'tardy8th'
names(hs0910)[which(names(hs0910) %in% c('attendance'))] <- 'attendance8th'

# Calculate age when student enters 9th grade for the first time.
hs0708 <- mutate(hs0708, overage = age_calc(dob, as.Date('2006-09-01'), 
                                            units='months'))
hs0809 <- mutate(hs0809, overage = age_calc(dob, as.Date('2007-09-01'), 
                                            units='months'))
hs0910 <- mutate(hs0910, overage = age_calc(dob, as.Date('2008-09-01'), 
                                            units='months'))
# Calculate mobility for students
# Eighth Grade year
mobile0607 <-  moves_calc(subset(tables2006_2007$enrollment, 
                                sasid %in% hs0708$sasid & grade == 8),
                          gap = 30, enrollby = "2006-10-01")

mobile0607$sasid <- as.character(mobile0607$sasid)
hs0708 <- left_join(hs0708, mobile0607)

mobile0708 <-  moves_calc(subset(tables2007_2008$enrollment, 
                                sasid %in% hs0809$sasid & grade == 8),
                          gap = 30, enrollby = "2007-10-01")

mobile0708$sasid <- as.character(mobile0708$sasid)
hs0809 <- left_join(hs0809, mobile0708)

mobile0809 <-  moves_calc(subset(tables2008_2009$enrollment, 
                                sasid %in% hs0910$sasid & grade == 8),
                          gap = 30, enrollby = "2008-10-01")

mobile0809$sasid <- as.character(mobile0809$sasid)
hs0910 <- left_join(hs0910, mobile0809)

# Bring in 8th grade performance on standardized tests.
tables2006_2007$achievement$sasid <- as.character(tables2006_2007$achievement$sasid)
tables2006_2007$achievement$studentid <- as.character(tables2006_2007$achievement$studentid)

tables2007_2008$achievement$sasid <- as.character(tables2007_2008$achievement$sasid)
tables2007_2008$achievement$studentid <- as.character(tables2007_2008$achievement$studentid)

tables2008_2009$achievement$sasid <- as.character(tables2008_2009$achievement$sasid)
tables2008_2009$achievement$studentid <- as.character(tables2008_2009$achievement$studentid)


hs0708 <- left_join(hs0708, tables2006_2007$achievement %.% 
                            filter(testgrade_N==8, testgrade_N==grade) %.%
                            dplyr::select(sasid, grade, reaal, reascsc, matal, 
                                          matscsc, testgrade_N, reanormal, 
                                          matnormal))
hs0809 <- left_join(hs0809, tables2007_2008$achievement %.% 
                            filter(testgrade_N==8, testgrade_N==grade) %.%
                            dplyr::select(sasid, grade, reaal, reascsc, matal, 
                                          matscsc, testgrade_N, reanormal, 
                                          matnormal))
hs0910 <- left_join(hs0910, tables2008_2009$achievement %.% 
                            filter(testgrade_N==8, testgrade_N==grade) %.%
                            dplyr::select(sasid, grade, reaal, reascsc, matal, 
                                          matscsc, testgrade_N, reanormal, 
                                          matnormal))

# Attendance normalized
hs0708 <- mutate(hs0708, attendnormal = (attendance8th - 
                                         mean(attendance8th, na.rm=TRUE)) / 
                                        sd(attendance8th, na.rm=TRUE))
hs0809 <- mutate(hs0809, attendnormal = (attendance8th - 
                                         mean(attendance8th, na.rm=TRUE)) / 
                                        sd(attendance8th, na.rm=TRUE))
hs0910 <- mutate(hs0910, attendnormal = (attendance8th - 
                                         mean(attendance8th, na.rm=TRUE)) / 
                                        sd(attendance8th, na.rm=TRUE))

# Current LEP
lep0708 <- subset(tables2006_2007$person_annual,
                  grade == 8)[, c('sasid','lep')]
names(lep0708)[2] <- 'lep8th'
hs0708 <- left_join(hs0708, lep0708)

lep0809 <- subset(tables2007_2008$person_annual,
                  grade == 8)[, c('sasid','lep')]
names(lep0809)[2] <- 'lep8th'
hs0809 <- left_join(hs0809, lep0809)

lep0910 <- subset(tables2008_2009$person_annual,
                  grade == 8)[, c('sasid','lep')]
names(lep0910)[2] <- 'lep8th'
hs0910 <- left_join(hs0910, lep0910)


# GPA in 8th grade calculations
gpa0607 <- tables2006_2007$course %.% 
           filter(grade==8) %.% 
           group_by(sasid) %.% 
           dplyr::summarise(gpa8th = mean(gpa, na.rm=TRUE))
gpa0607$sasid <- as.character(gpa0607$sasid)
hs0708 <- left_join(hs0708, gpa0607)

gpa0708 <- tables2007_2008$course %.% 
           filter(grade==8) %.% 
           group_by(sasid) %.% 
           dplyr::summarise(gpa8th = mean(gpa, na.rm=TRUE))
gpa0708$sasid <- as.character(gpa0708$sasid)
hs0809 <- left_join(hs0809, gpa0708)

gpa0809 <- tables2008_2009$course %.% 
           filter(grade==8) %.% 
           group_by(sasid) %.% 
           dplyr::summarise(gpa8th = mean(gpa, na.rm=TRUE))
gpa0809$sasid <- as.character(gpa0809$sasid)
hs0910 <- left_join(hs0910, gpa0809)

# Course Failures
fails0607 <- tables2006_2007$course %.% 
             filter(grade == 8) %.%
             group_by(sasid, courseno) %.% 
             dplyr::summarise(gpa = mean(gpa, na.rm=TRUE)) %.% 
             filter(gpa <= 1.0) %.% 
             dplyr::summarise(fails = n())

fails0708 <- tables2007_2008$course %.% 
             filter(grade == 8) %.%
             group_by(sasid, courseno) %.% 
             dplyr::summarise(gpa = mean(gpa, na.rm=TRUE)) %.% 
             filter(gpa <= 1.0) %.% 
             dplyr::summarise(fails = n())

fails0809 <- tables2008_2009$course %.% 
             filter(grade == 8) %.%
             group_by(sasid, courseno) %.% 
             dplyr::summarise(gpa = mean(gpa, na.rm=TRUE)) %.% 
             filter(gpa <= 1.0) %.% 
             dplyr::summarise(fails = n())

fails0607$sasid <- as.character(fails0607$sasid)
fails0708$sasid <- as.character(fails0708$sasid)
fails0809$sasid <- as.character(fails0809$sasid)

hs0708 <- left_join(hs0708, fails0607)
hs0708$fails <- with(hs0708, ifelse(is.na(fails) & !is.na(gpa8th), 0, fails))
hs0809 <- left_join(hs0809, fails0708)
hs0809$fails <- with(hs0809, ifelse(is.na(fails) & !is.na(gpa8th), 0, fails))
hs0910 <- left_join(hs0910, fails0809)
hs0910$fails <- with(hs0910, ifelse(is.na(fails) & !is.na(gpa8th), 0, fails))

hs0708 <- left_join(hs0708, findLongestMiddleSchool(all_years_enr))
hs0809 <- left_join(hs0809, findLongestMiddleSchool(all_years_enr))
hs0910 <- left_join(hs0910, findLongestMiddleSchool(all_years_enr))

hscohort <- rbind(hs0708, hs0809, hs0910)
hscohort <- subset(hscohort, !schno_first %in% charters)
hscohort <- subset(hscohort, !schno_ms_long %in% charters)
```
## Eighth Grade Model


### Defining the Sample
The goal of each model is to maximize the applicability of the model to maximize the number of future non-graduates as at-risk while minimizing model complexity and overall inaccuracy. The Eighth Grade Model (8GM) for predicting high school readiness uses data from students only collected in the eighth grade year. It is preferable to use only one year of data prior to entering high school to ensure the largest possible sample. Requiring additional years of data will lead to more students with an "incomplete" record containing all of the elements required to predict their probability of graduating. Defining the sample cohort for each model necessarily excludes some students because of incompleteness. 

Each cohort must have enough time to complete high school from eighth grade in order to model graduation probabilities. Our model does not specify graduation as needing to happen "on-time", or 4 years after first entering high school. However, in Providence, few students graduate in 5 or 6 years (reference TK). Therefore, we use three cohorts of students for the 8GM starting with students who enter high school in the 2007-2008 school year (expected graduation 2010-2011) through students who enter high school in the 2010-2011 school year (expected graduation 2012-2013). These are the three most recent cohorts of PPSD graduates [^cohort definition]. 

[^cohort definition]: We define the graduating class for each cohort based on the National Governor's Association for cohort-adjusted graduation rates. For example, students who enter PPSD for the first time in 9th grade in the 2007-2008 school year, 10th grade in the 2008-2009 school year, 11th grade in the 2009-2010 school year, and 12th grade in the 2010-2011 school year are all part of the high school 2007-2008 cohort.

In the three most recent cohorts, there were 7,506 students. However, many of these students are excluded from the 8GM. The first exclusion comes from students who did not attend 8th grade in a PPSD school. As a result, these students do not have data from 8th grade available to the district prior to entering high school. 

There are two ways to understand the coverage of the 8GM. First, we want to understand what proportion of all students will the model be based upon. There are three ways students are excluded from the model.

1. Does the 8th grade student attend high school in Providence?
2. Did the student attrite from the data set, e.g. transfer out of the district before recording their ultimate high school outcome?
3. Does the student have a complete set of 8th grade data required by the model?

The first two questions are easily answered prior to model selection, while the third will be specific to each model. In Table 1, we show the proportion of 8th grade students who attend Providence high schools and the proportion of 8th grade students who do not transfer out by cohort.



```{r ExampleTableSource}
cohort0708 <- subset(person, schoolyear_first=='2008_2009' & grade_first==9) %.%
              select(sasid) %.%
              left_join(subset(tables2008_2009$person_annual, 
                               grade==8, select=c('sasid', 'grade')))
prop.table(table(cohort0708$grade, useNA='ifany'))

cohort_gr8 <- subset(tables2008_2009$person_annual, 
                     grade==8, select = 'sasid') %.%
              left_join(subset(person, 
                              (schoolyear_first=='2009_2010' & grade_first==9) | 
                              (schoolyear_first=='2010_2011' & grade_first==10) | 
                              (schoolyear_first=='2011_2012' & grade_first==11) | 
                              (schoolyear_first=='2012_2013' & grade_first==12),
                              select = c('sasid', 'grade_first', 'transfer_out')))
prop.table(table(cohort_gr8$grade_first, useNA='ifany'))

```


| High School Cohort | High School Attendance        || Attrition           || Remaining ||
|                    |  In PPSD (%) | Out of PPSD (%) | Yes (%)     | No (%) |  (%) | (N) |
| :----------        | :-------:    | :-----------:   |  :-----:    | :--:   | :--: | :-: |
| 2007-2008          | 84.2      | 15.8            | 17.3    | 82.7   | 69.7   | 1499 |
| 2008-2009          | 86.6      | 13.4            | 16.7    | 83.3   | 72.1   | 1496 |
| 2009-2010          | 85.2      | 14.8            | 19.9    | 80.1   | 68.2   | 1245 | 

As demonstrated in Table 1, approximately 85% of all 8th grade PPSD students will attend at least some of high school in the district. Therefore, a large portion of these students will remain in the district to benefit from early identification of risk. 

The model for predicting graduation based on 8th grade data is built only with students who attend a Providence Public School as their final high school prior to graduating, dropping out, or transferring to a GED program (non-attrition). These students are excluded because we have no way of knowing whether or not these students ultimately graduate and their graduating is impacted substantially by non-Providence schools. Although they are excluded from the model, we can predict the likelihood that these students will graduate. Because students who are mobile tend to be disproportionately disadvantaged relative to their peers, it is likely that our model for these students is *positively biased*, i.e. these students will have higher probabilities of successfully graduating than is likely true because peers with similar observable characteristics have some unobserved advantages which resulted in being less mobile.

However, we can check to see whether or not students who transfer out are similar across observable characteristics such as race/ethnicity, course failures, grade point average, attendance, within-year school mobility, IEP status, and LEP status. If students who transfer out of PPSD appear similar across all of thes observable characteristics, then we can be less concerned about the positive bias of our estimates for students that transfer out.

```{r TransferCompare}
race <- with(hscohort, as.data.frame(prop.table(table(race, transfer_out), 2)))
race$transfer_out <- ifelse(race$transfer_out=='N', 
                        'Remains in PPSD', 
                        'Transfers Out of PPSD')
raceplot <- ggplot(data = race, aes(race, Freq)) + 
            geom_bar(stat='identity') + 
            geom_text(aes(label=percent(Freq)), vjust=-.4) +
            scale_y_continuous('', labels = percent_format(), limits=c(0, .7)) +
            scale_x_discrete('') +
            theme(axis.text.x = element_text(angle = 45, hjust=1)) +
            ggtitle('Race of Students by Attrition for\n Most Recent Three High School Cohorts') +
            facet_wrap(~transfer_out)

grades <- with(hscohort, as.data.frame(prop.table(table(cut(gpa8th, 
                                                            breaks=seq(0,4,.5)), 
                                                        transfer_out), 2)))
grades$transfer_out <- ifelse(grades$transfer_out=='N', 
                              'Remains in PPSD', 
                              'Transfers Out of PPSD')
names(grades)[1] <- 'GPA'

gpaplot <- ggplot(data = grades, aes(GPA, Freq)) + 
           geom_bar(stat='identity') + 
           geom_text(aes(label=percent(Freq)), vjust=-.4) +
           scale_y_continuous('', labels = percent_format(), limits=c(0, .25)) +
           scale_x_discrete('') +
           theme(axis.text.x = element_text(angle = 45, hjust=1)) +
           ggtitle('GPA of Students by Attrition for\n Most Recent Three High School Cohorts') +
           facet_wrap(~transfer_out)

mobility <- with(hscohort, as.data.frame(prop.table(table(moves, transfer_out), 
                                                    2)))
mobility$transfer_out <- ifelse(mobility$transfer_out=='N', 
                                'Remains in PPSD', 
                                'Transfers Out of PPSD')
mobilityplot <- ggplot(data = mobility, aes(moves, Freq)) + 
                geom_bar(stat='identity') + 
                geom_text(aes(label=percent(Freq)), vjust=-.4) +
                scale_y_continuous('', labels = percent_format(), limits=c(0, 1)) +
                scale_x_discrete('') +
                ggtitle('School Changes in 8th Grade of Students by Attrition for\n Most Recent Three High School Cohorts') +
                facet_wrap(~transfer_out)
```

```{r TransferCompareGraphics, results='asis'}
raceplot
gpaplot
mobilityplot
```

We see several interesting patterns when comparing students who transfer out of PPSD during high school and those who do not. These groups have essentially identical racial makeup, with students transfering out of the district being slightly more likely to be White or Asian ($ \chi^{2} = 30$, $ df = 25$, $ p-value = 0.2243$ suggesting the groups are indistinguishable) . The 8th grade course performance of students who transfer out of PPSD during high school is actually slightly better than those who remain in PPSD. By both of these measures, we find that those who transfer out are either no different or possibly even less disadvantaged than students that remain in PPSD, which is counter to what would have been expected. Mobility shows a slightly different picture, with students who leave PPSD having higher rates of within-school year school mobility, which is not surprising ($ \chi^{2} = 20$, $ df = 16$, $ p-value = 0.2202$ suggesting the groups are indistinguishable). [^allmodels] Based on these findings, we are not concerned about the biases present in providing predicted graduation rates for students even though those who transfer out are excluded from the data set when constructing our models.

[^allmodels]: It should be noted that while these patterns are only explored for the 8GM in this section, these same findings hold for all models.

```{r RunModel}
hscohort <- filter(hscohort, transfer_out=='N')
hscohort$schoolyear_first <- as.factor(hscohort$schoolyear_first)
# hscohort$graduated <- ifelse(hscohort$graduated == 'Y', 1, 
#                              ifelse(hscohort$graduated == 'N', 0, NA))
hscohort$graduated <- as.factor(hscohort$graduated)
hscohort <- na.omit(hscohort)
require(caret)
set.seed(101)
trainIndex <- createDataPartition(hscohort$graduated,
                                  p = .8, list=FALSE)
hscohort_train <- hscohort[trainIndex,]
hscohort_test <- hscohort[-trainIndex,]
set.seed(101)
model.1 <- train(graduated ~ I(attendance8th*10) + gpa8th + matnormal + 
                             reanormal + I(overage>168), 
                 data=hscohort_train,
                 method='glm',
                 tuneLength = 5,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary,
                                          seeds = NA),
                 metric='ROC')

# model.2 <- train(graduated~ attendnormal + gpa8th + I(ageHS>190) + 
#                             I(schno_first=='164') + + matnormal + reanormal, 
#                  data=hscohort_train,
#                  method='ctree',
#                  tuneLength = 5,
#                  trControl = trainControl(method = "repeatedcv", number = 10,
#                                           repeats = 10, classProbs=TRUE,
#                                           summaryFunction = twoClassSummary),
#                  metric='ROC')

```

### Modeling Methods
The 8GM is constructed using the `caret` package in `R`. This software tools enables us to partition the data set into training and test data, conduct repeated k-fold crossvalidation model fits using different techniques and parameters, and report the predictive properties of the resulting model estimates.

After testing out several specifications, it was found that standard logistic regression with graduation as the outcome and attendance, 8th grade GPA, whether or not a student is overaged when they enter 8th grade (likely reflecting they were retained in an earlier grade), and NECAP math and reading scaled scores as predictors provided the greatest overall predictive accuracy.

Below, we detail the key statistics from the regression represented by the blue line in the Receiver-operator characteristic (ROC) chart. We then report the parameter and their estimates for the `glm` model which was ultimately chosen for the 8GM.

```{r ModelResamples, results='markup'}
# summary(resamples(list(glm = model.1, ctree = model.2)))
```
```{r ROCData, results='asis', fig.width=7, fig.height=7}
load('/Users/jason/Downloads/bowersEWS.rda')
grade_8_comps <- subset(bowersEWS, grade==8)
roc_lm <- roc(hscohort_test$graduated, 
              predict(model.1, newdata=hscohort_test, type='prob')$Y, 
              auc=TRUE, ci=TRUE)

# roc_ctree <- roc(hscohort_test$graduated, 
#                  predict(model.2, newdata=hscohort_test, type='prob')$Y)

rocobj1 <- plot.roc(roc_lm, 
                    main="8GM ROC",
                    col="#1c61b6", 
                    print.auc=TRUE, 
                    legacy.axes=TRUE)
# rocobj2 <- lines.roc(roc_ctree, col="#008600")  
# testobj <- roc.test(rocobj1, rocobj2)  
# text(0.5, 0.1, labels=paste("p-value =", format.pval(testobj$p.value)), adj=c(0, .5))
points(x=grade_8_comps$specificity, 
       y=grade_8_comps$sensitivity, col='gray', pch = 20)
legend("bottomright", legend=c("8GM"), col=c("#1c61b6"), lwd=2)
```
```{r 8GMParam, results='asis'}
sjp.glm(model.1$finalModel, 
        title = 'Eighth Grade Model Odds Ratios',
        showModelSummary = FALSE,
        theme = 'bw',
        borderColor = 'white',
        axisLabels.y = c('Attendance * 10', '8th Grade GPA', 'NECAP Math',
                         'NECAP Reading', 'Overage Entering 8th Grade'))
```

### Classification Methods
Students with predicted probabilities that are different by only a few percent do not actually represent different levels of risk for not graduating. School leaders, guidance counselors, teachers, parents, and students are likely to misinterpret the direct probabilities produced by a logistic regression. When predicting "membership to a class", e.g. will this student graduate or not, does the patient have cancer or not, we can group similar probabilities into levels of risk that more clearly indicate whether or not immediate action is required.

The Rhode Island Department of Education has also been developing predictive models that seek to determine the probability that students will graduate. They have set three threshold levels for cutoffs based on the *true negative rate*. The true negative rate is the proportion of students that would be classified as not graduating in the model who ultimately fail to graduate over all non-graduates. It descrbies the percentage of students does the model correctly classify as not graduating. They have chosen three cutoffs that we will use here: 80% true negative rate for *high* risk, 70% true negative rate for *moderate* risk, and 60% true negative rate for *low* risk.

```{r, CutOffMatrix8GM}
hscohort_train$predict8th <- predict(model.1, 
                                     newdata = hscohort_train, 
                                     type = 'prob')$Y
m1_matrix <- cutoff_matrix(hscohort_train, 'predict8th', 'graduated')
thresholds <- data.frame(classification = as.factor(c('Watch', 
                                                      'Warning', 'Action')),
  threshold = c(m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .6)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .7)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .8)),]$cutoff))

# Compute coverage: what proportion of those who fail to graduate are identified
thresholds$coverage <- NA
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predict8th <= subset(thresholds, 
                                     classification=='Action')$threshold))
thresholds[thresholds$classification == 'Action', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predict8th <= subset(thresholds, 
                                     classification=='Warning')$threshold))
thresholds[thresholds$classification == 'Warning', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predict8th <= subset(thresholds, 
                                     classification=='Watch')$threshold))
thresholds[thresholds$classification == 'Watch', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
thresholds$coverage <- round(thresholds$coverage, digits=1)
```

For the 8GM, our thresholds can be seen in the table below.

```{r ThresholdTablePrint, results='asis'}
require(xtable)
print(xtable(thresholds), type="html", include.rownames=FALSE)
```

### Disaggregated Results

Although many demographic characteristics are not present in the model, this is not because all groups of students are served equally well. The following figures examine the classification of students by groupings such as race, free or reduced price lunch, special education status, and limited English proficiency. These data look at the incoming high school freshman in the fall of 2012 using the 8GM.

```{r NewestCohort8th}
hs1213 <- subset(person, schoolyear_first=='2013' & grade_first==9)
hs1112 <- subset(person, schoolyear_first=='2012' & grade_first==9)

hs1213$sasid <- as.character(hs1213$sasid)
hs1112$sasid <- as.character(hs1112$sasid)

hs1213 <- left_join(hs1213, attendance %.% filter(schoolyear == '2011_2012',
                                                  grade == 8)
                                       %.% select(sasid, attendance, 
                                                  tardy, suspended))
names(hs1213)[which(names(hs1213) %in% c('suspended'))] <- 'suspend8th'
names(hs1213)[which(names(hs1213) %in% c('tardy'))] <- 'tardy8th'
names(hs1213)[which(names(hs1213) %in% c('attendance'))] <- 'attendance8th'

hs1112 <- left_join(hs1112, attendance %.% filter(schoolyear == '2010_2011',
                                                  grade == 8)
                                       %.% select(sasid, attendance, 
                                                  tardy, suspended))
names(hs1112)[which(names(hs1112) %in% c('suspended'))] <- 'suspend8th'
names(hs1112)[which(names(hs1112) %in% c('tardy'))] <- 'tardy8th'
names(hs1112)[which(names(hs1112) %in% c('attendance'))] <- 'attendance8th'


hs1213 <- mutate(hs1213, overage = age_calc(dob, as.Date('2011-09-01'), 
                                          units='months'))
hs1112 <- mutate(hs1112, overage = age_calc(dob, as.Date('2012-09-01'), 
                                          units='months'))

mobile1213 <-  moves_calc(subset(tables2011_2012$enrollment, 
                                 sasid %in% hs1213$sasid & grade == 8),
                          gap = 30, enrollby = "2011-10-01")
mobile1112 <-  moves_calc(subset(tables2010_2011$enrollment, 
                                 sasid %in% hs1112$sasid & grade == 8),
                          gap = 30, enrollby = "2010-10-01")

mobile1213$sasid <- as.character(mobile1213$sasid)
mobile1112$sasid <- as.character(mobile1112$sasid)
hs1213 <- left_join(hs1213, mobile1213)
hs1112 <- left_join(hs1112, mobile1112)


tables2011_2012$achievement$sasid <- as.character(tables2011_2012$achievement$sasid)
tables2011_2012$achievement$studentid <- as.character(tables2011_2012$achievement$studentid)
tables2010_2011$achievement$sasid <- as.character(tables2010_2011$achievement$sasid)
tables2010_2011$achievement$studentid <- as.character(tables2010_2011$achievement$studentid)

hs1213 <- left_join(hs1213, tables2011_2012$achievement %.% 
                            filter(testgrade_N==8, testgrade_N==grade) %.%
                            select(sasid, grade, reaal, reascsc, matal, matscsc,
                                   testgrade_N, reanormal, matnormal))
hs1213 <- mutate(hs1213, attendnormal = (attendance8th - 
                                         mean(attendance8th, na.rm=TRUE)) / 
                                         sd(attendance8th, na.rm=TRUE))
hs1112 <- left_join(hs1112, tables2010_2011$achievement %.% 
                            filter(testgrade_N==8, testgrade_N==grade) %.%
                            select(sasid, grade, reaal, reascsc, matal, matscsc,
                                   testgrade_N, reanormal, matnormal))
hs1112 <- mutate(hs1112, attendnormal = (attendance8th - 
                                         mean(attendance8th, na.rm=TRUE)) / 
                                         sd(attendance8th, na.rm=TRUE))



gpa1112 <- tables2011_2012$course %.% 
           filter(grade==8) %.% 
           group_by(sasid) %.% 
           summarise(gpa8th = mean(gpa, na.rm=TRUE))
gpa1112$sasid <- as.character(gpa1112$sasid)
hs1213 <- left_join(hs1213, gpa1112)
gpa1011 <- tables2010_2011$course %.% 
           filter(grade==8) %.% 
           group_by(sasid) %.% 
           summarise(gpa8th = mean(gpa, na.rm=TRUE))
gpa1011$sasid <- as.character(gpa1011$sasid)
hs1112 <- left_join(hs1112, gpa1011)

# Longest attended middle school.
hs1112 <- left_join(hs1112, findLongestMiddleSchool(all_years_enr))
hs1213 <- left_join(hs1213, findLongestMiddleSchool(all_years_enr))

hs_new <- rbind(hs1213, hs1112)
hs_new <- na.omit(hs_new)
hs_new <- subset(hs_new, !schno_first %in% charters)
hs_new$prediction <- predict(model.1, newdata=hs_new, type='prob')$Y
hs_new$classification <- cut(hs_new$prediction, 
                             breaks=rev(c(1, thresholds$threshold, 0)), 
                             include.lowest=TRUE, 
                             labels=rev(c('On-track', 
                                        as.character(thresholds$classification))))
hs_new$classification <- factor(hs_new$classification, 
                                levels = rev(levels(hs_new$classification)), 
                                ordered=TRUE)
```
#### Race
```{r RacePic, results='asis'}
race <- as.data.frame(with(hs_new, prop.table(table(race, classification), 1)))
race_n <- as.data.frame(with(hs_new, table(race, classification)))
race_seq <- race %.%
            filter(classification == 'On-track') %.%
            arrange(Freq)
race$race <- factor(race$race,
                    levels = race_seq$race)
race <- filter(race, race != 'Pacific Islander') # n-size exclusion
race_n <- filter(race_n, race != 'Pacific Islander') # n-size exclusion
names(race_n)[ncol(race_n)] <- 'n'
race <- left_join(race, race_n)

ggplot(race, aes(race, Freq, fill = classification)) + 
geom_bar(stat = 'identity', position = 'stack') + 
geom_text(aes(label = n, y = Freq, ymax = 1), 
          position = 'stack',
          vjust = 1.66,
          fontface = 'bold',
          color = '#3f4c55') + 
scale_y_continuous('', labels = percent_format(), breaks=seq(0,1,.1)) +
scale_x_discrete('') +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
ggtitle('Incoming 9th Grade Classes of 2012 and 2013 Risk Levels')
```
The figure above shows the classification of incoming ninth graders in the fall of 2012 and 2013 disaggregated by race. A smaller proportion of Black and Hispanic students enter high school on-track, although the gap between these students and their White peers is less than 10 percentage points.

#### Suspension
```{r SuspendPic, results='asis', fig.height=7, fig.width=7}
suspension <- as.data.frame(with(hs_new, prop.table(table(suspend8th>0,classification),1)))
names(suspension)[1] <- 'suspension'
suspension$suspension <- as.factor(suspension$suspension)
levels(suspension$suspension) <- c('Has not been suspended', 
                                   'Suspended one or more days')

ggplot(suspension, aes(suspension, Freq, fill=classification)) + 
geom_bar(stat='identity', position='stack') + 
scale_y_continuous('', labels = percent_format(), breaks=seq(0,1,.1)) +
scale_x_discrete('') +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
ggtitle('Incoming 9th Grade Classes of 2012 and 2013 Risk Levels')
```
Whether or not a student is suspended even one time leads to substantial separation between on- and off-track students. Nearly 40% of students with one or more suspensions are in the highest risk category compared to around 7% of those who have never been suspended. However, there is a wide range in number of suspension incidents from 0 to 62.

```{r SuspendPic2, results='asis'}
suspend_labels <- c('None', as.character(seq(1,4,1)), '5 or more')
suspension <- as.data.frame(prop.table(table(cut(hs_new$suspend8th, 
                                                 breaks = c(seq(0, 5, 1), 1000),
                                                 include.lowest = TRUE, 
                                                 labels = suspend_labels,
                                                 right = FALSE), 
                                             hs_new$classification),
                                       1))
names(suspension) <- c('suspensions', 'classification', 'Freq')
ggplot(suspension, aes(suspensions, Freq, fill=classification)) + 
geom_bar(stat='identity', position='stack') + 
scale_y_continuous('', labels = percent_format(), breaks=seq(0,1,.1)) +
scale_x_discrete('Days') +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
ggtitle('Incoming 9th Grade Classes of 2012 and 2013 Risk Levels')
```
The relationship between number of days suspended and likelihood to graduate is clear-- the more times a student is suspended, the more likely it is that they fall into an at-risk classification.

#### Mobility
```{r MovesPic, results='asis', fig.height=7, fig.width=7}
moves <- as.data.frame(with(hs_new, prop.table(table(cut(moves, 
                                                         breaks = c(0,1,2,10),
                                                         include.lowest = TRUE,
                                                         labels = c('None',
                                                                    'One',
                                                                    'Two or more'),
                                                         right=FALSE),
                                                     classification),1)))
ggplot(moves, aes(Var1, Freq, fill=classification)) + 
geom_bar(stat='identity', position='stack') + 
scale_y_continuous('', labels = percent_format(), breaks=seq(0,1,.1)) +
scale_x_discrete('Number of school changes in 8th grade') +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
ggtitle('Incoming 9th Grade Classes of 2012 and 2013 Risk Levels')
```

#### Gender
```{r GenderPic, results='asis', fig.height=7, fig.width=7}
gender <- as.data.frame(with(hs_new, prop.table(table(sex,
                                                      classification),1)))
ggplot(gender, aes(sex, Freq, fill=classification)) + 
geom_bar(stat='identity', position='stack') + 
scale_y_continuous('', labels = percent_format(), breaks=seq(0,1,.1)) +
scale_x_discrete('Sex') +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
ggtitle('Incoming 9th Grade Classes of 2012 and 2013 Risk Levels')
```

#### Sorting by School
Students that are on-track are not evenly distributed among either sending middle schools or recieving high schools. When reviewing this data, it is critical to understand that this data does not suggest that some middle schools are better or worse at preparing students for high school. Because of differences in school composition and their own incoming classes from elementary to middle school, these data are not sufficient to make any claims about middle school efficacy. However, the stark differences in preparedness by middle school, and subsequently, receiving high schools, have important policy implications.

#### Sending Middle School
```{r MSSchoolLong, results='asis', fig.height=8.2, fig.width=10}
school_ms <- as.data.frame(with(hs_new, 
                                prop.table(table(schno_ms_long, 
                                                 classification), 1)))
school_ms <- na.omit(school_ms)
#school_ms <- filter(school_ms,
#                            !schno_first %in% c('185', '147'))
#school_lookup <- unique(hs_new[, c('schno_ms_long', 'school_ms_long')])
#school_lookup$schno_ms_long <- as.character(school_lookup$schno_ms_long)
#school_ms$schno_ms_long <- as.character(school_ms$school_ms_long)
school_lookup <- data.frame(schno_ms_long = as.character(c(143, 126, 145, 
                                                           137, 144, 147, 
                                                           172)), 
                            school_ms_long = c('Bishop', 'DelSesto', 'Greene', 
                                               'Hopkins', 'Stuart', 'Williams', 
                                               'Bridgham'))

school_ms <- left_join(school_ms, school_lookup)
school_ms_seq <- school_ms %.%
                 filter(classification == 'On-track') %.%
                 arrange(Freq)
school_ms$school_ms_long <- factor(school_ms$school_ms_long,
                                   levels = school_ms_seq$school_ms_long)
ggplot(na.omit(school_ms), aes(school_ms_long, Freq, fill=classification)) + 
geom_bar(stat='identity', position='stack') + 
scale_y_continuous('', 
                   labels = percent_format(), 
                   breaks = seq(0,1,.1),
                   limits = c(0, 1.05),
                   expand = c(0, 0)) +
scale_x_discrete('Middle school attended longest',
                 labels = substr(x=levels(school_ms$school_ms_long), 1, 13)) +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
theme(axis.text.x = element_text(angle=90)) +
ggtitle('Incoming 9th Grade Classes of 2012 and 2013 Risk Levels')


```

#### Receiving High School
```{r SchoolsPic, results='asis', fig.height=8.2, fig.width=10}
hs_new$schno_first <- with(hs_new, 
                           ifelse(as.character(schno_first) %in% c('181', '183'),
                                  '149', as.character(schno_first)))

school_first_data <- as.data.frame(with(hs_new, 
                                        prop.table(table(schno_first, 
                                                         classification), 1)))
school_first_data <- na.omit(school_first_data)
school_first_data <- filter(school_first_data,
                            !schno_first %in% c('185', '147', '114'))
# school_first_data$schno_first <- with(school_first_data, 
#                                       ifelse(as.character(schno_first) %in% 
#                                                c('181', '183'),
#                                              '149', as.character(schno_first)))
school_lookup <- 
  data.frame(schno_first = as.character(unique(school_first_data$schno_first)),
             school_first = c('Birch', 'Central', 'Hope', 
                              'Mount Pleasant', 'Classical', 'E-Cubed',
                              'Alvarez', 'Sanchez', 'Career & Tech'),
             stringsAsFactors=FALSE)
school_first_data$schno_first <- as.character(school_first_data$schno_first)
school_first_data <- left_join(school_first_data, school_lookup)
school_seq <- school_first_data %.%
              filter(classification == 'On-track') %.%
              arrange(Freq)
school_first_data$school_first <- factor(school_first_data$school_first,
                                         levels=school_seq$school_first)
ggplot(school_first_data, aes(school_first, Freq, fill=classification)) + 
geom_bar(stat='identity', position='stack') + 
scale_y_continuous('', 
                   labels = percent_format(), 
                   breaks = seq(0,1,.1),
                   limits = c(0, 1.05),
                   expand = c(0, 0)) +
scale_x_discrete('High school first attended',
                 labels = substr(x=levels(school_first_data$school_first), 1, 13)) +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
theme(axis.text.x = element_text(angle=90)) +
ggtitle('Incoming 9th Grade Classes of 2012 and 2013 Risk Levels')
```
### The Importance of Middle to High School Transitions
The Providence Personal Graduation Plan is used from grades 6 through 12. It is critical that we update our classification of risk periodically to ensure that resources are focused on the right students. The 8GM provides powerful insight into the readiness of students entering high school. By using data from before the start of 9th grade, we can work to ensure that students with the highest needs are provided with extra supports from the first day of high school, rather than wait for later indicators of falling behind.

Extensive research on the middle to high school transition suggests that after entering ninth grade, we may see a reshuffling of students at risk. Researchers at the Consortium on Chicago School Research have found that ninth grade performance data is so critical that most data available about students prior to high school is no longer useful in predicting high school success once this data is considered (http://ccsr.uchicago.edu/publications/what-matters-staying-track-and-graduating-chicago-public-schools).

With the 8GM we hope to inspire action to intervene with the highest need students immediately upon the start of high school (and perhaps the summer before entering high school). For this reason, and because of the research body pointing to the importance of transitioning to high school, we were motivated to see if we can re-classify students after just the first quarter of high school is complete. Building on the CCSR research, we chose to examine whether quarter 1 course performance can distinguish between students who are classified as having the same risk level based on the 8GM but ultimately have different graduation outcomes.

```{r Qtr19th}
gpa_qtr1_0708 <- tables2007_2008$course %.% 
                 filter(grade == 9 & 
                        sasid %in% 
                        subset(hscohort, 
                               schoolyear_first=='2007_2008' & 
                               grade_first==9)$sasid) %.% 
                 group_by(sasid, variable) %.% 
                 summarize(gpa_qtr1_9th = mean(gpa, na.rm=TRUE)) %.%
                 filter(variable == 'cum_qtr1') %.%
                 select(sasid, gpa_qtr1_9th)
gpa_qtr1_0809 <- tables2008_2009$course %.% 
                 filter(grade == 9 & sasid %in%
                        subset(hscohort, 
                               schoolyear_first=='2008_2009' & 
                               grade_first==9)$sasid) %.% 
                 group_by(sasid, variable) %.% 
                 summarize(gpa_qtr1_9th = mean(gpa, na.rm=TRUE)) %.%
                 filter(variable == 'cum_qtr1') %.%
                 select(sasid, gpa_qtr1_9th)
gpa_qtr1_0910 <- tables2009_2010$course %.% 
                 filter(grade == 9 & sasid %in% 
                        subset(hscohort, 
                               schoolyear_first=='2009_2010' & 
                               grade_first==9)$sasid) %.% 
                 group_by(sasid, variable) %.% 
                 summarize(gpa_qtr1_9th = mean(gpa, na.rm=TRUE)) %.%
                 filter(variable == 'cum_qtr1') %.%
                 select(sasid, gpa_qtr1_9th)

# First Quarter Course Failures
fails_qtr1_0708 <- tables2007_2008$course %.% 
                   filter(grade == 9 & sasid %in% 
                          subset(hscohort,
                                 schoolyear_first=='2007_2008' &
                                 grade_first == 9)$sasid) %.%
                   group_by(sasid, variable, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0 & variable == 'cum_qtr1') %.% 
                   summarize(fails_qtr1 = n())

fails_qtr1_0809 <- tables2008_2009$course %.% 
                   filter(grade == 9 & sasid %in% 
                          subset(hscohort,
                                 schoolyear_first=='2008_2009' &
                                 grade_first == 9)$sasid & 
                          !sasid %in% gpa_qtr1_0708$sasid) %.%
                   group_by(sasid, variable, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0 & variable == 'cum_qtr1') %.% 
                   summarize(fails_qtr1 = n())

fails_qtr1_0910 <- tables2009_2010$course %.% 
                   filter(grade == 9 & sasid %in% 
                          subset(hscohort,
                                 schoolyear_first=='2009_2010' &
                                 grade_first == 9)$sasid &
                          !sasid %in% gpa_qtr1_0809$sasid) %.%
                   group_by(sasid, variable, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0 & variable == 'cum_qtr1') %.% 
                   summarize(fails_qtr1 = n())

suspension <- read.csv('data/suspension.csv')
suspension$date_suspended <- as.Date(suspension$date_suspended, 
                                     format='%m/%d/%Y')
names(suspension)[1] <- 'studentid'
suspension$studentid <- as.character(suspension$studentid)
suspension0708 <- suspension %.%
                  filter(date_suspended > '2007-08-01' &
                         date_suspended < '2007-11-10')
suspension0708 <- suspension0708 %.%
                  filter(studentid %in% 
                          subset(hscohort,
                                 schoolyear_first=='2007_2008' &
                                 grade_first == 9)$studentid) %.%
                  group_by(studentid) %.%
                  summarize(suspended_qtr1 = sum(duration))
suspension0809 <- suspension %.%
                  filter(date_suspended > '2008-08-01' &
                         date_suspended < '2008-11-10')
suspension0809 <- suspension0809 %.%
                  filter(studentid %in% 
                          subset(hscohort,
                                 schoolyear_first=='2008_2009' &
                                 grade_first == 9)$studentid) %.%
                  group_by(studentid) %.%
                  summarize(suspended_qtr1 = sum(duration))
suspension0910 <- suspension %.%
                  filter(date_suspended > '2009-08-01' &
                         date_suspended < '2009-11-10')
suspension0910 <- suspension0910 %.%
                  filter(studentid %in% 
                          subset(hscohort,
                                 schoolyear_first=='2009_2010' &
                                 grade_first == 9)$studentid) %.%
                  group_by(studentid) %.%
                  summarize(suspended_qtr1 = sum(duration))
hscohort_train <- left_join(hscohort_train, 
                            rbind(suspension0708, 
                                  suspension0809, 
                                  suspension0910))
hscohort_train$suspended_qtr1 <- ifelse(is.na(hscohort_train$suspended_qtr1),
                                        0,
                                        hscohort_train$suspended_qtr1)

hscohort_train <- left_join(hscohort_train, 
                      rbind(gpa_qtr1_0708, gpa_qtr1_0809, gpa_qtr1_0910) %.%
                      select(sasid, gpa_qtr1_9th))

hscohort_train <- left_join(hscohort_train, 
                      rbind(fails_qtr1_0708, fails_qtr1_0809, 
                            fails_qtr1_0910) %.%
                      select(sasid, fails_qtr1))

hscohort_test <- left_join(hscohort_test, 
                            rbind(suspension0708, 
                                  suspension0809, 
                                  suspension0910))
hscohort_test$suspended_qtr1 <- ifelse(is.na(hscohort_test$suspended_qtr1),
                                        0,
                                        hscohort_test$suspended_qtr1)


hscohort_test <- left_join(hscohort_test, 
                      rbind(gpa_qtr1_0708, gpa_qtr1_0809, gpa_qtr1_0910) %.%
                      select(sasid, gpa_qtr1_9th))

hscohort_test <- left_join(hscohort_test, 
                      rbind(fails_qtr1_0708, fails_qtr1_0809, 
                            fails_qtr1_0910) %.%
                      select(sasid, fails_qtr1))

hscohort_train$classification <-
  cut(hscohort_train$predict8th, 
      breaks=rev(c(1, thresholds$threshold, 0)), include.lowest=TRUE, 
      labels=rev(c('On-track', as.character(thresholds$classification))))
hscohort_train$classification <- 
  factor(hscohort_train$classification, 
         levels = rev(levels(hscohort_train$classification)), 
         ordered=TRUE)
```

```{r Qtr1Fails, results='asis', fig.height=8.2, fig.width=10}
levels(hscohort_train$graduated) <- c('Did not graduate', 'Graduated')
box_quant <- function(x, ...){
  y <- median(x, na.rm=TRUE)
  minmax <- quantile(x, ..., na.rm=TRUE)
  result <- data.frame(y = y,
                       ymin = minmax[1],
                       ymax = minmax[2],
                       row.names = NULL)
  result
}
ggplot(data=hscohort_train, 
       aes(classification, gpa_qtr1_9th, color=graduated)) +
stat_summary(fun.data="box_quant", probs=c(0.25, 0.75), geom='pointrange', 
             position = position_dodge(width = 0.5), size=1.5) +
scale_x_discrete('Eighth Grade Model Classification') +
scale_y_continuous('Quarter 1 GPA, 9th Grade',
                   breaks = seq(0, 4, .5), 
                   limits = c(0,4)) +
scale_color_manual('',
                   values = c('Did not graduate' = '#CA0020', 
                              'Graduated' = '#0571B0')) +
ggtitle('First Quarter Performance in 9th Grade Impacts Graduation') +
theme(legend.position = c(0.9, 0.9),
      legend.background = element_rect(fill = "transparent"))
  
```
We find that students who are classified at the same level of readiness by the 8GM who ultimately graduate perform markedly better in their courses in the first quarter of 9th grade as compared to their peers who do not graduate. The figure above separates students by their 8GM classification along the x-axis and colors those students who do graduate blue and those who do not red. The point represents the median first quarter GPA for that group, with the lines extending to the 25th and 75th percentile. Notably, students who enter high school "On-track" and fail to graduate slightly outperform those students who are in "Warning" and "Action" that ultimately graduate. 

We believe this figure is a stark demonstration of the key role the middle to high school transition plays. Students who underperform *relative to their potential* in just the first 45 days of high school ultimately fail to graduate, while those who are succesful go on to complete high school.

Based on this exploratory analysis and the research of others, we developed a new predictive model that incorporates the elements of the 8GM and adds the first quarter 9th grade GPA. We found that we could exclude the results on the 8th grade NECAP for both reading and mathematics once we include 9th grade GPA and the result is still a better fit model. Similar to the findings in Chicago, we find that the number of course failures (with an interaction term between GPA and course failures) also improves the model, above and beyond just using quarter 1 GPA. Our new model, with both 9th grade quarter 1 GPA, the number of courses failed in quarter 1, and an interaction term between the two and excludes state test results from grade 8, will be known as QTR1.

```{r Qtr19thModel}
levels(hscohort_train$graduated) <- c('N', 'Y')
hscohort_train <- na.omit(hscohort_train)
set.seed(101)
# predictors <- c('attendance8th', 'gpa8th', 'suspend8th', 'moves', 'fails', 'sex', 'overage', 'matnormal', 'reanormal')
# model.orig <- train(hscohort_train[, predictors],
#                     hscohort_train$graduated,
#                  method='glmStepAIC',
#                  tuneLength = 5,
#                  trControl = trainControl(method = "repeatedcv", number = 10,
#                                           repeats = 10, classProbs=TRUE,
#                                           summaryFunction = twoClassSummary,
#                                           seeds = NA),
#                  metric='ROC')
# model.1 <- train(graduated ~ I(attendance8th*10) + gpa8th + matnormal + 
#                              reanormal + I(overage>178), 
#                  data=hscohort_train,
#                  method='glm',
#                  tuneLength = 5,
#                  trControl = trainControl(method = "repeatedcv", number = 10,
#                                           repeats = 10, classProbs=TRUE,
#                                           summaryFunction = twoClassSummary,
#                                           seeds = NA),
#                  metric='ROC')
# predictors <- c('attendance8th', 'gpa8th', 'suspend8th', 'moves', 'fails', 'fails_qtr1', 'gpa_qtr1_9th', 'suspended_qtr1', 'sex', 'overage', 'matnormal', 'reanormal')
# model.qtr1 <- train(hscohort_train[, predictors],
#                     hscohort_train$graduated, 
#                  method='glmStepAIC',
#                  tuneLength = 5,
#                  trControl = trainControl(method = "repeatedcv", number = 10,
#                                           repeats = 10, classProbs=TRUE,
#                                           summaryFunction = twoClassSummary,
#                                           seeds = NA),
#                  metric='ROC')
model.qtr1 <- train(graduated ~ I(attendance8th*10) + gpa8th + I(overage>168) +
                      gpa_qtr1_9th*fails, 
                 data=hscohort_train,
                 method='glm',
                 tuneLength = 5,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary,
                                          seeds = NA),
                 metric='ROC')
```

```{r ROCPlotsQtr1, results='asis', fig.width=7, fig.height=7}
hscohort_test <- na.omit(hscohort_test)
roc_orig <- roc(hscohort_test$graduated, 
              predict(model.1, newdata=hscohort_test, type='prob')$Y, 
              auc=TRUE, ci=TRUE)

roc_qtr1 <- roc(hscohort_test$graduated, 
                 predict(model.qtr1, newdata=hscohort_test, type='prob')$Y,
                auc=TRUE, ci=TRUE)

rocobj1 <- plot.roc(roc_qtr1, 
                    main="Comparing Original 8GM to Updated Quarter 1 Model",
                    col="#1c61b6",
                    print.auc=TRUE,
                    legacy.axes=TRUE)
rocobj2 <- lines.roc(roc_orig, col="#008600")  
testobj <- roc.test(rocobj1, rocobj2)
points(x=grade_8_comps$specificity, 
       y=grade_8_comps$sensitivity, col='gray', pch = 20)
text(0.5, 0.1, labels=paste("p-value =", format.pval(testobj$p.value)), adj=c(0, .5))  
legend("bottomright", legend=c("8GM + Qtr1", "8GM"), col=c("#1c61b6", "#008600"), lwd=2)
```
### UPDATE VALUES
Above is a comparison between the ROC for the 8GM (in green) and QTR1 (in blue) models. For the 8GM, $ AUC = 0.7769 (\pm0.0431)$ while for the improved QTR1 model $ AUC = 0.8032 (\pm0.0403$.
```{r ParamQtr1, results='asis'}
sjp.glm(model.qtr1$finalModel, 
        title = '9th Grade Quarter 1 Odds Ratios',
        theme = 'bw',
        showModelSummary = FALSE,
        borderColor = 'white',
        axisLabels.y = c('Attendance * 10', '8th Grade GPA', 
                         'Overage Entering High School', '9th Grade GPA Quarter 1',
                         'Course Failing Grades Quarter 1', 
                         'Interaction: GPA*Failing'),
        axisLabelSize = 0.7)
```
Students with a GPA one letter grade higher in the first quarter of 9th grade are 1.8 times more likely to graduate. Each course failure is associated with being 0.82 times as likely to graduate.

These findings confirm the exploratory analysis demonstrating the impact of quarter 1 course performance and closely follow the findings in Chicago that ninth grade course performance can supersede previously important covariates for predicting high school graduation.

```{r, CutOffMatrixQTR}
hscohort_train$predictqtr1 <- predict(model.qtr1, 
                                      newdata = hscohort_train, 
                                      type = 'prob')$Y
m1_matrix <- cutoff_matrix(hscohort_train, 'predictqtr1', 'graduated')
thresholds <- data.frame(classification = as.factor(c('Watch', 
                                                      'Warning', 'Action')),
  threshold = c(m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .6)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .7)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .8)),]$cutoff))

# Compute coverage: what proportion of those who fail to graduate are identified
thresholds$coverage <- NA
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predictqtr1 <= subset(thresholds, 
                                     classification=='Action')$threshold))
thresholds[thresholds$classification == 'Action', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predictqtr1 <= subset(thresholds, 
                                     classification=='Warning')$threshold))
thresholds[thresholds$classification == 'Warning', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predictqtr1 <= subset(thresholds, 
                                     classification=='Watch')$threshold))
thresholds[thresholds$classification == 'Watch', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
thresholds$coverage <- round(thresholds$coverage, digits=3)
```
We use the same method as with the 8GM to produce new thresholds for our classifications based on the QTR1 model, seen below.
```{r QTRThresholdTablePrint, results='asis'}
require(xtable)
print(xtable(thresholds), type="html", include.rownames=FALSE)
```
One way to see the vast improvement that 9th grade quarter 1 course performance data provides is by examining the coverage in each classification. Whereas the 8GM identified approximately 36% of all non-graduates in the "Action" category, 54.9% are captured in QTR1. Students who are at "Warning" or "Action" together represent 76.8% of all non-graduates, and 91.2% of all non-graduates are labeled as off-track by the QTR1.

Based on these thresholds, we can classify the most recent two freshman classes just as we did when analyzing the 8GM. We would like to see what proportion of students change classification after quarter 1 in 9th grade. Those students who move to less severe risk levels have already demonstrated they are getting back on track. We also expect to see some students move to more severe risk categories, demonstrating that their transition to high school was less successful and they are falling further behind.

```{r Qtr1Classification}
# Classify Training
hscohort_train$classificationqtr1 <- 
  cut(hscohort_train$predictqtr1, breaks=rev(c(1, thresholds$threshold, 0)), 
      include.lowest=TRUE, 
      labels=rev(c('On-track', as.character(thresholds$classification))))
hscohort_train$classificationqtr1 <-
  factor(hscohort_train$classificationqtr1, 
         levels = rev(levels(hscohort_train$classificationqtr1)), ordered=TRUE)

gpa_qtr1_1213 <- tables2012_2013$course %.% 
                 filter(grade == 9 & 
                        sasid %in% 
                        subset(hs_new, 
                               schoolyear_first=='2013' & 
                               grade_first==9)$sasid) %.%
                 group_by(sasid, variable) %.% 
                 summarize(gpa_qtr1_9th = mean(gpa, na.rm=TRUE)) %.%
                 filter(variable == 'cum_qtr1') %.%
                 select(sasid, gpa_qtr1_9th)
gpa_qtr1_1112 <- tables2011_2012$course %.% 
                 filter(grade == 9 & 
                        sasid %in% 
                        subset(hs_new, 
                               schoolyear_first=='2012' & 
                               grade_first==9)$sasid) %.% 
                 group_by(sasid, variable) %.% 
                 summarize(gpa_qtr1_9th = mean(gpa, na.rm=TRUE)) %.%
                 filter(variable == 'cum_qtr1') %.%
                 select(sasid, gpa_qtr1_9th)
fails_qtr1_1213 <- tables2012_2013$course %.% 
                   filter(grade == 9 & sasid %in% 
                          subset(hs_new,
                                 schoolyear_first=='2013' &
                                 grade_first == 9)$sasid &
                          !sasid %in% gpa_qtr1_1112$sasid) %.%
                   group_by(sasid, variable, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0 & variable == 'cum_qtr1') %.% 
                   summarize(fails = n())
fails_qtr1_1112 <- tables2011_2012$course %.% 
                   filter(grade == 9 & sasid %in% 
                          subset(hs_new,
                                 schoolyear_first=='2012' &
                                 grade_first == 9)$sasid) %.%
                   group_by(sasid, variable, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0 & variable == 'cum_qtr1') %.% 
                   summarize(fails = n())
gpa_qtr1_new <- rbind(gpa_qtr1_1112, gpa_qtr1_1213)
gpa_qtr1_new$sasid <- as.character(gpa_qtr1_new$sasid)
hs_new <- left_join(hs_new, 
                    gpa_qtr1_new %.%
                    select(sasid, gpa_qtr1_9th))
fails_qtr1_new <- rbind(fails_qtr1_1112, fails_qtr1_1213)
fails_qtr1_new$sasid <- as.character(fails_qtr1_new$sasid)
hs_new <- left_join(hs_new, 
                    fails_qtr1_new %.%
                    select(sasid, fails))
hs_new <- na.omit(hs_new)
hs_new$predictqtr1 <- predict(model.qtr1, newdata=hs_new, type='prob')$Y
hs_new$classificationqtr1 <- cut(hs_new$predictqtr1, 
                             breaks=rev(c(1, thresholds$threshold, 0)), 
                             include.lowest=TRUE, 
                             labels=rev(c('On-track', 
                                        as.character(thresholds$classification))))
hs_new$classificationqtr1 <- factor(hs_new$classificationqtr1, 
                                levels = rev(levels(hs_new$classificationqtr1)), 
                                ordered=TRUE)
```

```{r Qtr1ChangeClass}
heatmap <- as.data.frame(with(hs_new, 
                              table(classification, classificationqtr1)))
ggplot(data = heatmap, aes(classification, classificationqtr1, fill=Freq)) +
geom_tile() +
scale_fill_gradient(low="#EFF3FF", high="#08519C") +
geom_text(aes(fill = heatmap$Freq, label = heatmap$Freq)) +
scale_x_discrete('Classification based on 8GM') + 
scale_y_discrete('Classification based on QTR1') +
ggtitle('Classification Changes Due to Updated 9th Grade Quarter 1 Data')
```

Unsurprisingly, the most common positions on this table are along the diagnol, which signals that students did not change classifications between the 8GM and QTR1. We also can see that these groupings are more resilient at the extremes-- students who were "On-track" remain "On-track" and students in the "Action" classification remain there as well. Both the "Warning" and "Watch" students were more likely to be reclassified once entering high school. Encouragingly, students in both the "Watch" and "Warning" groups were slightly more likely to improve their classification than fall further behind.

#### Summary of Findings from 8GM and QTR1
The previous two models focused on data available throughout 8th grade and immediately after students entered high school. The results of these analysis revealed that data from 8th grade can identify student risk of failing to graduate, that students in need of additional supports are disproportionately mobile, involved in disciplinary infractions, and students of color. We also found that there is a wide range in the proportion of students classified as "On-track" to graduate in each middle school and that high schools receive students with different levels of readiness. 

By using additional course performance data available after just 45 days in high school, we are able to improve our predictive analysis and more accurately classified students who are falling behind. The increase in predictive power with just one additional element from the early high school experience supports the important role of transitioning successfully from middle school to high school.

These findings support many of the policy and programmatic interventions that PPSD is already pursuing. Student interventions to support graduation can begin much earlier using the predictive analysis from 8th grade to provide supports before students find themselves unable to meet the graduation requirements in later grades. Attendance and course performance are the key elements that predict graduation. While this relationship is not necessarily causal, sustained improvement in both areas will likely lead to greater student success in high school. While student disciplinary infractions was not included in the predictive models, they are strongly related to the risk levels calculated by the model. This suggests there are deep-linkages between student course performance, attendance, and number of days suspended ass supported in the literature.

## Ninth Grade Model
### Defining the Sample
The QTR1 model for 9th grade students utilizes student data collected in PPSD from the 8th grade and is only applicable to students who attended both 8th and 9th grade within the district. The Ninth Grade Model (9GM) is constructed using only data from the ninth grade in order to maxmizie the applicability of the model to the broadest set of students. This model is built on data from first-time ninth grade students in PPSD. 

Each cohort must have enough time to complete high school from eighth grade in order to model graduation probabilities. Our model does not specify graduation as needing to happen "on-time", or 4 years after first entering high school. We use the three most recent cohorts with completed data, the freshman classes of 2007-2008, 2008-2009, and 2009-2010 to develep the 9GM.

We want to examine the difference between students who remain in the district and those who transfer out of the district just like with the 8GM. For the ninth grade model, we're particularly interested in difference between on-time promotion to 10th grade, one of the key early indicators of high school graduation.

```{r NineModelCohorts}
hs0708 <- subset(person, (schoolyear_first=='2007_2008' & grade_first==9) | 
                         (schoolyear_first=='2008_2009' & grade_first==10) | 
                         (schoolyear_first=='2009_2010' & grade_first==11) | 
                         (schoolyear_first=='2010_2011' & grade_first==12))
hs0708$retained <- ifelse(hs0708$sasid %in% 
                          filter(hs0708, 
                                 grade_first == 9 & 
                                 sasid %in% filter(tables2008_2009$person_annual, 
                                                   grade == 9)$sasid)$sasid,
                          'Y', 'N')

  
hs0809 <- subset(person, (schoolyear_first=='2008_2009' & grade_first==9) | 
                         (schoolyear_first=='2009_2010' & grade_first==10) | 
                         (schoolyear_first=='2010_2011' & grade_first==11) | 
                         (schoolyear_first=='2011_2012' & grade_first==12))

hs0809$retained <- ifelse(hs0809$sasid %in% 
                          filter(hs0809, 
                                 grade_first == 9 & 
                                 sasid %in% filter(tables2009_2010$person_annual, 
                                                   grade == 9)$sasid)$sasid,
                          'Y', 'N')
hs0910 <- subset(person, (schoolyear_first=='2009_2010' & grade_first==9) | 
                         (schoolyear_first=='2010_2011' & grade_first==10) | 
                         (schoolyear_first=='2011_2012' & grade_first==11) | 
                         (schoolyear_first=='2012_2013' & grade_first==12))
hs0910$retained <- ifelse(hs0910$sasid %in% 
                          filter(hs0910, 
                                 grade_first == 9 & 
                                 sasid %in% filter(tables2010_2011$person_annual, 
                                                   grade == 9)$sasid)$sasid,
                          'Y', 'N')

hs0708$sasid <- as.character(hs0708$sasid)
hs0809$sasid <- as.character(hs0809$sasid)
hs0910$sasid <- as.character(hs0910$sasid)

# Attendance is same as previous code for cohorts except that I use the school
# year that is the same as the grade_first value so that it represents 9th grade
# attendance not 8th grade.

hs0708 <- left_join(hs0708, attendance %.% filter(schoolyear == '2007_2008')
                                       %.% select(sasid, attendance, tardy, 
                                                  suspended))
hs0809 <- left_join(hs0809, attendance %.% filter(schoolyear == '2008_2009')
                                       %.% select(sasid, attendance, tardy, 
                                                  suspended))
hs0910 <- left_join(hs0910, attendance %.% filter(schoolyear == '2009_2010')
                                       %.% select(sasid, attendance, tardy, 
                                                  suspended))
hs0708 <- mutate(hs0708, ageHS = age_calc(dob, as.Date('2007-09-01'), 
                                          units='months'))
hs0809 <- mutate(hs0809, ageHS = age_calc(dob, as.Date('2008-09-01'), 
                                          units='months'))
hs0910 <- mutate(hs0910, ageHS = age_calc(dob, as.Date('2009-09-01'), 
                                          units='months'))
gpa_9th_0708 <- tables2007_2008$course %.% 
                 filter(grade == 9 & 
                        sasid %in% 
                        subset(hs0708, 
                               schoolyear_first=='2007_2008' & 
                               grade_first==9)$sasid) %.% 
                 group_by(sasid) %.% 
                 summarize(gpa9th = mean(gpa, na.rm=TRUE)) %.%
                 select(sasid, gpa9th)

# Credits Transformations
credits_0708 <- tables2007_2008$course %.%
                filter(grade == 9 &
                       sasid %in%
                       subset(hs0708,
                              schoolyear_first=='2007_2008' &
                              grade_first==9)$sasid) %.%
                select(sasid, courseno, type, credits)
credits_0708 <- credits_0708[!duplicated(credits_0708), ]
credits_0708 <- ungroup(credits_0708) %.%
                group_by(sasid, type) %.%
                summarize(credits = sum(as.numeric(credits), na.rm = TRUE)) %.%
                select(sasid, type, credits)
credits_0708$type <- ifelse(credits_0708$type == "", 'none_cred',
                            paste(tolower(credits_0708$type), 'cred', sep = '_'))
credits_0708 <- dcast(sasid ~ type, value.var='credits', sum, data=credits_0708)
credits_0708$total_cred <- apply(credits_0708[, -1], 1, sum)
gpa_9th_0809 <- tables2008_2009$course %.% 
                 filter(grade == 9 & sasid %in%
                        subset(hs0809, 
                               schoolyear_first=='2008_2009' & 
                               grade_first==9)$sasid) %.% 
                 group_by(sasid) %.% 
                 summarize(gpa9th = mean(gpa, na.rm=TRUE)) %.%
                 select(sasid, gpa9th)
credits_0809 <- tables2008_2009$course %.%
                filter(grade == 9 &
                       sasid %in%
                       subset(hs0809,
                              schoolyear_first=='2008_2009' &
                              grade_first==9)$sasid) %.%
                select(sasid, courseno, type, credits)
credits_0809 <- credits_0809[!duplicated(credits_0809), ]
credits_0809 <- ungroup(credits_0809) %.%
                group_by(sasid, type) %.%
                summarize(credits = sum(as.numeric(credits), na.rm = TRUE)) %.%
                select(sasid, type, credits)
credits_0809$type <- ifelse(credits_0809$type == "", 'none_cred',
                            paste(tolower(credits_0809$type), 'cred', sep = '_'))
credits_0809 <- dcast(sasid ~ type, value.var='credits', sum, data=credits_0809)
credits_0809$total_cred <- apply(credits_0809[, -1], 1, sum)

gpa_9th_0910 <- tables2009_2010$course %.% 
                 filter(grade == 9 & sasid %in% 
                        subset(hs0910, 
                               schoolyear_first=='2009_2010' & 
                               grade_first==9)$sasid) %.% 
                 group_by(sasid) %.% 
                 summarize(gpa9th = mean(gpa, na.rm=TRUE)) %.%
                 select(sasid, gpa9th)
credits_0910 <- tables2009_2010$course %.%
                filter(grade == 9 &
                       sasid %in%
                       subset(hs0910,
                              schoolyear_first=='2009_2010' &
                              grade_first==9)$sasid) %.%
                select(sasid, courseno, type, credits)
credits_0910 <- credits_0910[!duplicated(credits_0910), ]
credits_0910 <- ungroup(credits_0910) %.%
                group_by(sasid, type) %.%
                summarize(credits = sum(as.numeric(credits), na.rm = TRUE)) %.%
                select(sasid, type, credits)
credits_0910$type <- ifelse(credits_0910$type == "", 'none_cred',
                            paste(tolower(credits_0910$type), 'cred', sep = '_'))
credits_0910 <- dcast(sasid ~ type, value.var='credits', sum, data=credits_0910)
credits_0910$total_cred <- apply(credits_0910[, -1], 1, sum)

# First Quarter Course Failures
fails_9th_0708 <- tables2007_2008$course %.% 
                   filter(grade == 9 & sasid %in% 
                          subset(hs0708,
                                 schoolyear_first=='2007_2008' &
                                 grade_first == 9)$sasid) %.%
                   group_by(sasid, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0) %.% 
                   summarize(fails9th = n())
                   

fails_9th_0809 <- tables2008_2009$course %.% 
                   filter(grade == 9 & sasid %in% 
                          subset(hs0809,
                                 schoolyear_first=='2008_2009' &
                                 grade_first == 9)$sasid & 
                          !sasid %in% gpa_9th_0708$sasid) %.%
                   group_by(sasid, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0) %.% 
                   summarize(fails9th = n())
                   
fails_9th_0910 <- tables2009_2010$course %.% 
                   filter(grade == 9 & sasid %in% 
                          subset(hs0910,
                                 schoolyear_first=='2009_2010' &
                                 grade_first == 9)$sasid &
                          !sasid %in% gpa_9th_0809$sasid) %.%
                   group_by(sasid, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0) %.% 
                   summarize(fails9th = n())


hs0708 <- left_join(hs0708, gpa_9th_0708)
hs0708 <- left_join(hs0708, fails_9th_0708)
hs0708 <- left_join(hs0708, credits_0708)
hs0809 <- left_join(hs0809, gpa_9th_0809)
hs0809 <- left_join(hs0809, fails_9th_0809)
hs0809 <- left_join(hs0809, credits_0809)
hs0910 <- left_join(hs0910, gpa_9th_0910)
hs0910 <- left_join(hs0910, fails_9th_0910)
hs0910 <- left_join(hs0910, credits_0910)

# Mobility for ninth grade
mobile0708 <-  moves_calc(subset(tables2007_2008$enrollment, 
                                sasid %in% hs0708$sasid & grade == 9),
                          gap = 30, enrollby = "2007-10-01")

mobile0708$sasid <- as.character(mobile0708$sasid)
hs0708 <- left_join(hs0708, mobile0708)
mobile0809 <-  moves_calc(subset(tables2008_2009$enrollment, 
                                sasid %in% hs0809$sasid & grade == 9),
                          gap = 30, enrollby = "2008-10-01")
mobile0809$sasid <- as.character(mobile0809$sasid)
hs0809 <- left_join(hs0809, mobile0809)

mobile0910 <-  moves_calc(subset(tables2009_2010$enrollment, 
                                sasid %in% hs0910$sasid & grade == 9),
                          gap = 30, enrollby = "2008-10-01")
mobile0910$sasid <- as.character(mobile0910$sasid)
hs0910 <- left_join(hs0910, mobile0910)

hscohort <- rbind(hs0708, hs0809, hs0910)
hscohort$fails9th <- ifelse(is.na(hscohort$fails9th) & !is.na(hscohort$gpa9th),
                            0, hscohort$fails9th)
hscohort <- mutate(hscohort,
                   core_cred = math_cred + eng_cred + sci_cred + soc_cred)

hscohort <- subset(hscohort, !schno_first %in% charters)
hscohort <- subset(hscohort, !schno_first %in% c('185', '147', '114',
                                                 '117', '189'))
hscohort <- subset(hscohort, !schno_first %in% c('131')) # Birch Vocational
# Combine Hopes
hscohort$schno_first <- with(hscohort, 
                             ifelse(as.character(schno_first) %in% 
                                     c('171', '182', '181', '183'),
                                    '149', as.character(schno_first)))

# Combine PAIS with HSTA & PAIS
hscohort$schno_first <- with(hscohort, 
                             ifelse(as.character(schno_first) %in% 
                                     c('173', '174'),
                                    '175', as.character(schno_first)))

# hscohort <- subset(hscohort, schno_first %in% c(139, 149, 150, 
#                                                 164, 167, 169, 
#                                                 175, 188, 193))

```

```{r TransferCompare9th}
race <- with(hscohort, as.data.frame(prop.table(table(race, transfer_out), 2)))
race$transfer_out <- ifelse(race$transfer_out=='N', 
                        'Remains in PPSD', 
                        'Transfers Out of PPSD')
raceplot <- ggplot(data = race, aes(race, Freq)) + 
            geom_bar(stat='identity') + 
            geom_text(aes(label=percent(Freq)), vjust=-.4) +
            scale_y_continuous('', labels = percent_format(), limits=c(0, .7)) +
            scale_x_discrete('') +
            theme(axis.text.x = element_text(angle = 45, hjust=1)) +
            ggtitle('Race of Students by Attrition for\n Most Recent Three High School Cohorts') +
            facet_wrap(~transfer_out)

grades <- with(hscohort, as.data.frame(prop.table(table(cut(gpa9th, 
                                                            breaks=seq(0,4,.5)), 
                                                        transfer_out), 2)))
grades$transfer_out <- ifelse(grades$transfer_out=='N', 
                              'Remains in PPSD', 
                              'Transfers Out of PPSD')
names(grades)[1] <- 'GPA'

gpaplot <- ggplot(data = grades, aes(GPA, Freq)) + 
           geom_bar(stat='identity') + 
           geom_text(aes(label=percent(Freq)), vjust=-.4) +
           scale_y_continuous('', labels = percent_format(), limits=c(0, .25)) +
           scale_x_discrete('') +
           theme(axis.text.x = element_text(angle = 45, hjust=1)) +
           ggtitle('GPA of Students by Attrition for\n Most Recent Three High School Cohorts') +
           facet_wrap(~transfer_out)

mobility <- with(hscohort, as.data.frame(prop.table(table(moves, transfer_out), 
                                                    2)))
mobility$transfer_out <- ifelse(mobility$transfer_out=='N', 
                                'Remains in PPSD', 
                                'Transfers Out of PPSD')
mobilityplot <- ggplot(data = mobility, aes(moves, Freq)) + 
                geom_bar(stat='identity') + 
                geom_text(aes(label=percent(Freq)), vjust = -.4) +
                scale_y_continuous('', labels = percent_format(), limits=c(0, 1)) +
                scale_x_discrete('') +
                ggtitle('School Changes in 8th Grade of Students by Attrition for\n Most Recent Three High School Cohorts') +
                facet_wrap(~transfer_out)

retained9th <- with(hscohort, 
                    as.data.frame(prop.table(table(retained, transfer_out), 2)))
retained9th$transfer_out <- ifelse(retained9th$transfer_out=='N',
                                   'Remains in PPSD',
                                   'Transfers Out of PPSD')
retained9thplot <- ggplot(data = retained9th, aes(retained, Freq)) +
                   geom_bar(stat='identity') +
                   geom_text(aes(label=percent(Freq)), vjust = -.4) +
                   scale_y_continuous('', 
                                      labels = percent_format(), 
                                      limits = c(0, 1)) +
                   scale_x_discrete('') +
                   ggtitle('First-time 9th Grade Retention by Attrition for\n Most Recent Three High School Cohorts') +
                   facet_wrap(~transfer_out)
```

```{r TransferCompareGraphics9th, results='asis'}
raceplot
gpaplot
mobilityplot
retained9thplot
```
When reviewing the potential for bias with the 8GM, it was found that there was little pattern to suggest that students who transferred out of PPSD were racially different or performed more poorly in courses. The primary difference between students who transferred out of PPSD some time during high school was they were more likely to have changed schools during 8th grade.

Using ninth grade data, we find that in addition to differences in prior school mobility, students who transfer out of PPSD during high school appear to perform worse in their courses than those that remain. Unsurprisingly, students who transfer out are retained in 9th grade at a higher rate (26.7% versus 22.2%). Our model is likely to be *positively biased* for students who transfer out of PPSD, i.e. these students will have higher probabilities of successfully graduating than is likely true because peers with similar observable characteristics have some unobserved advantages which resulted in being less mobile.

### Modeling Methods
We tested multiple factors to predict graduation selected by following the extensive research on 9th grade success at the Consortium on Chicago School Research. Their findings suggested attendance, course failures, and course performance were the primary predictors of 9th grade readiness.

Additionally, the Longitudinal Data Analysis group in Rhode Island has identified some indicators of 9th grade success as well. Their work focused on promotion to 10th grade as an indicator of 9th grade readiness. Nationwide, only 15% of students who are not promoted to 10th grade graduate. These results numbers are similarly reflected in the PPSD data, with 15.7% of those retained graduating.

```{r RetentionGraduatePic, results='asis'}
hscohort$graduated <- as.factor(hscohort$graduated)
levels(hscohort$graduated) <- c('Did not graduate', 'Graduated')
hscohort$graduated <- factor(hscohort$graduated, 
                             levels = rev(levels(hscohort$graduated)),
                             ordered = TRUE)
ggplot(data=as.data.frame(with(hscohort, 
                               prop.table(table(retained, graduated),1))), 
       aes(retained, Freq, fill=graduated)) + 
geom_bar(stat='identity', position='stack') +
scale_fill_manual('',
                  values = c('Graduated' = '#0571B0', 
                             'Did not graduate' = '#CA0020')) +
scale_y_continuous('', labels = percent_format()) +
scale_x_discrete('', labels = c('Promoted', 'Retained')) +
ggtitle('Promotion to 10th Grade and Graduation')
```

The LDA found that student attendance, suspensions, and 8th grade NECAP results were all related to promotion to 10th grade. Because we found in the earlier models that NECAP results lose their significance when including course performance data, we substitute 9th grade GPA and course failures for NECAP results. There are several practical reasons for this exclusion as well. First, incoming high school freshman were last assessed in the fall of grade 8 on material taught during their 7th grade year. Second, requiring information about eighth grade in the 9GM would require omitting more students from the model, potentially biasing its predictions.

```{r 9GMTrain}
hscohort <- filter(hscohort, transfer_out=='N')
hscohort$schoolyear_first <- as.factor(hscohort$schoolyear_first)
# hscohort$graduated <- ifelse(hscohort$graduated == 'Y', 1, 
#                              ifelse(hscohort$graduated == 'N', 0, NA))
hscohort$graduated <- factor(hscohort$graduated, 
                             levels=rev(levels(hscohort$graduated)))
levels(hscohort$graduated) <- c('N', 'Y')
hscohort <- na.omit(hscohort)
set.seed(101)
trainIndex <- createDataPartition(hscohort$graduated,
                                  p = .8, list=FALSE)
hscohort_train <- hscohort[trainIndex,]
hscohort_test <- hscohort[-trainIndex,]
set.seed(101)
predictors <- c('attendance', 'gpa9th', 'ageHS', 'fails9th', 'moves', 
                'suspended', 'retained', 'total_cred', 'core_cred', 'math_cred',
                'sci_cred', 'eng_cred', 'soc_cred')

myControl <-  trainControl(method = "repeatedcv", 
                           number = 10,
                           repeats = 5, 
                           classProbs = TRUE,
                           summaryFunction = twoClassSummary,
                           seeds = NA)

model.9GMt <- train(graduated ~ I(attendance*10) + gpa9th +  
                                I(ageHS>180) + moves + suspended + 
                                core_cred + sci_cred,
                   data = hscohort_train,
                   method='glm',
                   tuneLength = 5,
                   trControl = myControl,
                   metric='ROC')

model.9GMr <- train(graduated ~ I(attendance*10) + gpa9th +  
                                I(ageHS>180) + moves + suspended + 
                                core_cred + sci_cred + retained,
                    data = hscohort_train,
                    method='glm',
                    tuneLength = 5,
                    trControl = myControl,
                    metric='ROC')
```
We built two versions of the 9GM -- one with information about whether or not a student is retained at the end of the year and one without. However, we can only know when a student is retained in 9th grade at the end of the year. As a result, this model could not be easily applied to students throughout the year to monitor risk. Because PPSD would like to update the models with projected on-track status during the year, we tested a model including only information available during the year.

A comparison between the two model specifications are below.

| Predictor | 9th Grade Throughout Year | 9th Grade End of Year |
| :------   | :----------------------:  | :------------------:  |
| Average Course Performance | X | X |
| School Changes             | X | X |
| Attendance Rate * 10            | X | X |
| Days Suspended             | X | X |
| Overage when entering High School | X | X |
| Retained at the end of 9th grade |  | X |
| Model AIC                        | 2370.2 | 2340.7 |
| Model ROC AUC                    | 0.835  | 0.841  |

These two models are quite similar, and although the model including 9th grade retention is a better predictive model (ANOVA likelihood ratio test $ p< 0.0001$), we believe that the improvement is slight enough that using the "throughout-the-year" model (9GM-TOY) to track risk at the end of the second and third quarter is defensible (AUC test $ p=0.297$). 

```{r ROC9GM, results='asis', fig.width=7, fig.height=7}
hscohort_test <- na.omit(hscohort_test)
load('/Users/jason/Downloads/bowersEWS.rda')
grade_9_comps <- subset(bowersEWS, grade==9)
roc_toy <- roc(hscohort_test$graduated, 
                predict(model.9GMt, newdata=hscohort_test, type='prob')$Y, 
                auc=TRUE, ci=TRUE)
roc_reta <- roc(hscohort_test$graduated, 
                predict(model.9GMr, newdata=hscohort_test, type='prob')$Y,
                auc=TRUE, ci=TRUE)

rocobj1 <- plot.roc(roc_reta, 
                    main="Comparing 9GM Specifications",
                    col="#1c61b6",
                    print.auc=TRUE,
                    legacy.axes=TRUE)
rocobj2 <- lines.roc(roc_toy, col="#008600")    
points(x=grade_9_comps$specificity, 
       y=grade_9_comps$sensitivity, col='gray', pch = 20)
testobj <- roc.test(rocobj1, rocobj2)  
text(0.5, 0.1, labels=paste("p-value =", format.pval(testobj$p.value)), adj=c(0, .5))  
legend("bottomright", legend=c("Retention", "No Retention"), 
       col=c("#1c61b6", "#008600"), lwd=2)


```

There are several assumptions that must be made to use the model during the year. The model predictions assume that the data will not change, i.e. data aggregated by averaging will remain about the same and data aggregated by sums will grow at the same rate. For example, Students at the end of the second quarter will be assumed to have the same attendance rate and GPA for the entire year that they had for the first half of the year, while having double as many failing course grades and double the number of days suspended. However, our models always assume that "nothing changes", and the goal of reporing all of the on-track data is to induce changes that lead to improved graduation probabilities. Our models will always be biased toward lower graduation probabilities, because we assume that school staff, students, and parents will react to this information in various ways, some of which will impact the measures that predict graduation and some of which may not immediately impact these measures.

```{r Param9GM, results='asis'}
sjp.glm(model.9GMt$finalModel, 
        title='9GM-TOY Odds Ratios', 
        showModelSummary = FALSE,
        theme = 'bw',
        borderColor = 'white')#,
#         axisLabels.y = c('Attendance * 10', '9th Grade GPA', 
#                          'Overage Entering High School', 'Days Suspended',
#                          'Total Credits', 'Science Credits'))
sjp.glm(model.9GMr$finalModel, 
        title='9GM-EOY Odds Ratios',
        showModelSummary = FALSE,
        theme = 'bw',
        borderColor = 'white')#,
#         axisLabels.y = c('Attendance * 10', '9th Grade GPA', 
#                          'Overage Entering High School',
#                          'Days Suspended', 'Total Credits', 'Science Credits',
#                          'Retained in 9th Grade'))
```

```{r 9GMThresholds}
hscohort_train$predict9GMt <- predict(model.9GMt, 
                                      newdata = hscohort_train, 
                                      type = 'prob')$Y
hscohort_train$predict9GMr <- predict(model.9GMr, 
                                      newdata = hscohort_train, 
                                      type = 'prob')$Y

m1_matrix <- cutoff_matrix(hscohort_train, 'predict9GMt', 'graduated')
thresholds9GMt <- data.frame(classification = as.factor(c('Watch', 
                                                          'Warning', 'Action')),
  threshold = c(m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .6)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .7)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .8)),]$cutoff))

# Compute coverage: what proportion of those who fail to graduate are identified
thresholds9GMt$coverage <- NA
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predict9GMt <= subset(thresholds9GMt, 
                                     classification=='Action')$threshold))
thresholds9GMt[thresholds9GMt$classification == 'Action', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predict9GMt <= subset(thresholds9GMt, 
                                     classification=='Warning')$threshold))
thresholds9GMt[thresholds9GMt$classification == 'Warning', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predict9GMt <= subset(thresholds9GMt, 
                                     classification=='Watch')$threshold))
thresholds9GMt[thresholds9GMt$classification == 'Watch', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
thresholds9GMt$coverage <- round(thresholds9GMt$coverage, digits=3)

m1_matrix <- cutoff_matrix(hscohort_train, 'predict9GMr', 'graduated')
thresholds9GMr <- data.frame(classification = as.factor(c('Watch', 
                                                          'Warning', 'Action')),
  threshold = c(m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .6)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .7)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .8)),]$cutoff))

# Compute coverage: what proportion of those who fail to graduate are identified
thresholds9GMr$coverage <- NA
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predict9GMr <= subset(thresholds9GMr, 
                                     classification=='Action')$threshold))
thresholds9GMr[thresholds9GMr$classification == 'Action', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predict9GMr <= subset(thresholds9GMr, 
                                     classification=='Warning')$threshold))
thresholds9GMr[thresholds9GMr$classification == 'Warning', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predict9GMr <= subset(thresholds9GMr, 
                                     classification=='Watch')$threshold))
thresholds9GMr[thresholds9GMr$classification == 'Watch', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
thresholds9GMr$coverage <- round(thresholds9GMr$coverage, digits=3)
```


```{r HSNew9th}
hs1011 <- subset(person, schoolyear_first=='2010_2011' & grade_first==9)
hs1112 <- subset(person, schoolyear_first=='2012' & grade_first==9)
hs1213 <- subset(person, schoolyear_first=='2013' & grade_first==9)

hs1011$sasid <- as.character(hs1011$sasid)
hs1112$sasid <- as.character(hs1112$sasid)
hs1213$sasid <- as.character(hs1213$sasid)



hs1011$retained <- ifelse(hs1011$sasid %in% 
                          subset(tables2011_2012$person_annual, 
                                 grade == 9)$sasid,
                          'Y', 'N')
hs1112$retained <- ifelse(hs1112$sasid %in% 
                          subset(tables2012_2013$person_annual, 
                                 grade == 9)$sasid,
                          'Y', 'N')

tables2012_2013$person_annual$sasid <- 
  as.character(tables2012_2013$person_annual$sasid) 
hs1213 <- merge(hs1213, tables2012_2013$person_annual[, c('sasid', 
                                                           'willrepeatgr')],
                all.x=TRUE)
names(hs1213)[length(names(hs1213))] <- 'retained'
hs1213$retained <- as.character(hs1213$retained)
hs1213$retained <- ifelse(hs1213$retained == ' ', NA,
                          hs1213$retained)

hs1011 <- merge(hs1011, subset(attendance, schoolyear=='2010_2011', 
                               select = c('sasid', 'attendance', 
                                          'tardy', 'suspended')),
                all.x=TRUE)
hs1112 <- merge(hs1112, subset(attendance, schoolyear=='2011_2012', 
                               select = c('sasid', 'attendance', 
                                          'tardy', 'suspended')),
                all.x=TRUE)
hs1213 <- merge(hs1213, subset(attendance, schoolyear=='2012_2013', 
                               select = c('sasid', 'attendance', 
                                          'tardy', 'suspended')),
                all.x=TRUE)

hs1011 <- transform(hs1011,
                    ageHS = age_calc(dob, 
                                     as.Date('2010-09-01'), 
                                     units='months'))
hs1112 <- transform(hs1112,
                    ageHS = age_calc(dob, 
                                     as.Date('2011-09-01'), 
                                     units='months'))
hs1213 <- transform(hs1213,
                    ageHS = age_calc(dob, 
                                     as.Date('2010-09-01'), 
                                     units='months'))
gpa_9th_1011 <- tables2010_2011$course %.% 
                filter(grade==9 & 
                       sasid %in% hs1011$sasid) %.% 
                group_by(sasid) %.% 
                summarise(gpa9th = mean(gpa, na.rm=TRUE))
gpa_9th_1112 <- tables2011_2012$course %.% 
                filter(grade==9 & 
                       sasid %in% hs1112$sasid) %.% 
                group_by(sasid) %.% 
                summarise(gpa9th = mean(gpa, na.rm=TRUE))
gpa_9th_1213 <- tables2012_2013$course %.% 
                filter(grade==9 & 
                       sasid %in% hs1213$sasid) %.% 
                group_by(sasid) %.% 
                summarise(gpa9th = mean(gpa, na.rm=TRUE))


gpa_9th_1011$sasid <- as.character(gpa_9th_1011$sasid)
gpa_9th_1112$sasid <- as.character(gpa_9th_1112$sasid)
gpa_9th_1213$sasid <- as.character(gpa_9th_1213$sasid)


hs1011 <- merge(hs1011, gpa_9th_1011, all.x=TRUE)
hs1112 <- merge(hs1112, gpa_9th_1112, all.x=TRUE)
hs1213 <- merge(hs1213, gpa_9th_1213, all.x=TRUE)
credits_1011 <- tables2010_2011$course %.%
                filter(grade == 9 &
                       sasid %in% hs1011$sasid) %.%
                select(sasid, courseno, type, credits)
credits_1011 <- credits_1011[!duplicated(credits_1011), ]
credits_1011 <- ungroup(credits_1011) %.%
                group_by(sasid, type) %.%
                summarize(credits = sum(as.numeric(credits), na.rm = TRUE)) %.%
                select(sasid, type, credits)
credits_1011$type <- ifelse(credits_1011$type == "", 'none_cred',
                            paste(tolower(credits_1011$type), 'cred', sep = '_'))
credits_1011$type <- with(credits_1011,
                          ifelse(type == 'read_cred',
                                 'eng_cred',
                                 type))
credits_1011 <- dcast(sasid ~ type, value.var='credits', sum, data=credits_1011)
credits_1011$total_cred <- apply(credits_1011[, -1], 1, sum)
credits_1112 <- tables2011_2012$course %.%
                filter(grade == 9 &
                       sasid %in% hs1112$sasid) %.%
                select(sasid, courseno, type, credits)
credits_1112 <- credits_1112[!duplicated(credits_1112), ]
credits_1112 <- ungroup(credits_1112) %.%
                group_by(sasid, type) %.%
                summarize(credits = sum(as.numeric(credits), na.rm = TRUE)) %.%
                select(sasid, type, credits)
credits_1112$type <- ifelse(credits_1112$type == "", 'none_cred',
                            paste(tolower(credits_1112$type), 'cred', sep = '_'))
credits_1112 <- dcast(sasid ~ type, value.var='credits', sum, data=credits_1112)
credits_1112$total_cred <- apply(credits_1112[, -1], 1, sum)
credits_1213 <- tables2012_2013$course %.%
                filter(grade == 9 &
                       sasid %in% hs1213$sasid) %.%
                select(sasid, courseno, type, credits)
credits_1213 <- credits_1213[!duplicated(credits_1213), ]
credits_1213 <- ungroup(credits_1213) %.%
                group_by(sasid, type) %.%
                summarize(credits = sum(as.numeric(credits), na.rm = TRUE)) %.%
                select(sasid, type, credits)
credits_1213$type <- ifelse(credits_1213$type == "", 'none_cred',
                            paste(tolower(credits_1213$type), 'cred', sep = '_'))
credits_1213$type <- with(credits_1213,
                          ifelse(type =='arts_cred',
                                 'art_cred',
                                 type))
credits_1213 <- dcast(sasid ~ type, value.var='credits', sum, data=credits_1213)
credits_1213$total_cred <- apply(credits_1213[, -1], 1, sum)

hs1011 <- merge(hs1011, credits_1011, all.x=TRUE)
hs1112 <- merge(hs1112, credits_1112, all.x=TRUE)
hs1213 <- merge(hs1213, credits_1213, all.x=TRUE)

mobile1011 <-  moves_calc(subset(tables2010_2011$enrollment, 
                                 sasid %in% hs1011$sasid & grade == 9),
                          gap = 30, enrollby = "2010-10-01")
mobile1112 <-  moves_calc(subset(tables2011_2012$enrollment, 
                                 sasid %in% hs1112$sasid & grade == 9),
                          gap = 30, enrollby = "2011-10-01")
mobile1213 <-  moves_calc(subset(tables2012_2013$enrollment, 
                                 sasid %in% hs1213$sasid & grade == 9),
                          gap = 30, enrollby = "2012-10-01")
mobile1011$sasid <- as.character(mobile1011$sasid)
mobile1112$sasid <- as.character(mobile1112$sasid)
mobile1213$sasid <- as.character(mobile1213$sasid)
hs1011 <- merge(hs1011, mobile1011, all.x=TRUE)
hs1112 <- merge(hs1112, mobile1112, all.x=TRUE)
hs1213 <- merge(hs1213, mobile1213, all.x=TRUE)
hs_new9 <- rbind(hs1011, hs1112, hs1213)
hs_new9 <- subset(hs_new9, !schno_first %in% charters)
hs_new9 <- mutate(hs_new9, 
                  core_cred = math_cred + eng_cred + sci_cred + soc_cred)
hs_new9 <- na.omit(hs_new9)
hs_new9$predict9GMt <- predict(model.9GMt, newdata=hs_new9, type='prob')$Y
hs_new9$predict9GMr <- predict(model.9GMr, newdata=hs_new9, type='prob')$Y
hs_new9$classification9GMt <- cut(hs_new9$predict9GMt, 
                                  breaks=rev(c(1, thresholds9GMt$threshold, 0)), 
                                  include.lowest=TRUE, 
                                  labels = rev(c('On-track', 
                                               as.character(thresholds9GMt$classification))))
hs_new9$classification9GMt <- 
  factor(hs_new9$classification9GMt, 
         levels = rev(levels(hs_new9$classification9GMt)), 
         ordered=TRUE)
hs_new9$classification9GMr <- cut(hs_new9$predict9GMr, 
                                  breaks=rev(c(1, thresholds9GMr$threshold, 0)), 
                                  include.lowest=TRUE, 
                                  labels=rev(c('On-track', 
                                        as.character(thresholds9GMr$classification))))
hs_new9$classification9GMr <- 
  factor(hs_new9$classification9GMr, 
         levels = rev(levels(hs_new9$classification9GMr)), 
         ordered=TRUE)
```

The classifications from the two models can be applied to the three most recent freshman classes to compare the extent to which including retention impacts a student's overall classification in practice.
```{r 9GMRv9GMTclasses, results='asis'}
heatmap <- as.data.frame(with(hs_new9, 
                              table(classification9GMt, classification9GMr)))
ggplot(data = heatmap, aes(classification9GMt, classification9GMr, fill=Freq)) +
geom_tile() +
scale_fill_gradient(low="#EFF3FF", high="#08519C") +
geom_text(aes(fill = heatmap$Freq, label = heatmap$Freq))
```
Nearly all students maintained their same classification, with the largest shift being students who would be classified as **Warning** in the model excluding retention moving to **Action** in the model that includes retention. This is unsurprising-- students who are at the margin of the highest risk category that are retained see the biggest negative impact from retention.

```{r 9GMlongestFreshman, results='asis'}
freshman_hs1011 <- findFreshmanHS(all_years_enr, '2010_2011')
freshman_hs1112 <- findFreshmanHS(all_years_enr, '2012')
freshman_hs1213 <- findFreshmanHS(all_years_enr, '2013')
hs_new9 <- left_join(hs_new9, 
                     rbind(freshman_hs1011, freshman_hs1112, freshman_hs1213))
# Combine all of the Hope High Schools
hs_new9$schno_hs_f9_long <- with(hs_new9, 
                            ifelse(as.character(schno_hs_f9_long) %in% 
                                     c('181', '183'),
                                  '149', as.character(schno_hs_f9_long)))

# Combine PAIS with HSTA & PAIS
hs_new9$schno_hs_f9_long <- with(hs_new9, 
                            ifelse(as.character(schno_hs_f9_long) %in% 
                                     c('173'),
                                  '175', as.character(schno_hs_f9_long)))
school_f9 <- as.data.frame(with(hs_new9, 
                                prop.table(table(schno_hs_f9_long, 
                                                 classification9GMr), 1)))
school_f9 <- na.omit(school_f9)
school_f9 <- filter(school_f9, 
                    !schno_hs_f9_long %in% c('185', '147', '114', 
                                             '117', '189', '131'))
#school_ms <- filter(school_ms,
#                            !schno_first %in% c('185', '147'))
#school_lookup <- unique(hs_new[, c('schno_ms_long', 'school_ms_long')])
#school_lookup$schno_ms_long <- as.character(school_lookup$schno_ms_long)
#school_ms$schno_ms_long <- as.character(school_ms$school_ms_long)
school_lookup <- data.frame(schno_hs_f9_long = as.character(c(139, 149, 150, 
                                                              164, 167, 169, 
                                                              175, 193)), 
                            school_hs_f9_long = c('Central', 'Hope', 
                                                  'Mount Pleasant', 'Classical',
                                                  'E-Cubed', 'Alvarez', 
                                                  'Sanchez', 'Career & Tech'),
                            stringsAsFactors = FALSE)
school_f9$schno_hs_f9_long <- as.character(school_f9$schno_hs_f9_long)
school_f9 <- left_join(school_f9, school_lookup)
school_f9_seq <- school_f9 %.%
                 filter(classification9GMr == 'On-track') %.%
                 arrange(Freq)
school_f9$school_hs_f9_long <- factor(school_f9$school_hs_f9_long,
                                      levels = school_f9_seq$school_hs_f9_long)
ggplot(data = na.omit(school_f9), 
       aes(school_hs_f9_long, Freq, fill=classification9GMr)) + 
geom_bar(stat='identity', position='stack') + 
scale_y_continuous('', 
                   labels = percent_format(), 
                   breaks = seq(0,1,.1),
                   limits = c(0, 1.05),
                   expand = c(0, 0)) +
scale_x_discrete('HS Attended Longest As First-Time 9th Grade',
                 labels = substr(x=levels(school_f9$school_hs_f9_long), 1, 13)) +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
theme(axis.text.x = element_text(angle=90)) +
ggtitle('Classifications by High School After 9th Grade')
```
After the first year of high school, there is still considerable range in the On-track status of students by school. Alvarez and PCTA appear to make the biggest changes, both improving their overall On-track status and relative position compared to other high schools. To better see the changes in On-track status, we have plotted the percent On-track of incoming students on the x-axis and the percent On-track at the end of 9th grade by high school. The 45° line, $ y=x$, represents no change. The further above the line a school is listed, the more it has increased On-track status. Below the line represents a decrease in On-track status.
```{r HSFirstYearImpact, results='asis'}
incoming_on_track <- school_first_data %.%
                     filter(classification=='On-track')
end_of_9 <- school_f9 %.%
            filter(classification9GMr == 'On-track')
names(end_of_9) <- c('schno_f9', 'classification9', 'Freq9', 'school_f9')

impact <- merge(incoming_on_track, end_of_9, 
                by.x=c('schno_first', 'school_first'),
                by.y=c('schno_f9', 'school_f9'))

ggplot(impact, aes(Freq, Freq9)) +
geom_point() + 
geom_text(aes(label=school_first),hjust=0, vjust=0) + 
geom_abline(intercept=0, slope=1) + 
scale_x_continuous('On-track entering 9th grade', 
                   labels = percent_format(), limits=c(0,1)) + 
scale_y_continuous('On-track after 9th grade',
                   labels = percent_format(), limits=c(0,1)) +
ggtitle('Impact of First Year of High School on On-Track Status by School')
```

#### Race
We continue to see racial gaps in On-track status after ninth grade, with White and Asian students being more likely to be On-track than Black or Hispanic students. However, when we exclude Classical High School, these patterns reverse. White students are least likely to be on track, trailing Hispanic students by approximately 5%, Black students by nearly 10%, and Asian students by nearly 13%.
```{r RacePic9GM, results='asis'}
race <- as.data.frame(with(hs_new9, prop.table(table(race, 
                                                     classification9GMr), 1)))

race_n <- as.data.frame(with(hs_new9, table(race, classification9GMr)))
# n-size exclusion
race <- filter(race, race != 'Pacific Islander')
# race_n <- filter(race_n, race != 'Pacific Islander') # n-size exclusion
# names(race_n)[ncol(race_n)] <- 'n'
# race <- left_join(race, race_n)

race_seq <- race %.%
            filter(classification9GMr == 'On-track') %.%
            arrange(Freq)
race$race <- factor(race$race,
                    levels = race_seq$race,
                    ordered=TRUE)

ggplot(race, aes(race, Freq, fill = classification9GMr, order=race)) + 
geom_bar(stat = 'identity', position = 'stack') + 
geom_text(aes(label = percent(Freq), y = Freq, ymax = 1), 
          position = 'stack',
          vjust = 1.66,
          fontface = 'bold',
          color = '#3f4c55') + 
scale_y_continuous('', 
                   labels = percent_format(), 
                   breaks=seq(0,1,.1),
                   expand = c(0, 0)) +
scale_x_discrete('',
                 expand = c(0, 0)) +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
ggtitle('End of 9th Grade Risk by Race')

## Race without Classical
race <- as.data.frame(with(subset(hs_new9, !schno_hs_f9_long %in% '164'), 
                                  prop.table(table(race, 
                                                   classification9GMr), 1)))

race_n <- as.data.frame(with(subset(hs_new9, !schno_hs_f9_long %in% '164'), 
                             table(race, classification9GMr)))
# n-size exclusion
race <- filter(race, race != 'Pacific Islander')
# race_n <- filter(race_n, race != 'Pacific Islander') # n-size exclusion
# names(race_n)[ncol(race_n)] <- 'n'
# race <- left_join(race, race_n)

race_seq <- race %.%
            filter(classification9GMr == 'On-track') %.%
            arrange(Freq)
race$race <- factor(race$race,
                    levels = race_seq$race,
                    ordered=TRUE)

ggplot(race, aes(race, Freq, fill = classification9GMr, order=race)) + 
geom_bar(stat = 'identity', position = 'stack') + 
geom_text(aes(label = percent(Freq), y = Freq, ymax = 1), 
          position = 'stack',
          vjust = 1.66,
          fontface = 'bold',
          color = '#3f4c55') + 
scale_y_continuous('', 
                   labels = percent_format(), 
                   breaks=seq(0,1,.1),
                   expand = c(0, 0)) +
scale_x_discrete('',
                 expand = c(0, 0)) +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
ggtitle('End of 9th Grade Risk by Race without Classical')

```

## Tenth Grade Model
The 10th grade model (10GM) has a complex sample because a large number of students repeat 9th grade. This model uses all first-time 10th grade students. This is defined by looking at the enrollment records from the 2005-2006 school year through to the 2012-2013 school year and selecting all records for the 10th grade. The minimum enrollment date for each student is then chosen. Based on that enrollment date, each student is assigned a school year representing their first enrollment in the 10th grade in PPSD. 

All 10th grade data is filtered both by grade and the school year selected as the first enrollment in the 10th grade. The model is then constructed from the subset of students who entered PPSD for the first time as a ninth grade student in the school years 2006-2007, 2007-2008, 2008-2009, and 2009-2010 or entered PPSD for the first time as tenth grade students in 2007-2008, 2008-2009, 2009-2010, and 2010-2011.

The models were constructed using the same candidate predictors as previous models, with final model selection based on out-of-sample AUC and likelihood-ratio tests both between and step-wise within models.
```{r TenthGradeModel}
hs0607 <- subset(person, (schoolyear_first=='2006_2007' & grade_first==9) | 
                         (schoolyear_first=='2007_2008' & grade_first==10) | 
                         (schoolyear_first=='2008_2009' & grade_first==11) | 
                         (schoolyear_first=='2009_2010' & grade_first==12))
hs0708 <- subset(person, (schoolyear_first=='2007_2008' & grade_first==9) | 
                         (schoolyear_first=='2008_2009' & grade_first==10) | 
                         (schoolyear_first=='2009_2010' & grade_first==11) | 
                         (schoolyear_first=='2010_2011' & grade_first==12))
hs0809 <- subset(person, (schoolyear_first=='2008_2009' & grade_first==9) | 
                         (schoolyear_first=='2009_2010' & grade_first==10) | 
                         (schoolyear_first=='2010_2011' & grade_first==11) | 
                         (schoolyear_first=='2011_2012' & grade_first==12))
hs0910 <- subset(person, (schoolyear_first=='2009_2010' & grade_first==9) | 
                         (schoolyear_first=='2010_2011' & grade_first==10) | 
                         (schoolyear_first=='2011_2012' & grade_first==11) | 
                         (schoolyear_first=='2012_2013' & grade_first==12))
first9th <- all_years_enr %.% 
            filter(grade == 9) %.% 
            group_by(sasid) %.% 
            summarize(enroll_date = min(enroll_date))
first9th$schoolyear_9 <- 
  ifelse(month(first9th$enroll_date) %in% seq(8,12,1),
         paste(year(first9th$enroll_date), 
               year(first9th$enroll_date) + 1, 
               sep = "_"),
         paste(year(first9th$enroll_date) - 1,
               year(first9th$enroll_date),
               sep = "_"))


first10th <- all_years_enr %.% 
             filter(grade == 10) %.% 
             group_by(sasid) %.% 
             summarize(enroll_date = min(enroll_date))
first10th$schoolyear <- 
  ifelse(month(first10th$enroll_date) %in% seq(8,12,1),
         paste(year(first10th$enroll_date), 
               year(first10th$enroll_date) + 1, 
               sep = "_"),
         paste(year(first10th$enroll_date) - 1,
               year(first10th$enroll_date),
               sep = "_"))

hs0607$sasid <- as.character(hs0607$sasid)
hs0708$sasid <- as.character(hs0708$sasid)
hs0809$sasid <- as.character(hs0809$sasid)
hs0910$sasid <- as.character(hs0910$sasid)
hscohort <- rbind(hs0607, hs0708, hs0809, hs0910)
hscohort <- left_join(hscohort,
                      first10th %.%
                      select(sasid, schoolyear))
hscohort <- left_join(hscohort,
                      first9th %.%
                      select(sasid, schoolyear_9))
hscohort <- subset(hscohort, !is.na(schoolyear))
hscohort$schoolyear_9 <- with(hscohort,
                              ifelse(is.na(schoolyear_9),
                                     paste((as.numeric(substring(schoolyear, 
                                                                 1, 4)) - 1),
                                           substring(schoolyear, 1, 4), 
                                           sep = "_"),
                                     schoolyear_9))
# Repeated 9th grade
hscohort <- left_join(hscohort,
                      retained_calc(x = annual_demos, 
                                    sid = 'sasid',
                                    grade = 'grade',
                                    grade_value = 9))
names(hscohort)[length(names(hscohort))] <- 'retained9th'

# Repeated 10th grade
retained <- annual_demos %.%
            filter(grade == 10) %.%
            select(sasid, willrepeatgr, schoolyear)

hscohort <- left_join(hscohort,
                      retained)
names(hscohort)[length(names(hscohort))] <- 'retained'
hscohort$retained <- with(hscohort,
                          ifelse(as.character(retained) == ' ', 
                                 'N', 
                                 as.character(retained)))
hscohort$retained <- ifelse(is.na(hscohort$retained),
                             'N',
                             hscohort$retained)

hscohort <- left_join(hscohort, 
                      attendance %.%
                      filter(grade == 10) %.%
                      select(sasid, schoolyear, attendance, tardy, suspended))


hscohort <- mutate(hscohort, 
                   ageHS = age_calc(dob,
                                    as.Date(paste(substr(schoolyear_9, 1, 4), 
                                                  '09', '01', sep='-')),
                                    units = 'months'))
hscohort <- mutate(hscohort, 
                   age10 = age_calc(dob,
                                    as.Date(paste(substr(schoolyear, 1, 4), 
                                                  '09', '01', sep='-')),
                                    units = 'months'))

gpa <- rbind(tables2007_2008$course,
             tables2008_2009$course,
             tables2009_2010$course,
             tables2010_2011$course,
             tables2011_2012$course) %.%
             filter(grade == 10) %.%
             group_by(sasid, schyr) %.%
             summarize(gpa10th = mean(gpa, na.rm=TRUE)) %.%
             select(sasid, gpa10th, schyr)
names(gpa)[which(names(gpa)=='schyr')] <- 'schoolyear'
gpa$schoolyear <- paste(gpa$schoolyear-1, gpa$schoolyear, sep='_')

fails <- rbind(tables2007_2008$course,
               tables2008_2009$course,
               tables2009_2010$course,
               tables2010_2011$course,
               tables2011_2012$course) %.%
         filter(grade == 10) %.%
         group_by(sasid, courseno, schyr) %.%
         summarize(gpa10th = mean(gpa, na.rm=TRUE)) %.%
         filter(gpa10th <= 1.0)

fails <- ungroup(fails) %.%
         group_by(sasid, schyr) %.%
         summarize(fails = n()) %.%
         select(sasid, fails, schyr)
names(fails)[which(names(fails)=='schyr')] <- 'schoolyear'
fails$schoolyear <- paste(fails$schoolyear-1, fails$schoolyear, sep='_')

mobile0607 <- moves_calc(filter(tables2007_2008$enrollment, grade == 10),
                         gap = 30, enrollby = "2007-10-01")
mobile0607$schoolyear <- '2007_2008'
mobile0708 <- moves_calc(filter(tables2008_2009$enrollment, grade == 10),
                         gap = 30, enrollby = "2008-10-01")
mobile0708$schoolyear <- '2008_2009'
mobile0809 <- moves_calc(filter(tables2009_2010$enrollment, grade == 10),
                         gap = 30, enrollby = "2009-10-01")
mobile0809$schoolyear <- '2009_2010'
mobile0910 <- moves_calc(filter(tables2010_2011$enrollment, grade == 10),
                         gap = 30, enrollby = "2010-10-01")
mobile0910$schoolyear <- '2010_2011'
mobile1011 <- moves_calc(filter(tables2011_2012$enrollment, grade == 10),
                         gap = 30, enrollby = "2011-10-01")
mobile1011$schoolyear <- '2011_2012'

mobile <- rbind(mobile0607, mobile0708, mobile0809, mobile0910, mobile1011)
mobile$sasid <- as.character(mobile$sasid)
hscohort <- left_join(hscohort, mobile)
hscohort <- left_join(hscohort, gpa)
hscohort <- left_join(hscohort, fails)
hscohort$fails <- with(hscohort, 
                       ifelse(!is.na(gpa10th) & is.na(fails), 0, fails))

all_course <- rbind(tables2005_2006$course,
                    tables2006_2007$course,
                    tables2007_2008$course,
                    tables2008_2009$course,
                    tables2009_2010$course,
                    tables2010_2011$course)
credits <- all_course %.%
           filter(grade %in% c(9, 10)) %.%
           select(sasid, courseno, type, credits, schyr)
rm(all_course)
credits <- credits[!duplicated(credits), ]
credits <- credits %.%
           group_by(sasid, schyr, type) %.%
           summarize(credits = sum(as.numeric(credits), na.rm = TRUE)) %.%
           select(sasid, schyr, type, credits)
credits$type <- ifelse(credits$type == "", 'none_cred',
                       paste(tolower(credits$type), 'cred', sep = '_'))
names(credits)[which(names(credits)=='schyr')] <- 'schoolyear'
credits$schoolyear <- paste(credits$schoolyear-1, credits$schoolyear, sep='_')
year_filter <- hscohort[, c('sasid', 'schoolyear')]
names(year_filter) <- c('sasid', 'tenthyear')
credits <- inner_join(credits, year_filter)
# Now each instance of a student has the first year of tenth grade in tenthyear
credits$schoolyear <- as.numeric(substr(credits$schoolyear, 1, 4))
credits$tenthyear <- as.numeric(substr(credits$tenthyear, 1, 4))
credits <- subset(credits, schoolyear <= tenthyear)
credits <- credits %.%
           group_by(sasid, type) %.%
           summarize(credits = sum(credits)) %.%
           select(sasid, type, credits)
credits <- dcast(sasid ~ type, value.var='credits', sum, data = credits)
credits$total_cred <- apply(credits[, -1], 1, sum)
credits <- mutate(credits,
                  core_cred = math_cred + eng_cred + sci_cred + soc_cred)
hscohort <- left_join(hscohort, credits)

```

```{r Train10GM}
hscohort <- filter(hscohort, transfer_out=='N')
hscohort$schoolyear_first <- as.factor(hscohort$schoolyear_first)
# hscohort$graduated <- ifelse(hscohort$graduated == 'Y', 1, 
#                              ifelse(hscohort$graduated == 'N', 0, NA))
hscohort$graduated <- as.factor(hscohort$graduated)
#hscohort <- na.omit(hscohort)
require(caret)
set.seed(101)
trainIndex <- createDataPartition(hscohort$graduated,
                                  p = .8, list=FALSE)
hscohort_train <- hscohort[trainIndex,]
hscohort_test <- hscohort[-trainIndex,]
predictors <- c('attendance', 'gpa10th', 'retained9th', 'ageHS', 'suspended',
                'fails', 'moves', 'retained', 'total_cred', 'math_cred', 
                'sci_cred', 'eng_cred', 'soc_cred', 'core_cred', 'age10')
set.seed(101)
model.10glm <- train(hscohort[, c('attendance', 'gpa10th', 'suspended', 'fails',
                                  'moves', 'age10')],
                     hscohort[, c('graduated')],
                     method='glmStepAIC',
                     tuneLenght = 5,
                     trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary,
                                          seeds = NA),
                     metric='ROC')
model.10 <- train(graduated ~ I(attendance*10) + gpa10th + 
                              retained + I(age10>192) + core_cred, 
                 data=hscohort_train,
                 method='glm',
                 tuneLength = 5,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary,
                                          seeds = NA),
                 metric='ROC')
model.10r <- train(graduated ~ I(attendance*10) + gpa10th + 
                              retained + I(age10>192), 
                 data=hscohort_train,
                 method='glm',
                 tuneLength = 5,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary,
                                          seeds = NA),
                 metric='ROC')
model.10c <- train(graduated ~ I(attendance*10) + gpa10th + 
                               core_cred + I(age10>192), 
                 data=hscohort_train,
                 method='glm',
                 tuneLength = 5,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary,
                                          seeds = NA),
                 metric='ROC')
model.10a <- train(graduated ~ I(attendance*10) + gpa10th + 
                               I(age10>192), 
                 data=hscohort_train,
                 method='glm',
                 tuneLength = 5,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary,
                                          seeds = NA),
                 metric='ROC')
model.10f <- train(graduated ~ I(attendance*10) + gpa10th*fails + moves + 
                               I(age10>192), 
                 data=hscohort_train,
                 method='glm',
                 tuneLength = 5,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary,
                                          seeds = NA),
                 metric='ROC')

```

```{r ROC10GM, results='asis', fig.width=7, fig.height=7}
hscohort_test <- hscohort_test[, c('sasid', 'attendance', 'gpa10th', 
                                   'retained', 'age10', 'core_cred',
                                   'graduated')]
hscohort_test <- na.omit(hscohort_test)
grade_10_comps <- subset(bowersEWS, grade==10)
roc_10 <- roc(hscohort_test$graduated, 
              predict(model.10, newdata=hscohort_test, type='prob')$Y,
              auc=TRUE, ci=TRUE)
roc_10t <- roc(hscohort_test$graduated,
               predict(model.10c, newdata=hscohort_test, type='prob')$Y,
               auc=TRUE, ci=TRUE)
rocobj1 <- plot.roc(roc_10, 
                    main="10GM ROC",
                    col="#1c61b6",
                    print.auc=TRUE,
                    legacy.axes=TRUE)
rocobj2 <- lines.roc(roc_10t, col="#008600")  
testobj <- roc.test(rocobj1, rocobj2)
# lines.roc(roc_reta, col='gray')
points(x=grade_10_comps$specificity, 
       y=grade_10_comps$sensitivity, col='gray', pch = 20)  
text(0.5, 0.1, labels=paste("p-value =", format.pval(testobj$p.value)), adj=c(0, .5))  
legend("bottomright", legend=c("10GM", "10GM C"), col=c("#1c61b6", "#008600"), lwd=2)

#legend("bottomright", legend=c("10GM"), 
#      col=c("#1c61b6"), lwd=2)
```

```{r 10GMOddsratio, results='asis'}
sjp.glm(model.10$finalModel, 
        title='10GM Odds Ratios', 
        showModelSummary = FALSE,
        theme = 'bw',
        borderColor = 'white')#,
#         axisLabels.y = c('Attendance * 10', '10th Grade GPA', 'Retained 9th',
#                          'Retained 10th',
#                          'Overage by 1 year prior to 10th grade',
#                          'Overage by 2 or more years prior to 10th grade'))

sjp.glm(model.10c$finalModel, 
        title='10GM Odds Ratios', 
        showModelSummary = FALSE,
        theme = 'bw',
        borderColor = 'white')
```
The predictors in this model are more complex than in previous models. Both 10th grade attendance and 10th grade GPA are the familiar measures used in previous models. Retention and overage measures are more difficult to measure when some students may not have been enrolled in PPSD in the past. For this model, a student is considered to have been retained in 9th grade if there are multiple school years where that student was enrolled in 9th grade in PPSD. Retention in 10th grade is based on the flag students receive at the end of 10th grade that says they will be repeating that grade. This is used only for the first year that students are enrolled in tenth grade and was selected because it can be known for all students at the end of tenth grade. 

Overage is also more complex to calculate. In the past, we have defined overage as being greater than 180 months old on September 1 in the year a student enrolled in 9th grade for the first time. This accounted for prior retention history or late entry into schooling. However, not all tenth grade students were enrolled in PPSD for ninth grade, and some may have repeated ninth grade several times. In order to account for this, we used the following rules.

1. We calculated the first year a student was in 9th grade in PPSD based on the same rules used for the first-time 10th grade school year.
2. If there was no history of 9th grade enrollment in PPSD, we set the 9th grade year as one year prior to the first time a student has enrolled in 10th grade.
3. Because students in (1) may have enrolled in PPSD for the first time as a 9th grade student after enrolling elsewhere as a ninth grader, and because students in (2) may have repeated ninth grade multiple times prior to enrolling in 10th grade in PPSD, we have created two overage predictors.
  a. Students whose age was greater than 180 months but less than 192 months (1 year overage)
  b. Students whose age was greater than 192 months (at least 2 years overage).
  
As a result, some students who are not captured by the measure for retention in 9th grade will be captured by the >192 months predictor.

We have tested the model with and without the 10th grade retention indicator like the 9GM model to see if the model can be used and updated throughout the year prior to knowing whether a student will repeat the grade. While we find that the model utilizing the retention data to be more successful at predicting graduation, we again believe that this improvement is sufficiently small that it supports implementing the 10GM without the retention data throughout the year. We recommend this model be used at the end of the second quarter and the end of the third quarter to inform practice. Students at the beginning of tenth grade should be classified using the 9GM model with 9th grade retention.

```{r 10GMThresholds}
hscohort_predictions <- hscohort_train[, c('sasid', 'attendance', 'gpa10th', 
                                           'retained', 'age10', 'core_cred',
                                           'graduated')]
hscohort_predictions <- na.omit(hscohort_predictions)
hscohort_predictions$predict10GM <- predict(model.10, 
                                            newdata = hscohort_predictions, 
                                            type = 'prob')$Y
hscohort_predictions$predict10GMc <- predict(model.10c, 
                                             newdata = hscohort_predictions, 
                                             type = 'prob')$Y

m1_matrix <- cutoff_matrix(hscohort_predictions, 'predict10GM', 'graduated')
thresholds10GM <- data.frame(classification = as.factor(c('Watch', 
                                                          'Warning', 'Action')),
  threshold = c(m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .6)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .7)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .8)),]$cutoff))

# Compute coverage: what proportion of those who fail to graduate are identified
thresholds10GM$coverage <- NA
coverage <- as.data.frame(table(
  hscohort_predictions$graduated, 
  hscohort_predictions$predict10GM <= subset(thresholds10GM, 
                                     classification=='Action')$threshold))
thresholds10GM[thresholds10GM$classification == 'Action', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_predictions$graduated, 
  hscohort_predictions$predict10GM <= subset(thresholds10GM, 
                                     classification=='Warning')$threshold))
thresholds10GM[thresholds10GM$classification == 'Warning', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_predictions$graduated, 
  hscohort_predictions$predict10GM <= subset(thresholds10GM, 
                                     classification=='Watch')$threshold))
thresholds10GM[thresholds10GM$classification == 'Watch', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
thresholds10GM$coverage <- round(thresholds10GM$coverage, digits=3)

m1_matrix <- cutoff_matrix(hscohort_predictions, 'predict10GMc', 'graduated')
thresholds10GMc <- data.frame(classification = as.factor(c('Watch', 
                                                          'Warning', 'Action')),
  threshold = c(m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .6)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .7)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .8)),]$cutoff))

# Compute coverage: what proportion of those who fail to graduate are identified
thresholds10GMc$coverage <- NA
coverage <- as.data.frame(table(
  hscohort_predictions$graduated, 
  hscohort_predictions$predict10GMc <= subset(thresholds10GMc, 
                                     classification=='Action')$threshold))
thresholds10GMc[thresholds10GMc$classification == 'Action', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_predictions$graduated, 
  hscohort_predictions$predict10GMc <= subset(thresholds10GMc, 
                                     classification=='Warning')$threshold))
thresholds10GMc[thresholds10GMc$classification == 'Warning', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_predictions$graduated, 
  hscohort_predictions$predict10GMc <= subset(thresholds10GMc, 
                                     classification=='Watch')$threshold))
thresholds10GMc[thresholds10GMc$classification == 'Watch', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
thresholds10GMc$coverage <- round(thresholds10GMc$coverage, digits=3)
```

```{r TenGMOutOfSample}
hs_new10 <- first10th %.%
            filter(schoolyear %in% c('2011_2012', '2012_2013')) %.%
            select(sasid, schoolyear)
hs_new10 <- left_join(hs_new10, person)
hs_new10$sasid <- as.character(hs_new10$sasid)
hs_new10 <- left_join(hs_new10,
                      first9th %.%
                      select(sasid, schoolyear_9))
hs_new10 <- subset(hs_new10, !is.na(schoolyear))
hs_new10$schoolyear_9 <- with(hs_new10,
                              ifelse(is.na(schoolyear_9),
                                     paste((as.numeric(substring(schoolyear, 
                                                                 1, 4)) - 1),
                                           substring(schoolyear, 1, 4), 
                                           sep = "_"),
                                     schoolyear_9))
# Repeated 9th grade
hs_new10 <- left_join(hs_new10,
                      retained_calc(x = annual_demos, 
                                    sid = 'sasid',
                                    grade = 'grade',
                                    grade_value = 9))
names(hs_new10)[length(names(hs_new10))] <- 'retained9th'

# Repeated 10th grade
retained <- annual_demos %.%
            filter(grade == 10) %.%
            select(sasid, willrepeatgr, schoolyear)
hs_new10 <- left_join(hs_new10, retained)
names(hs_new10)[length(names(hs_new10))] <- 'retained'
hs_new10$retained <- with(hs_new10,
                          ifelse(as.character(retained) == ' ', 
                                 'N', 
                                 as.character(retained)))
hs_new10$retained <- ifelse(is.na(hs_new10$retained),
                            'N',
                            hs_new10$retained)
hs_new10 <- left_join(hs_new10, 
                      attendance %.%
                      filter(grade == 10) %.%
                      select(sasid, schoolyear, attendance, tardy, suspended))


hs_new10 <- mutate(hs_new10, 
                   ageHS = age_calc(dob,
                                    as.Date(paste(substr(schoolyear_9, 1, 4), 
                                                  '09', '01', sep='-')),
                                    units = 'months'))
hs_new10 <- mutate(hs_new10, 
                   age10 = age_calc(dob,
                                    as.Date(paste(substr(schoolyear, 1, 4), 
                                                  '09', '01', sep='-')),
                                    units = 'months'))

gpa <- rbind(tables2007_2008$course,
             tables2008_2009$course,
             tables2009_2010$course,
             tables2010_2011$course,
             tables2011_2012$course,
             tables2012_2013$course) %.%
             filter(grade == 10) %.%
             group_by(sasid, schyr) %.%
             summarize(gpa10th = mean(gpa, na.rm=TRUE)) %.%
             select(sasid, gpa10th, schyr)
names(gpa)[which(names(gpa)=='schyr')] <- 'schoolyear'
gpa$schoolyear <- paste(gpa$schoolyear-1, gpa$schoolyear, sep='_')

fails <- rbind(tables2007_2008$course,
               tables2008_2009$course,
               tables2009_2010$course,
               tables2010_2011$course,
               tables2011_2012$course,
               tables2012_2013$course) %.%
         filter(grade == 10) %.%
         group_by(sasid, courseno, schyr) %.%
         summarize(gpa10th = mean(gpa, na.rm=TRUE)) %.%
         filter(gpa10th <= 1.0)

fails <- ungroup(fails) %.%
         group_by(sasid, schyr) %.%
         summarize(fails = n()) %.%
         select(sasid, fails, schyr)
names(fails)[which(names(fails)=='schyr')] <- 'schoolyear'
fails$schoolyear <- paste(fails$schoolyear-1, fails$schoolyear, sep='_')

# mobile0607 <- moves_calc(filter(tables2007_2008$enrollment, grade == 10),
#                          gap = 30, enrollby = "2007-10-01")
# mobile0607$schoolyear <- '2007_2008'
# mobile0708 <- moves_calc(filter(tables2008_2009$enrollment, grade == 10),
#                          gap = 30, enrollby = "2008-10-01")
# mobile0708$schoolyear <- '2008_2009'
# mobile0809 <- moves_calc(filter(tables2009_2010$enrollment, grade == 10),
#                          gap = 30, enrollby = "2009-10-01")
# mobile0809$schoolyear <- '2009_2010'
# mobile0910 <- moves_calc(filter(tables2010_2011$enrollment, grade == 10),
#                          gap = 30, enrollby = "2010-10-01")
# mobile0910$schoolyear <- '2010_2011'
# mobile1011 <- moves_calc(filter(tables2011_2012$enrollment, grade == 10),
#                          gap = 30, enrollby = "2011-10-01")
# mobile1011$schoolyear <- '2011_2012'

# mobile <- rbind(mobile0607, mobile0708, mobile0809, mobile0910, mobile1011)
# mobile$sasid <- as.character(mobile$sasid)
# hscohort <- left_join(hscohort, mobile)
hs_new10 <- left_join(hs_new10, gpa)
hs_new10 <- left_join(hs_new10, fails)
hs_new10$fails <- with(hs_new10, 
                       ifelse(!is.na(gpa10th) & is.na(fails), 0, fails))

all_course <- rbind(tables2005_2006$course,
                    tables2006_2007$course,
                    tables2007_2008$course,
                    tables2008_2009$course,
                    tables2009_2010$course,
                    tables2010_2011$course,
                    tables2011_2012$course,
                    tables2012_2013$course)
credits <- all_course %.%
           filter(grade %in% c(9, 10)) %.%
           select(sasid, courseno, type, credits, schyr)
rm(all_course)
credits <- credits[!duplicated(credits), ]
credits <- credits %.%
           group_by(sasid, schyr, type) %.%
           summarize(credits = sum(as.numeric(credits), na.rm = TRUE)) %.%
           select(sasid, schyr, type, credits)
credits$type <- ifelse(credits$type == "", 'none_cred',
                       paste(tolower(credits$type), 'cred', sep = '_'))
names(credits)[which(names(credits)=='schyr')] <- 'schoolyear'
credits$schoolyear <- paste(credits$schoolyear-1, credits$schoolyear, sep='_')
year_filter <- hs_new10[, c('sasid', 'schoolyear')]
names(year_filter) <- c('sasid', 'tenthyear')
credits <- inner_join(credits, year_filter)
# Now each instance of a student has the first year of tenth grade in tenthyear
credits$schoolyear <- as.numeric(substr(credits$schoolyear, 1, 4))
credits$tenthyear <- as.numeric(substr(credits$tenthyear, 1, 4))
credits <- subset(credits, schoolyear <= tenthyear)
credits <- credits %.%
           group_by(sasid, type) %.%
           summarize(credits = sum(credits)) %.%
           select(sasid, type, credits)
credits <- dcast(sasid ~ type, value.var='credits', sum, data = credits)
credits$total_cred <- apply(credits[, -1], 1, sum)
credits <- mutate(credits,
                  core_cred = math_cred + eng_cred + sci_cred + soc_cred)
hs_new10 <- left_join(hs_new10, credits)

hs_new10 <- subset(hs_new10, !schno_first %in% charters)
valid_cases <- hs_new10[, c('sasid', 'attendance', 'gpa10th', 
                            'retained', 'age10', 'core_cred',
                            'graduated')]
valid_cases <- na.omit(valid_cases)
hs_new10 <- subset(hs_new10, sasid %in% valid_cases$sasid)
hs_new10$predict10GM <- predict(model.10, newdata = hs_new10, type='prob')$Y
hs_new10$predict10GMt <- predict(model.10t, newdata = hs_new10, type='prob')$Y
hs_new10$classification10GM <- cut(hs_new10$predict10GM, 
                                  breaks=rev(c(1, thresholds10GM$threshold, 0)), 
                                  include.lowest=TRUE, 
                                  labels = rev(c('On-track', 
                                               as.character(thresholds10GM$classification))))
hs_new10$classification10GM <- 
  factor(hs_new10$classification10GM, 
         levels = rev(levels(hs_new10$classification10GM)), 
         ordered=TRUE)
hs_new10$classification10GMt <- cut(hs_new10$predict10GMt, 
                                  breaks=rev(c(1, thresholds10GMt$threshold, 0)), 
                                  include.lowest=TRUE, 
                                  labels=rev(c('On-track', 
                                        as.character(thresholds10GMt$classification))))
hs_new10$classification10GMt <- 
  factor(hs_new10$classification10GMt, 
         levels = rev(levels(hs_new10$classification10GMt)), 
         ordered=TRUE)
```

```{r CompareCredit10GM, results='asis'}
heatmap <- as.data.frame(with(hs_new10, 
                              table(classification10GM, classification10GMt)))
ggplot(data = heatmap, 
       aes(classification10GM, classification10GMt, fill=Freq)) +
geom_tile() +
scale_fill_gradient(low="#EFF3FF", high="#08519C") +
geom_text(aes(fill = heatmap$Freq, label = heatmap$Freq))
```