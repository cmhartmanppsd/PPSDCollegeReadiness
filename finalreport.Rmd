# Pathways to Graduation
```{r setup, echo=F}
opts_chunk$set(echo=FALSE, 
               warning=FALSE,
               message=FALSE, 
               results='hide', 
               dev='quartz_png', 
               dev.args=list(family='Open Sans'), 
               fig.height=5.375, fig.width=8.75)
```
```{r Initialization}
setwd('/Users/jason/Dropbox/code/PPSDCollegeReadiness/')
source('dependencies.R')
require(sjPlot)
file.sources = list.files('/Users/jason/Dropbox/code/PPSDCollegeReadiness/R', 
                          pattern='*.R$', full.names=TRUE, ignore.case=TRUE)
invisible(sapply(file.sources, source, .GlobalEnv))
invisible(source('load.R'))
invisible(source('buildTables.R'))
invisible(source('person.R'))
invisible(source('attendance.R'))
attendance$sasid <- as.character(attendance$sasid)
```

```{r 8GMData}
# Build cohort for predictive model
hs0708 <- subset(person, (schoolyear_first=='2007_2008' & grade_first==9) | 
                         (schoolyear_first=='2008_2009' & grade_first==10) | 
                         (schoolyear_first=='2009_2010' & grade_first==11) | 
                         (schoolyear_first=='2010_2011' & grade_first==12))
hs0809 <- subset(person, (schoolyear_first=='2008_2009' & grade_first==9) | 
                         (schoolyear_first=='2009_2010' & grade_first==10) | 
                         (schoolyear_first=='2010_2011' & grade_first==11) | 
                         (schoolyear_first=='2011_2012' & grade_first==12))
hs0910 <- subset(person, (schoolyear_first=='2009_2010' & grade_first==9) | 
                         (schoolyear_first=='2010_2011' & grade_first==10) | 
                         (schoolyear_first=='2011_2012' & grade_first==11) | 
                         (schoolyear_first=='2012_2013' & grade_first==12))
hs0708$sasid <- as.character(hs0708$sasid)
hs0809$sasid <- as.character(hs0809$sasid)
hs0910$sasid <- as.character(hs0910$sasid)

hs0708 <- left_join(hs0708, attendance %.% filter(schoolyear == '2006_2007',
                                                  grade == 8)
                                       %.% select(sasid, attendance, 
                                                  tardy, suspended))
hs0809 <- left_join(hs0809, attendance %.% filter(schoolyear == '2007_2008',
                                                  grade == 8)
                                       %.% select(sasid, attendance, 
                                                  tardy, suspended))
hs0910 <- left_join(hs0910, attendance %.% filter(schoolyear == '2008_2009',
                                                  grade == 8)
                                       %.% select(sasid, attendance, 
                                                  tardy, suspended))

names(hs0708)[which(names(hs0708) %in% c('suspended'))] <- 'suspend8th'
names(hs0708)[which(names(hs0708) %in% c('tardy'))] <- 'tardy8th'
names(hs0708)[which(names(hs0708) %in% c('attendance'))] <- 'attendance8th'
names(hs0809)[which(names(hs0809) %in% c('suspended'))] <- 'suspend8th'
names(hs0809)[which(names(hs0809) %in% c('tardy'))] <- 'tardy8th'
names(hs0809)[which(names(hs0809) %in% c('attendance'))] <- 'attendance8th'
names(hs0910)[which(names(hs0910) %in% c('suspended'))] <- 'suspend8th'
names(hs0910)[which(names(hs0910) %in% c('tardy'))] <- 'tardy8th'
names(hs0910)[which(names(hs0910) %in% c('attendance'))] <- 'attendance8th'

# Calculate age when student enters 9th grade for the first time.
hs0708 <- mutate(hs0708, overage = age_calc(dob, as.Date('2006-09-01'), 
                                            units='months'))
hs0809 <- mutate(hs0809, overage = age_calc(dob, as.Date('2007-09-01'), 
                                            units='months'))
hs0910 <- mutate(hs0910, overage = age_calc(dob, as.Date('2008-09-01'), 
                                            units='months'))
# Calculate mobility for students
# Eighth Grade year
mobile0607 <-  moves_calc(subset(tables2006_2007$enrollment, 
                                sasid %in% hs0708$sasid & grade == 8))

mobile0607$sasid <- as.character(mobile0607$sasid)
hs0708 <- left_join(hs0708, mobile0607)

mobile0708 <-  moves_calc(subset(tables2007_2008$enrollment, 
                                sasid %in% hs0809$sasid & grade == 8))

mobile0708$sasid <- as.character(mobile0708$sasid)
hs0809 <- left_join(hs0809, mobile0708)

mobile0809 <-  moves_calc(subset(tables2008_2009$enrollment, 
                                sasid %in% hs0910$sasid & grade == 8))

mobile0809$sasid <- as.character(mobile0809$sasid)
hs0910 <- left_join(hs0910, mobile0809)

# Bring in 8th grade performance on standardized tests.
tables2006_2007$achievement$sasid <- as.character(tables2006_2007$achievement$sasid)
tables2006_2007$achievement$studentid <- as.character(tables2006_2007$achievement$studentid)

tables2007_2008$achievement$sasid <- as.character(tables2007_2008$achievement$sasid)
tables2007_2008$achievement$studentid <- as.character(tables2007_2008$achievement$studentid)

tables2008_2009$achievement$sasid <- as.character(tables2008_2009$achievement$sasid)
tables2008_2009$achievement$studentid <- as.character(tables2008_2009$achievement$studentid)


hs0708 <- left_join(hs0708, tables2006_2007$achievement %.% 
                            filter(testgrade_N==8, testgrade_N==grade) %.%
                            dplyr::select(sasid, grade, reaal, reascsc, matal, 
                                          matscsc, testgrade_N, reanormal, 
                                          matnormal))
hs0809 <- left_join(hs0809, tables2007_2008$achievement %.% 
                            filter(testgrade_N==8, testgrade_N==grade) %.%
                            dplyr::select(sasid, grade, reaal, reascsc, matal, 
                                          matscsc, testgrade_N, reanormal, 
                                          matnormal))
hs0910 <- left_join(hs0910, tables2008_2009$achievement %.% 
                            filter(testgrade_N==8, testgrade_N==grade) %.%
                            dplyr::select(sasid, grade, reaal, reascsc, matal, 
                                          matscsc, testgrade_N, reanormal, 
                                          matnormal))

# Attendance normalized
hs0708 <- mutate(hs0708, attendnormal = (attendance8th - 
                                         mean(attendance8th, na.rm=TRUE)) / 
                                        sd(attendance8th, na.rm=TRUE))
hs0809 <- mutate(hs0809, attendnormal = (attendance8th - 
                                         mean(attendance8th, na.rm=TRUE)) / 
                                        sd(attendance8th, na.rm=TRUE))
hs0910 <- mutate(hs0910, attendnormal = (attendance8th - 
                                         mean(attendance8th, na.rm=TRUE)) / 
                                        sd(attendance8th, na.rm=TRUE))

# Current LEP
lep0708 <- subset(tables2006_2007$person_annual,
                  grade == 8)[, c('sasid','lep')]
names(lep0708)[2] <- 'lep8th'
hs0708 <- left_join(hs0708, lep0708)

lep0809 <- subset(tables2007_2008$person_annual,
                  grade == 8)[, c('sasid','lep')]
names(lep0809)[2] <- 'lep8th'
hs0809 <- left_join(hs0809, lep0809)

lep0910 <- subset(tables2008_2009$person_annual,
                  grade == 8)[, c('sasid','lep')]
names(lep0910)[2] <- 'lep8th'
hs0910 <- left_join(hs0910, lep0910)


# GPA in 8th grade calculations
gpa0607 <- tables2006_2007$course %.% 
           filter(grade==8) %.% 
           group_by(sasid) %.% 
           dplyr::summarise(gpa8th = mean(gpa, na.rm=TRUE))
gpa0607$sasid <- as.character(gpa0607$sasid)
hs0708 <- left_join(hs0708, gpa0607)

gpa0708 <- tables2007_2008$course %.% 
           filter(grade==8) %.% 
           group_by(sasid) %.% 
           dplyr::summarise(gpa8th = mean(gpa, na.rm=TRUE))
gpa0708$sasid <- as.character(gpa0708$sasid)
hs0809 <- left_join(hs0809, gpa0708)

gpa0809 <- tables2008_2009$course %.% 
           filter(grade==8) %.% 
           group_by(sasid) %.% 
           dplyr::summarise(gpa8th = mean(gpa, na.rm=TRUE))
gpa0809$sasid <- as.character(gpa0809$sasid)
hs0910 <- left_join(hs0910, gpa0809)

# Course Failures
fails0607 <- tables2006_2007$course %.% 
             filter(grade == 8) %.%
             group_by(sasid, courseno) %.% 
             dplyr::summarise(gpa = mean(gpa, na.rm=TRUE)) %.% 
             filter(gpa <= 1.0) %.% 
             dplyr::summarise(fails = n())

fails0708 <- tables2007_2008$course %.% 
             filter(grade == 8) %.%
             group_by(sasid, courseno) %.% 
             dplyr::summarise(gpa = mean(gpa, na.rm=TRUE)) %.% 
             filter(gpa <= 1.0) %.% 
             dplyr::summarise(fails = n())

fails0809 <- tables2008_2009$course %.% 
             filter(grade == 8) %.%
             group_by(sasid, courseno) %.% 
             dplyr::summarise(gpa = mean(gpa, na.rm=TRUE)) %.% 
             filter(gpa <= 1.0) %.% 
             dplyr::summarise(fails = n())

fails0607$sasid <- as.character(fails0607$sasid)
fails0708$sasid <- as.character(fails0708$sasid)
fails0809$sasid <- as.character(fails0809$sasid)

hs0708 <- left_join(hs0708, fails0607)
hs0708$fails <- with(hs0708, ifelse(is.na(fails) & !is.na(gpa8th), 0, fails))
hs0809 <- left_join(hs0809, fails0708)
hs0809$fails <- with(hs0809, ifelse(is.na(fails) & !is.na(gpa8th), 0, fails))
hs0910 <- left_join(hs0910, fails0809)
hs0910$fails <- with(hs0910, ifelse(is.na(fails) & !is.na(gpa8th), 0, fails))
hscohort <- rbind(hs0708, hs0809, hs0910)
```
## Eighth Grade Model
### Defining the Sample
The goal of each model is to maximize the applicability of the model to maximize the number of future non-graduates as at-risk while minimizing model complexity and overall inaccuracy. The Eighth Grade Model (8GM) for predicting high school readiness uses data from students only collected in the eighth grade year. It is preferable to use only one year of data prior to entering high school to ensure the largest possible sample. Requiring additional years of data will lead to more students with an "incomplete" record containing all of the elements required to predict their probability of graduating. Defining the sample cohort for each model necessarily excludes some students because of incompleteness. 

Each cohort must have enough time to complete high school from eighth grade in order to model graduation probabilities. Our model does not specify graduation as needing to happen "on-time", or 4 years after first entering high school. However, in Providence, few students graduate in 5 or 6 years (reference TK). Therefore, we use three cohorts of students for the 8GM starting with students who enter high school in the 2007-2008 school year (expected graduation 2010-2011) through students who enter high school in the 2010-2011 school year (expected graduation 2012-2013). These are the three most recent cohorts of PPSD graduates [^cohort definition]. 

[cohort definition]: We define the graduating class for each cohort based on the National Governor's Association for cohort-adjusted graduation rates. For example, students who enter PPSD for the first time in 9th grade in the 2007-2008 school year, 10th grade in the 2008-2009 school year, 11th grade in the 2009-2010 school year, and 12th grade in the 2010-2011 school year are all part of the high school 2007-2008 cohort.

In the three most recent cohorts, there were 7,506 students. However, many of these students are excluded from the 8GM. The first exclusion comes from students who did not attend 8th grade in a PPSD school. As a result, these students do not have data from 8th grade available to the district prior to entering high school. 

There are two ways to understand the coverage of the 8GM. First, we want to understand what proportion of all students will the model be based upon. There are three ways students are excluded from the model.

1. Does the 8th grade student attend high school in Providence?
2. Did the student attrite from the data set, e.g. transfer out of the district before recording their ultimate high school outcome?
3. Does the student have a complete set of 8th grade data required by the model?

The first two questions are easily answered prior to model selection, while the third will be specific to each model. In Table 1, we show the proportion of 8th grade students who attend Providence high schools and the proportion of 8th grade students who do not transfer out by cohort.



```{r ExampleTableSource}
cohort0708 <- subset(person, schoolyear_first=='2008_2009' & grade_first==9) %.%
              select(sasid) %.%
              left_join(subset(tables2008_2009$person_annual, 
                               grade==8, select=c('sasid', 'grade')))
prop.table(table(cohort0708$grade, useNA='ifany'))

cohort_gr8 <- subset(tables2008_2009$person_annual, 
                     grade==8, select = 'sasid') %.%
              left_join(subset(person, 
                              (schoolyear_first=='2009_2010' & grade_first==9) | 
                              (schoolyear_first=='2010_2011' & grade_first==10) | 
                              (schoolyear_first=='2011_2012' & grade_first==11) | 
                              (schoolyear_first=='2012_2013' & grade_first==12),
                              select = c('sasid', 'grade_first', 'transfer_out')))
prop.table(table(cohort_gr8$grade_first, useNA='ifany'))

```


| High School Cohort | High School Attendance        || Attrition           || Remaining ||
|                    |  In PPSD (%) | Out of PPSD (%) | Yes (%)     | No (%) |  (%) | (N) |
| :----------        | :-------:    | :-----------:   |  :-----:    | :--:   | :--: | :-: |
| 2007-2008          | 84.2      | 15.8            | 17.3    | 82.7   | 69.7   | 1499 |
| 2008-2009          | 86.6      | 13.4            | 16.7    | 83.3   | 72.1   | 1496 |
| 2009-2010          | 85.2      | 14.8            | 19.9    | 80.1   | 68.2   | 1245 | 

As demonstrated in Table 1, approximately 85% of all 8th grade PPSD students will attend at least some of high school in the district. Therefore, a large portion of these students will remain in the district to benefit from early identification of risk. 

The model for predicting graduation based on 8th grade data is built only with students who attend a Providence Public School as their final high school prior to graduating, dropping out, or transferring to a GED program (non-attrition). These students are excluded because we have no way of knowing whether or not these students ultimately graduate and their graduating is impacted substantially by non-Providence schools. Although they are excluded from the model, we can predict the likelihood that these students will graduate. Because students who are mobile tend to be disproportionately disadvantaged relative to their peers, it is likely that our model for these students is *positively biased*, i.e. these students will have higher probabilities of successfully graduating than is likely true because peers with similar observable characteristics have some unobserved advantages which resulted in being less mobile.

However, we can check to see whether or not students who transfer out are similar across observable characteristics such as race/ethnicity, course failures, grade point average, attendance, within-year school mobility, IEP status, and LEP status. If students who transfer out of PPSD appear similar across all of thes observable characteristics, then we can be less concerned about the positive bias of our estimates for students that transfer out.

```{r TransferCompare}
race <- with(hscohort, as.data.frame(prop.table(table(race, transfer_out), 2)))
race$transfer_out <- ifelse(race$transfer_out=='N', 
                        'Remains in PPSD', 
                        'Transfers Out of PPSD')
raceplot <- ggplot(data = race, aes(race, Freq)) + 
            geom_bar(stat='identity') + 
            geom_text(aes(label=percent(Freq)), vjust=-.4) +
            scale_y_continuous('', labels = percent_format(), limits=c(0, .7)) +
            scale_x_discrete('') +
            theme(axis.text.x = element_text(angle = 45, hjust=1)) +
            ggtitle('Race of Students by Attrition for\n Most Recent Three High School Cohorts') +
            facet_wrap(~transfer_out)

grades <- with(hscohort, as.data.frame(prop.table(table(cut(gpa8th, 
                                                            breaks=seq(0,4,.5)), 
                                                        transfer_out), 2)))
grades$transfer_out <- ifelse(grades$transfer_out=='N', 
                              'Remains in PPSD', 
                              'Transfers Out of PPSD')
names(grades)[1] <- 'GPA'

gpaplot <- ggplot(data = grades, aes(GPA, Freq)) + 
           geom_bar(stat='identity') + 
           geom_text(aes(label=percent(Freq)), vjust=-.4) +
           scale_y_continuous('', labels = percent_format(), limits=c(0, .25)) +
           scale_x_discrete('') +
           theme(axis.text.x = element_text(angle = 45, hjust=1)) +
           ggtitle('GPA of Students by Attrition for\n Most Recent Three High School Cohorts') +
           facet_wrap(~transfer_out)

mobility <- with(hscohort, as.data.frame(prop.table(table(moves, transfer_out), 
                                                    2)))
mobility$transfer_out <- ifelse(mobility$transfer_out=='N', 
                                'Remains in PPSD', 
                                'Transfers Out of PPSD')
mobilityplot <- ggplot(data = mobility, aes(moves, Freq)) + 
                geom_bar(stat='identity') + 
                geom_text(aes(label=percent(Freq)), vjust=-.4) +
                scale_y_continuous('', labels = percent_format(), limits=c(0, 1)) +
                scale_x_discrete('') +
                ggtitle('School Changes in 8th Grade of Students by Attrition for\n Most Recent Three High School Cohorts') +
                facet_wrap(~transfer_out)
```

```{r TransferCompareGraphics, results='asis'}
raceplot
gpaplot
mobilityplot
```

We see several interesting patterns when comparing students who transfer out of PPSD during high school and those who do not. These groups have essentially identical racial makeup, with students transfering out of the district being slightly more likely to be White or Asian ($latex \chi^{2} = 30$, $latex df = 25$, $latex p-value = 0.2243$ suggesting the groups are indistinguishable) . The 8th grade course performance of students who transfer out of PPSD during high school is actually slightly better than those who remain in PPSD. By both of these measures, we find that those who transfer out are either no different or possibly even less disadvantaged than students that remain in PPSD, which is counter to what would have been expected. Mobility shows a slightly different picture, with students who leave PPSD having higher rates of within-school year school mobility, which is not surprising ($latex \chi^{2} = 20$, $latex df = 16$, $latex p-value = 0.2202$ suggesting the groups are indistinguishable). [^allmodels] Based on these findings, we are not concerned about the biases present in providing predicted graduation rates for students even though those who transfer out are excluded from the data set when constructing our models.

[allmodels]: It should be noted that while these patterns are only explored for the 8GM in this section, these same findings hold for all models.

```{r RunModel}
hscohort <- filter(hscohort, transfer_out=='N')
hscohort$schoolyear_first <- as.factor(hscohort$schoolyear_first)
# hscohort$graduated <- ifelse(hscohort$graduated == 'Y', 1, 
#                              ifelse(hscohort$graduated == 'N', 0, NA))
hscohort$graduated <- as.factor(hscohort$graduated)
hscohort <- na.omit(hscohort)
require(doParallel)
workers <- makeCluster(4)
registerDoParallel(workers)
require(caret)
set.seed(101)
trainIndex <- createDataPartition(hscohort$graduated,
                                  p = .8, list=FALSE)
hscohort_train <- hscohort[trainIndex,]
hscohort_test <- hscohort[-trainIndex,]

model.1 <- train(graduated ~ I(attendance8th*10) + gpa8th + matnormal + 
                             reanormal + I(overage>178), 
                 data=hscohort_train,
                 method='glm',
                 tuneLength = 5,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary),
                 metric='ROC')

# model.2 <- train(graduated~ attendnormal + gpa8th + I(ageHS>190) + 
#                             I(schno_first=='164') + + matnormal + reanormal, 
#                  data=hscohort_train,
#                  method='ctree',
#                  tuneLength = 5,
#                  trControl = trainControl(method = "repeatedcv", number = 10,
#                                           repeats = 10, classProbs=TRUE,
#                                           summaryFunction = twoClassSummary),
#                  metric='ROC')
```

### Modeling Methods
The 8GM is constructed using the `caret` package in `R`. This software tools enables us to partition the data set into training and test data, conduct repeated k-fold crossvalidation model fits using different techniques and parameters, and report the predictive properties of the resulting model estimates.

After testing out several specifications, it was found that standard logistic regression with graduation as the outcome and attendance, 8th grade GPA, whether or not a student was overaged when they entered high school, whether or not the first high school a student attended was Classical High School, and NECAP math and reading scaled scores as predictors provided the greatest overall predictive accuracy.

Below, we detail the key statistics from two modeling techinques-- the logistic regression represented by `glm` and the blue line in the Receiver-operator characteristic (ROC) chart and a conditional inference tree represented by `ctree` in the table and the green line in the ROC chart. We then report the parameter and their estimates for the `glm` model which was ultimately chosen for the 8GM.

```{r ModelResamples, results='markup'}
summary(resamples(list(glm = model.1, ctree = model.2)))
```
```{r ROCData, results='asis', fig.width=7, fig.height=7}
roc_lm <- roc(hscohort_test$graduated, 
              predict(model.1, newdata=hscohort_test, type='prob')$Y, 
              auc=TRUE, ci=TRUE)

roc_ctree <- roc(hscohort_test$graduated, 
                 predict(model.2, newdata=hscohort_test, type='prob')$Y)

rocobj1 <- plot.roc(roc_lm, 
                    main="Comparing glm and ctree models for 8GM",
                    col="#1c61b6", 
                    print.auc=TRUE, 
                    legacy.axes=TRUE)
rocobj2 <- lines.roc(roc_ctree, col="#008600")  
testobj <- roc.test(rocobj1, rocobj2)  
text(0.5, 0.1, labels=paste("p-value =", format.pval(testobj$p.value)), adj=c(0, .5))  
legend("bottomright", legend=c("glm", "ctree"), col=c("#1c61b6", "#008600"), lwd=2)
```
```{r 8GMParam, results='asis'}
sjp.glm(model.1$finalModel, 
        title = 'Eighth Grade Model Parameter Estimates',
        showModelSummary = FALSE)
```

### Classification Methods
Students with predicted probabilities that are different by only a few percent do not actually represent different levels of risk for not graduating. School leaders, guidance counselors, teachers, parents, and students are likely to misinterpret the direct probabilities produced by a logistic regression. When predicting "membership to a class", e.g. will this student graduate or not, does the patient have cancer or not, we can group similar probabilities into levels of risk that more clearly indicate whether or not immediate action is required.

The Rhode Island Department of Education has also been developing predictive models that seek to determine the probability that students will graduate. They have set three threshold levels for cutoffs based on the *true negative rate*. The true negative rate is the proportion of students that would be classified as not graduating in the model who ultimately fail to graduate over all non-graduates. It descrbies the percentage of students does the model correctly classify as not graduating. They have chosen three cutoffs that we will use here: 80% true negative rate for *high* risk, 70% true negative rate for *moderate* risk, and 60% true negative rate for *low* risk.

```{r, CutOffMatrix8GM}
hscohort_train$predict8th <- predict(model.1, 
                                     newdata = hscohort_train, 
                                     type = 'prob')$Y
m1_matrix <- cutoff_matrix(hscohort_train, 'predict8th', 'graduated')
thresholds <- data.frame(classification = as.factor(c('Watch', 
                                                      'Warning', 'Action')),
  threshold = c(m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .6)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .7)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .8)),]$cutoff))

# Compute coverage: what proportion of those who fail to graduate are identified
thresholds$coverage <- NA
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predict8th <= subset(thresholds, 
                                     classification=='Action')$threshold))
thresholds[thresholds$classification == 'Action', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predict8th <= subset(thresholds, 
                                     classification=='Warning')$threshold))
thresholds[thresholds$classification == 'Warning', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predict8th <= subset(thresholds, 
                                     classification=='Watch')$threshold))
thresholds[thresholds$classification == 'Watch', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
thresholds$coverage <- round(thresholds$coverage, digits=1)
```

For the 8GM, our thresholds can be seen in the table below.

```{r ThresholdTablePrint, results='asis'}
require(xtable)
print(xtable(thresholds), type="html", include.rownames=FALSE)
```

### Disaggregated Results

Although many demographic characteristics are not present in the model, this is not because all groups of students are served equally well. The following figures examine the classification of students by groupings such as race, free or reduced price lunch, special education status, and limited English proficiency. These data look at the incoming high school freshman in the fall of 2012 using the 8GM.

```{r NewestCohort8th}
hs1213 <- subset(person, schoolyear_first=='2013' & grade_first==9)
hs1112 <- subset(person, schoolyear_first=='2012' & grade_first==9)

hs1213$sasid <- as.character(hs1213$sasid)
hs1112$sasid <- as.character(hs1112$sasid)

hs1213 <- left_join(hs1213, attendance %.% filter(schoolyear == '2011_2012',
                                                  grade == 8)
                                       %.% select(sasid, attendance, 
                                                  tardy, suspended))
names(hs1213)[which(names(hs1213) %in% c('suspended'))] <- 'suspend8th'
names(hs1213)[which(names(hs1213) %in% c('tardy'))] <- 'tardy8th'
names(hs1213)[which(names(hs1213) %in% c('attendance'))] <- 'attendance8th'

hs1112 <- left_join(hs1112, attendance %.% filter(schoolyear == '2010_2011',
                                                  grade == 8)
                                       %.% select(sasid, attendance, 
                                                  tardy, suspended))
names(hs1112)[which(names(hs1112) %in% c('suspended'))] <- 'suspend8th'
names(hs1112)[which(names(hs1112) %in% c('tardy'))] <- 'tardy8th'
names(hs1112)[which(names(hs1112) %in% c('attendance'))] <- 'attendance8th'


hs1213 <- mutate(hs1213, ageHS = age_calc(dob, as.Date('2012-09-01'), 
                                          units='months'))
hs1112 <- mutate(hs1112, ageHS = age_calc(dob, as.Date('2011-09-01'), 
                                          units='months'))

mobile1213 <-  moves_calc(subset(tables2011_2012$enrollment, 
                                 sasid %in% hs1213$sasid & grade == 8))
mobile1112 <-  moves_calc(subset(tables2010_2011$enrollment, 
                                 sasid %in% hs1112$sasid & grade == 8))

mobile1213$sasid <- as.character(mobile1213$sasid)
mobile1112$sasid <- as.character(mobile1112$sasid)
hs1213 <- left_join(hs1213, mobile1213)
hs1112 <- left_join(hs1112, mobile1112)


tables2011_2012$achievement$sasid <- as.character(tables2011_2012$achievement$sasid)
tables2011_2012$achievement$studentid <- as.character(tables2011_2012$achievement$studentid)
tables2010_2011$achievement$sasid <- as.character(tables2010_2011$achievement$sasid)
tables2010_2011$achievement$studentid <- as.character(tables2010_2011$achievement$studentid)

hs1213 <- left_join(hs1213, tables2011_2012$achievement %.% 
                            filter(testgrade_N==8, testgrade_N==grade) %.%
                            select(sasid, grade, reaal, reascsc, matal, matscsc,
                                   testgrade_N, reanormal, matnormal))
hs1213 <- mutate(hs1213, attendnormal = (attendance8th - 
                                         mean(attendance8th, na.rm=TRUE)) / 
                                         sd(attendance8th, na.rm=TRUE))
hs1112 <- left_join(hs1112, tables2010_2011$achievement %.% 
                            filter(testgrade_N==8, testgrade_N==grade) %.%
                            select(sasid, grade, reaal, reascsc, matal, matscsc,
                                   testgrade_N, reanormal, matnormal))
hs1112 <- mutate(hs1112, attendnormal = (attendance8th - 
                                         mean(attendance8th, na.rm=TRUE)) / 
                                         sd(attendance8th, na.rm=TRUE))



gpa1112 <- tables2011_2012$course %.% 
           filter(grade==8) %.% 
           group_by(sasid) %.% 
           summarise(gpa8th = mean(gpa, na.rm=TRUE))
gpa1112$sasid <- as.character(gpa1112$sasid)
hs1213 <- left_join(hs1213, gpa1112)
gpa1011 <- tables2010_2011$course %.% 
           filter(grade==8) %.% 
           group_by(sasid) %.% 
           summarise(gpa8th = mean(gpa, na.rm=TRUE))
gpa1011$sasid <- as.character(gpa1011$sasid)
hs1112 <- left_join(hs1112, gpa1011)

# Longest attended middle school.
findLongestMiddleSchool <- function(df){
  # This mimics the select_hs() function but for middle schools.
  ms <- df %.%
        filter(grade %in% seq(7, 8, 1)) %.%
        group_by(sasid, schno, school) %.%
        summarize(total_adm = sum(adm))
  ms <- ungroup(ms) %.%
        group_by(sasid) %.%
        filter(total_adm == max(total_adm)) %.%
        select(sasid, schno, school)
  # At this point, MS should have the right school. However, there could be more
  # than one school with the same number of enrollment days. So the next step
  # merges in the school year and selects the max school year.
  ms <- left_join(ms,  df %.% select(sasid, schno, schoolyear))
  ms <- ms %.%
        group_by(sasid) %.%
        filter(row_number(desc(schoolyear))==1) %.%
        select(sasid, schno, school)
  names(ms)[-1] <- paste(names(ms)[-1], 'ms_long', sep='_')
  ms
}
hs1112 <- left_join(hs1112, findLongestMiddleSchool(all_years_enr))
hs1213 <- left_join(hs1213, findLongestMiddleSchool(all_years_enr))

hs_new <- rbind(hs1213, hs1112)
hs_new <- na.omit(hs_new)
hs_new$prediction <- predict(model.1, newdata=hs_new, type='prob')$Y
hs_new$classification <- cut(hs_new$prediction, 
                             breaks=rev(c(1, thresholds$threshold, 0)), 
                             include.lowest=TRUE, 
                             labels=rev(c('On-track', 
                                        as.character(thresholds$classification))))
hs_new$classification <- factor(hs_new$classification, 
                                levels = rev(levels(hs_new$classification)), 
                                ordered=TRUE)
```
#### Race
```{r RacePic, results='asis'}
race <- as.data.frame(with(hs_new, prop.table(table(race, classification), 1)))
race_n <- as.data.frame(with(hs_new, table(race, classification)))
race_seq <- race %.%
            filter(classification == 'On-track') %.%
            arrange(Freq)
race$race <- factor(race$race,
                    levels = race_seq$race)
race <- filter(race, race != 'Pacific Islander') # n-size exclusion
race_n <- filter(race_n, race != 'Pacific Islander') # n-size exclusion
names(race_n)[ncol(race_n)] <- 'n'
race <- left_join(race, race_n)

ggplot(race, aes(race, Freq, fill = classification)) + 
geom_bar(stat = 'identity', position = 'stack') + 
geom_text(aes(label = n, y = Freq, ymax = 1), 
          position = 'stack',
          vjust = 1.66,
          fontface = 'bold',
          color = '#3f4c55')+ 
scale_y_continuous('', labels = percent_format(), breaks=seq(0,1,.1)) +
scale_x_discrete('') +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
ggtitle('Incoming 9th Grade Classes of 2012 and 2013 Risk Levels')
```
The figure above shows the classification of incoming ninth graders in the fall of 2012 and 2013 disaggregated by race. A smaller proportion of Black and Hispanic students enter high school on-track, although the gap between these students and their White peers is less than 10 percentage points.

#### Suspension
```{r SuspendPic, results='asis', fig.height=7, fig.width=7}
suspension <- as.data.frame(with(hs_new, prop.table(table(suspend8th>0,classification),1)))
names(suspension)[1] <- 'suspension'
suspension$suspension <- as.factor(suspension$suspension)
levels(suspension$suspension) <- c('Has not been suspended', 
                                   'Suspended one or more times')

ggplot(suspension, aes(suspension, Freq, fill=classification)) + 
geom_bar(stat='identity', position='stack') + 
scale_y_continuous('', labels = percent_format(), breaks=seq(0,1,.1)) +
scale_x_discrete('') +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
ggtitle('Incoming 9th Grade Classes of 2012 and 2013 Risk Levels')
```
Whether or not a student is suspended even one time leads to substantial separation between on- and off-track students. Nearly 40% of students with one or more suspensions are in the highest risk category compared to around 7% of those who have never been suspended. However, there is a wide range in number of suspension incidents from 0 to 62.

```{r SuspendPic2, results='asis'}
suspend_labels <- c('None', as.character(seq(1,7,1)), '8 or more')
suspension <- as.data.frame(prop.table(table(cut(hs_new$suspend8th, 
                                                 breaks = c(seq(0, 8, 1), 1000),
                                                 include.lowest = TRUE, 
                                                 labels = suspend_labels,
                                                 right = FALSE), 
                                             hs_new$classification),
                                       1))
names(suspension) <- c('suspensions', 'classification', 'Freq')
ggplot(suspension, aes(suspensions, Freq, fill=classification)) + 
geom_bar(stat='identity', position='stack') + 
scale_y_continuous('', labels = percent_format(), breaks=seq(0,1,.1)) +
scale_x_discrete('') +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
ggtitle('Incoming 9th Grade Classes of 2012 and 2013 Risk Levels')
```
The relationship between number of days suspended and likelihood to graduate is clear-- the more times a student is suspended, the more likely it is that they fall into an at-risk classification.

#### Mobility
```{r MovesPic, results='asis', fig.height=7, fig.width=7}
moves <- as.data.frame(with(hs_new, prop.table(table(cut(moves, 
                                                         breaks = c(0,1,2,10),
                                                         include.lowest = TRUE,
                                                         labels = c('None',
                                                                    'One',
                                                                    'Two or more'),
                                                         right=FALSE),
                                                     classification),1)))
ggplot(moves, aes(Var1, Freq, fill=classification)) + 
geom_bar(stat='identity', position='stack') + 
scale_y_continuous('', labels = percent_format(), breaks=seq(0,1,.1)) +
scale_x_discrete('Number of school changes in 8th grade') +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
ggtitle('Incoming 9th Grade Classes of 2012 and 2013 Risk Levels')
```

#### Sorting by School
Students that are on-track are not evenly distributed among either sending middle schools or recieving high schools. When reviewing this data, it is critical to understand that this data does not suggest that some middle schools are better or worse at preparing students for high school. Because of differences in school composition and their own incoming classes from elementary to middle school, these data are not sufficient to make any claims about middle school efficacy. However, the stark differences in preparedness by middle school, and subsequently, receiving high schools, have important policy implications.

#### Sending Middle School
```{r MSSchoolLong, results='asis', fig.height=8.2, fig.width=10}
school_ms <- as.data.frame(with(hs_new, 
                                prop.table(table(schno_ms_long, 
                                                 classification), 1)))
school_ms <- na.omit(school_ms)
#school_ms <- filter(school_ms,
#                            !schno_first %in% c('185', '147'))
#school_lookup <- unique(hs_new[, c('schno_ms_long', 'school_ms_long')])
#school_lookup$schno_ms_long <- as.character(school_lookup$schno_ms_long)
#school_ms$schno_ms_long <- as.character(school_ms$school_ms_long)
school_lookup <- data.frame(schno_ms_long = as.character(c(143, 126, 145, 
                                                           137, 144, 147, 
                                                           172, 114)), 
                            school_ms_long = c('Bishop', 'DelSesto', 'Greene', 
                                               'Hopkins', 'Stuart', 'Williams', 
                                               'Bridgham', 'Times 2'))

school_ms <- left_join(school_ms, school_lookup)
school_ms_seq <- school_ms %.%
                 filter(classification == 'On-track') %.%
                 arrange(Freq)
school_ms$school_ms_long <- factor(school_ms$school_ms_long,
                                   levels = school_ms_seq$school_ms_long)
ggplot(na.omit(school_ms), aes(school_ms_long, Freq, fill=classification)) + 
geom_bar(stat='identity', position='stack') + 
scale_y_continuous('', 
                   labels = percent_format(), 
                   breaks = seq(0,1,.1),
                   limits = c(0, 1.05),
                   expand = c(0, 0)) +
scale_x_discrete('Middle school attended longest',
                 labels = substr(x=levels(school_ms$school_ms_long), 1, 13)) +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
theme(axis.text.x = element_text(angle=90)) +
ggtitle('Incoming 9th Grade Classes of 2012 and 2013 Risk Levels')


```

#### Receiving High School
```{r SchoolsPic, results='asis', fig.height=8.2, fig.width=10}
hs_new$schno_first <- with(hs_new, 
                           ifelse(as.character(schno_first) %in% c('181', '183'),
                                  '149', as.character(schno_first)))

school_first_data <- as.data.frame(with(hs_new, 
                                        prop.table(table(schno_first, 
                                                         classification), 1)))
school_first_data <- na.omit(school_first_data)
school_first_data <- filter(school_first_data,
                            !schno_first %in% c('185', '147', '114'))
# school_first_data$schno_first <- with(school_first_data, 
#                                       ifelse(as.character(schno_first) %in% 
#                                                c('181', '183'),
#                                              '149', as.character(schno_first)))
school_lookup <- 
  data.frame(schno_first = as.character(unique(school_first_data$schno_first)),
             school_first = c('Times 2', 'Birch', 'Central', 'Hope', 
                              'Mount Pleasant', 'Classical', 'E-Cubed',
                              'Alvarez', 'Sanchez', 'ACES', 'Career & Tech'),
             stringsAsFactors=FALSE)
school_first_data$schno_first <- as.character(school_first_data$schno_first)
school_first_data <- left_join(school_first_data, school_lookup)
school_seq <- school_first_data %.%
              filter(classification == 'On-track') %.%
              arrange(Freq)
school_first_data$school_first <- factor(school_first_data$school_first,
                                         levels=school_seq$school_first)
ggplot(school_first_data, aes(school_first, Freq, fill=classification)) + 
geom_bar(stat='identity', position='stack') + 
scale_y_continuous('', 
                   labels = percent_format(), 
                   breaks = seq(0,1,.1),
                   limits = c(0, 1.05),
                   expand = c(0, 0)) +
scale_x_discrete('High school first attended',
                 labels = substr(x=levels(school_first_data$school_first), 1, 13)) +
scale_fill_manual('',
                  values=c('#0571B0', '#FFCC00', '#FF9942', '#CA0020'),
                  breaks=c('Action', 'Warning', 'Watch', 'On-track')) +
theme(axis.text.x = element_text(angle=90)) +
ggtitle('Incoming 9th Grade Classes of 2012 and 2013 Risk Levels')
```
### The Importance of Middle to High School Transitions
The Providence Personal Graduation Plan is used from grades 6 through 12. It is critical that we update our classification of risk periodically to ensure that resources are focused on the right students. The 8GM provides powerful insight into the readiness of students entering high school. By using data from before the start of 9th grade, we can work to ensure that students with the highest needs are provided with extra supports from the first day of high school, rather than wait for later indicators of falling behind.

Extensive research on the middle to high school transition suggests that after entering ninth grade, we may see a reshuffling of students at risk. Researchers at the Consortium on Chicago School Research have found that ninth grade performance data is so critical that most data available about students prior to high school is no longer useful in predicting high school success once this data is considered (http://ccsr.uchicago.edu/publications/what-matters-staying-track-and-graduating-chicago-public-schools).

With the 8GM we hope to inspire action to intervene with the highest need students immediately upon the start of high school (and perhaps the summer before entering high school). For this reason, and because of the research body pointing to the importance of transitioning to high school, we were motivated to see if we can re-classify students after just the first quarter of high school is complete. Building on the CCSR research, we chose to examine whether quarter 1 course performance can distinguish between students who are classified as having the same risk level based on the 8GM but ultimately have different graduation outcomes.

```{r Qtr19th}
gpa_qtr1_0708 <- tables2007_2008$course %.% 
                 filter(grade == 9 & 
                        sasid %in% 
                        subset(hscohort, 
                               schoolyear_first=='2007_2008' & 
                               grade_first==9)$sasid) %.% 
                 group_by(sasid, variable) %.% 
                 summarize(gpa_qtr1_9th = mean(gpa, na.rm=TRUE)) %.%
                 filter(variable == 'cum_qtr1') %.%
                 select(sasid, gpa_qtr1_9th)
gpa_qtr1_0809 <- tables2008_2009$course %.% 
                 filter(grade == 9 & sasid %in%
                        subset(hscohort, 
                               schoolyear_first=='2008_2009' & 
                               grade_first==9)$sasid) %.% 
                 group_by(sasid, variable) %.% 
                 summarize(gpa_qtr1_9th = mean(gpa, na.rm=TRUE)) %.%
                 filter(variable == 'cum_qtr1') %.%
                 select(sasid, gpa_qtr1_9th)
gpa_qtr1_0910 <- tables2009_2010$course %.% 
                 filter(grade == 9 & sasid %in% 
                        subset(hscohort, 
                               schoolyear_first=='2009_2010' & 
                               grade_first==9)$sasid) %.% 
                 group_by(sasid, variable) %.% 
                 summarize(gpa_qtr1_9th = mean(gpa, na.rm=TRUE)) %.%
                 filter(variable == 'cum_qtr1') %.%
                 select(sasid, gpa_qtr1_9th)

# First Quarter Course Failures
fails_qtr1_0708 <- tables2007_2008$course %.% 
                   filter(grade == 9 & sasid %in% hscohort$sasid) %.%
                   group_by(sasid, variable, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0 & variable == 'cum_qtr1') %.% 
                   summarize(fails_qtr1 = n())

fails_qtr1_0809 <- tables2008_2009$course %.% 
                   filter(grade == 9 & sasid %in% hscohort$sasid & 
                          !sasid %in% gpa_qtr1_0708) %.%
                   group_by(sasid, variable, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0 & variable == 'cum_qtr1') %.% 
                   summarize(fails_qtr1 = n())

fails_qtr1_0910 <- tables2009_2010$course %.% 
                   filter(grade == 9 & sasid %in% hscohort$sasid &
                          !sasid %in% gpa_qtr1_0809) %.%
                   group_by(sasid, variable, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0 & variable == 'cum_qtr1') %.% 
                   summarize(fails_qtr1 = n())

hscohort_train <- left_join(hscohort_train, 
                      rbind(gpa_qtr1_0708, gpa_qtr1_0809, gpa_qtr1_0910) %.%
                      select(sasid, gpa_qtr1_9th))

hscohort_train <- left_join(hscohort_train, 
                      rbind(fails_qtr1_0708, fails_qtr1_0809, 
                            fails_qtr1_0910) %.%
                      select(sasid, fails_qtr1))

hscohort_test <- left_join(hscohort_test, 
                      rbind(gpa_qtr1_0708, gpa_qtr1_0809, gpa_qtr1_0910) %.%
                      select(sasid, gpa_qtr1_9th))

hscohort_test <- left_join(hscohort_test, 
                      rbind(fails_qtr1_0708, fails_qtr1_0809, 
                            fails_qtr1_0910) %.%
                      select(sasid, fails_qtr1))

hscohort_train$classification <-
  cut(hscohort_train$predict8th, 
      breaks=rev(c(1, thresholds$threshold, 0)), include.lowest=TRUE, 
      labels=rev(c('On-track', as.character(thresholds$classification))))
hscohort_train$classification <- 
  factor(hscohort_train$classification, 
         levels = rev(levels(hscohort_train$classification)), 
         ordered=TRUE)
```

```{r Qtr1Fails, results='asis', fig.height=8.2, fig.width=10}
levels(hscohort_train$graduated) <- c('Did not graduate', 'Graduated')
box_quant <- function(x, ...){
  y <- median(x, na.rm=TRUE)
  minmax <- quantile(x, ..., na.rm=TRUE)
  result <- data.frame(y = y,
                       ymin = minmax[1],
                       ymax = minmax[2],
                       row.names = NULL)
  result
}
ggplot(data=hscohort_train, 
       aes(classification, gpa_qtr1_9th, color=graduated)) +
stat_summary(fun.data="box_quant", probs=c(0.25, 0.75), geom='pointrange', 
             position = position_dodge(width = 0.5), size=1.5) +
scale_x_discrete('Eighth Grade Model Classification') +
scale_y_continuous('Quarter 1 GPA, 9th Grade',
                   breaks = seq(0, 4, .5), 
                   limits = c(0,4)) +
scale_color_manual('',
                   values = c('Did not graduate' = '#CA0020', 
                              'Graduated' = '#0571B0')) +
ggtitle('First Quarter Performance in 9th Grade Impacts Graduation') +
theme(legend.position = c(0.9, 0.9),
      legend.background = element_rect(fill = "transparent"))
  
```
We find that students who are classified at the same level of readiness by the 8GM who ultimately graduate perform markedly better in their courses in the first quarter of 9th grade as compared to their peers who do not graduate. The figure above separates students by their 8GM classification along the x-axis and colors those students who do graduate blue and those who do not red. The point represents the median first quarter GPA for that group, with the lines extending to the 25th and 75th percentile. Notably, students who enter high school "On-track" and fail to graduate slightly outperform those students who are in "Warning" and "Action" that ultimately graduate. 

We believe this figure is a stark demonstration of the key role the middle to high school transition plays. Students who underperform *relative to their potential* in just the first 45 days of high school ultimately fail to graduate, while those who are succesful go on to complete high school.

Based on this exploratory analysis and the research of others, we developed a new predictive model that incorporates the elements of the 8GM and adds the first quarter 9th grade GPA. We found that we could exclude the results on the 8th grade NECAP for both reading and mathematics as well as whether or not a student attended Classical High School once we include 9th grade GPA and the result is still a substantially better fit model. Similar to the findings in Chicago, we find that the number of course failures also improves the model, above and beyond just using quarter 1 GPA. Our new model with both 9th grade quarter 1 GPA and the number of courses failed in quarter 1, but excluding whether or not a student attends Classical and state test results from grade 8 will be known as QTR1.

```{r Qtr19thModel}
levels(hscohort_train$graduated) <- c('N', 'Y')
hscohort_train <- na.omit(hscohort_train)

model.orig <- train(graduated ~ attendnormal + gpa8th + I(ageHS>190) + 
                                I(schno_first=='164') + matnormal + reanormal, 
                 data=hscohort_train,
                 method='glm',
                 tuneLength = 5,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary),
                 metric='ROC')

model.qtr1 <- train(graduated ~ attendnormal + gpa8th + I(ageHS>190) +  
                                gpa_qtr1_9th + fails_qtr1, 
                 data=hscohort_train,
                 method='glm',
                 tuneLength = 5,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary),
                 metric='ROC')
```

```{r ROCPlotsQtr1, results='asis', fig.width=7, fig.height=7}
hscohort_test <- na.omit(hscohort_test)
roc_orig <- roc(hscohort_test$graduated, 
              predict(model.orig, newdata=hscohort_test, type='prob')$Y, 
              auc=TRUE, ci=TRUE)

roc_qtr1 <- roc(hscohort_test$graduated, 
                 predict(model.qtr1, newdata=hscohort_test, type='prob')$Y,
                auc=TRUE, ci=TRUE)

rocobj1 <- plot.roc(roc_qtr1, 
                    main="Comparing Original 8GM to Updated Quarter 1 Model",
                    col="#1c61b6",
                    print.auc=TRUE,
                    legacy.axes=TRUE)
rocobj2 <- lines.roc(roc_orig, col="#008600")  
testobj <- roc.test(rocobj1, rocobj2)  
text(0.5, 0.1, labels=paste("p-value =", format.pval(testobj$p.value)), adj=c(0, .5))  
legend("bottomright", legend=c("8GM + Qtr1", "8GM"), col=c("#1c61b6", "#008600"), lwd=2)
```
Above is a comparison between the ROC for the 8GM (in green) and QTR1 (in blue) models. For the 8GM, $latex AUC = 0.786 (\pm0.0369)$ while for the improved QTR1 model $latex AUC = 0.8249 (\pm0.0333$.
```{r ParamQtr1, results='asis'}
sjp.glm(model.qtr1$finalModel)
```
Students with a GPA one letter grade higher in the first quarter of 9th grade are 1.8 times more likely to graduate. Each course failure is associated with being 0.82 times as likely to graduate.

These findings confirm the exploratory analysis demonstrating the impact of quarter 1 course performance and closely follow the findings in Chicago that ninth grade course performance can supersede previously important covariates for predicting high school graduation.

```{r, CutOffMatrixQTR}
hscohort_train$predictqtr1 <- predict(model.qtr1, 
                                      newdata = hscohort_train, 
                                      type = 'prob')$Y
m1_matrix <- cutoff_matrix(hscohort_train, 'predictqtr1', 'graduated')
thresholds <- data.frame(classification = as.factor(c('Watch', 
                                                      'Warning', 'Action')),
  threshold = c(m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .6)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .7)),]$cutoff,
                m1_matrix[which.min(abs(m1_matrix$true_neg_rate - .8)),]$cutoff))

# Compute coverage: what proportion of those who fail to graduate are identified
thresholds$coverage <- NA
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predictqtr1 <= subset(thresholds, 
                                     classification=='Action')$threshold))
thresholds[thresholds$classification == 'Action', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predictqtr1 <= subset(thresholds, 
                                     classification=='Warning')$threshold))
thresholds[thresholds$classification == 'Warning', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
coverage <- as.data.frame(table(
  hscohort_train$graduated, 
  hscohort_train$predictqtr1 <= subset(thresholds, 
                                     classification=='Watch')$threshold))
thresholds[thresholds$classification == 'Watch', ]$coverage <- 
  coverage[coverage$Var2==TRUE & coverage$Var1 == 'N', 'Freq'] / 
  sum(coverage[coverage$Var1 == 'N', ]$Freq)
thresholds$coverage <- round(thresholds$coverage, digits=3)
```
We use the same method as with the 8GM to produce new thresholds for our classifications based on the QTR1 model, seen below.
```{r QTRThresholdTablePrint, results='asis'}
require(xtable)
print(xtable(thresholds), type="html", include.rownames=FALSE)
```
One way to see the vast improvement that 9th grade quarter 1 course performance data provides is by examining the coverage in each classification. Whereas the 8GM identified approximately 36% of all non-graduates in the "Action" category, 54.9% are captured in QTR1. Students who are at "Warning" or "Action" together represent 76.8% of all non-graduates, and 91.2% of all non-graduates are labeled as off-track by the QTR1.

Based on these thresholds, we can classify the most recent two freshman classes just as we did when analyzing the 8GM. We would like to see what proportion of students change classification after quarter 1 in 9th grade. Those students who move to less severe risk levels have already demonstrated they are getting back on track. We also expect to see some students move to more severe risk categories, demonstrating that their transition to high school was less successful and they are falling further behind.

```{r Qtr1Classification}
# Classify Training
hscohort_train$classificationqtr1 <- 
  cut(hscohort_train$predictqtr1, breaks=rev(c(1, thresholds$threshold, 0)), 
      include.lowest=TRUE, 
      labels=rev(c('On-track', as.character(thresholds$classification))))
hscohort_train$classificationqtr1 <-
  factor(hscohort_train$classificationqtr1, 
         levels = rev(levels(hscohort_train$classificationqtr1)), ordered=TRUE)

gpa_qtr1_1213 <- tables2012_2013$course %.% 
                 filter(grade == 9 & sasid %in% hs1213$sasid) %.% 
                 group_by(sasid, variable) %.% 
                 summarize(gpa_qtr1_9th = mean(gpa, na.rm=TRUE)) %.%
                 filter(variable == 'cum_qtr1') %.%
                 select(sasid, gpa_qtr1_9th)
gpa_qtr1_1112 <- tables2011_2012$course %.% 
                 filter(grade == 9 & sasid %in% hs1112$sasid) %.% 
                 group_by(sasid, variable) %.% 
                 summarize(gpa_qtr1_9th = mean(gpa, na.rm=TRUE)) %.%
                 filter(variable == 'cum_qtr1') %.%
                 select(sasid, gpa_qtr1_9th)
fails_qtr1_1213 <- tables2012_2013$course %.% 
                   filter(grade == 9 & sasid %in% hs1213$sasid) %.%
                   group_by(sasid, variable, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0 & variable == 'cum_qtr1') %.% 
                   summarize(fails_qtr1 = n())
fails_qtr1_1112 <- tables2011_2012$course %.% 
                   filter(grade == 9 & sasid %in% hs1112$sasid) %.%
                   group_by(sasid, variable, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0 & variable == 'cum_qtr1') %.% 
                   summarize(fails_qtr1 = n())
gpa_qtr1_new <- rbind(gpa_qtr1_1112, gpa_qtr1_1213)
gpa_qtr1_new$sasid <- as.character(gpa_qtr1_new$sasid)
hs_new <- left_join(hs_new, 
                    gpa_qtr1_new %.%
                    select(sasid, gpa_qtr1_9th))
fails_qtr1_new <- rbind(fails_qtr1_1112, fails_qtr1_1213)
fails_qtr1_new$sasid <- as.character(fails_qtr1_new$sasid)
hs_new <- left_join(hs_new, 
                    fails_qtr1_new %.%
                    select(sasid, fails_qtr1))
hs_new <- na.omit(hs_new)
hs_new$predictqtr1 <- predict(model.qtr1, newdata=hs_new, type='prob')$Y
hs_new$classificationqtr1 <- cut(hs_new$predictqtr1, 
                             breaks=rev(c(1, thresholds$threshold, 0)), 
                             include.lowest=TRUE, 
                             labels=rev(c('On-track', 
                                        as.character(thresholds$classification))))
hs_new$classificationqtr1 <- factor(hs_new$classificationqtr1, 
                                levels = rev(levels(hs_new$classificationqtr1)), 
                                ordered=TRUE)
```

```{r Qtr1ChangeClass}
heatmap <- as.data.frame(with(hs_new, 
                              table(classification, classificationqtr1)))
ggplot(data = heatmap, aes(classification, classificationqtr1, fill=Freq)) +
geom_tile() +
scale_fill_gradient(low="#EFF3FF", high="#08519C") +
geom_text(aes(fill = heatmap$Freq, label = heatmap$Freq))
```