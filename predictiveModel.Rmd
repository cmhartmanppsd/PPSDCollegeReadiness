Pathways to Graduation
========================================================

```{r Initialization, echo=FALSE, results='hide'}
setwd('/Users/jason/Dropbox/code/PPSDCollegeReadiness/')
source('dependencies.R')
require(sjPlot)
file.sources = list.files('/Users/jason/Dropbox/code/PPSDCollegeReadiness/R', 
                          pattern='*.R$', full.names=TRUE, ignore.case=TRUE)
invisible(sapply(file.sources, source, .GlobalEnv))
invisible(source('load.R'))
invisible(source('buildTables.R'))
invisible(source('person.R'))
invisible(source('attendance.R'))
attendance$sasid <- as.character(attendance$sasid)
```

```{r PredictiveModelData}
# Build cohort for predictive model
hs0708 <- subset(person, (schoolyear_first=='2007_2008' & grade_first==9) | 
                         (schoolyear_first=='2008_2009' & grade_first==10) | 
                         (schoolyear_first=='2009_2010' & grade_first==11) | 
                         (schoolyear_first=='2010_2011' & grade_first==12))
hs0809 <- subset(person, (schoolyear_first=='2008_2009' & grade_first==9) | 
                         (schoolyear_first=='2009_2010' & grade_first==10) | 
                         (schoolyear_first=='2010_2011' & grade_first==11) | 
                         (schoolyear_first=='2011_2012' & grade_first==12))
hs0910 <- subset(person, (schoolyear_first=='2009_2010' & grade_first==9) | 
                         (schoolyear_first=='2010_2011' & grade_first==10) | 
                         (schoolyear_first=='2011_2012' & grade_first==11) | 
                         (schoolyear_first=='2012_2013' & grade_first==12))
hs0708$sasid <- as.character(hs0708$sasid)
hs0809$sasid <- as.character(hs0809$sasid)
hs0910$sasid <- as.character(hs0910$sasid)

hs0708 <- left_join(hs0708, attendance %.% filter(schoolyear == '2006_2007')
                                       %.% dplyr::select(sasid, attendance, 
                                                         tardy, suspended))
hs0809 <- left_join(hs0809, attendance %.% filter(schoolyear == '2007_2008')
                                       %.% dplyr::select(sasid, attendance, 
                                                         tardy, suspended))
hs0910 <- left_join(hs0910, attendance %.% filter(schoolyear == '2008_2009')
                                       %.% dplyr::select(sasid, attendance, 
                                                         tardy, suspended))

names(hs0708)[which(names(hs0708) %in% c('suspended'))] <- 'suspend8th'
names(hs0708)[which(names(hs0708) %in% c('tardy'))] <- 'tardy8th'
names(hs0708)[which(names(hs0708) %in% c('attendance'))] <- 'attendance8th'
names(hs0809)[which(names(hs0809) %in% c('suspended'))] <- 'suspend8th'
names(hs0809)[which(names(hs0809) %in% c('tardy'))] <- 'tardy8th'
names(hs0809)[which(names(hs0809) %in% c('attendance'))] <- 'attendance8th'
names(hs0910)[which(names(hs0910) %in% c('suspended'))] <- 'suspend8th'
names(hs0910)[which(names(hs0910) %in% c('tardy'))] <- 'tardy8th'
names(hs0910)[which(names(hs0910) %in% c('attendance'))] <- 'attendance8th'

# Calculate age when student enters 9th grade for the first time.
hs0708 <- mutate(hs0708, ageHS = age_calc(dob, as.Date('2007-09-01'), 
                                          units='months'))
hs0809 <- mutate(hs0809, ageHS = age_calc(dob, as.Date('2008-09-01'), 
                                          units='months'))
hs0910 <- mutate(hs0910, ageHS = age_calc(dob, as.Date('2009-09-01'), 
                                          units='months'))
# Calculate mobility for students
# Eighth Grade year
mobile0607 <-  moves_calc(subset(tables2006_2007$enrollment, 
                                sasid %in% hs0708$sasid))

mobile0607$sasid <- as.character(mobile0607$sasid)
hs0708 <- left_join(hs0708, mobile0607)

mobile0708 <-  moves_calc(subset(tables2007_2008$enrollment, 
                                sasid %in% hs0809$sasid))

mobile0708$sasid <- as.character(mobile0708$sasid)
hs0809 <- left_join(hs0809, mobile0708)

mobile0809 <-  moves_calc(subset(tables2008_2009$enrollment, 
                                sasid %in% hs0910$sasid))

mobile0809$sasid <- as.character(mobile0809$sasid)
hs0910 <- left_join(hs0910, mobile0809)

# Bring in 8th grade performance on standardized tests.
tables2006_2007$achievement$sasid <- as.character(tables2006_2007$achievement$sasid)
tables2006_2007$achievement$studentid <- as.character(tables2006_2007$achievement$studentid)

tables2007_2008$achievement$sasid <- as.character(tables2007_2008$achievement$sasid)
tables2007_2008$achievement$studentid <- as.character(tables2007_2008$achievement$studentid)

tables2008_2009$achievement$sasid <- as.character(tables2008_2009$achievement$sasid)
tables2008_2009$achievement$studentid <- as.character(tables2008_2009$achievement$studentid)


hs0708 <- left_join(hs0708, tables2006_2007$achievement %.% 
                            filter(testgrade_N==8, testgrade_N==grade) %.%
                            dplyr::select(sasid, grade, reaal, reascsc, matal, 
                                          matscsc, testgrade_N, reanormal, 
                                          matnormal))
hs0809 <- left_join(hs0809, tables2007_2008$achievement %.% 
                            filter(testgrade_N==8, testgrade_N==grade) %.%
                            dplyr::select(sasid, grade, reaal, reascsc, matal, 
                                          matscsc, testgrade_N, reanormal, 
                                          matnormal))
hs0910 <- left_join(hs0910, tables2008_2009$achievement %.% 
                            filter(testgrade_N==8, testgrade_N==grade) %.%
                            dplyr::select(sasid, grade, reaal, reascsc, matal, 
                                          matscsc, testgrade_N, reanormal, 
                                          matnormal))

# Attendance normalized
hs0708 <- mutate(hs0708, attendnormal = (attendance8th - 
                                         mean(attendance8th, na.rm=TRUE)) / 
                                        sd(attendance8th, na.rm=TRUE))
hs0809 <- mutate(hs0809, attendnormal = (attendance8th - 
                                         mean(attendance8th, na.rm=TRUE)) / 
                                        sd(attendance8th, na.rm=TRUE))
hs0910 <- mutate(hs0910, attendnormal = (attendance8th - 
                                         mean(attendance8th, na.rm=TRUE)) / 
                                        sd(attendance8th, na.rm=TRUE))
# GPA in 8th grade calculations
gpa0607 <- tables2006_2007$course %.% 
           filter(grade==8) %.% 
           group_by(sasid) %.% 
           dplyr::summarise(gpa8th = mean(gpa, na.rm=TRUE))
gpa0607$sasid <- as.character(gpa0607$sasid)
hs0708 <- left_join(hs0708, gpa0607)

gpa0708 <- tables2007_2008$course %.% 
           filter(grade==8) %.% 
           group_by(sasid) %.% 
           dplyr::summarise(gpa8th = mean(gpa, na.rm=TRUE))
gpa0708$sasid <- as.character(gpa0708$sasid)
hs0809 <- left_join(hs0809, gpa0708)

gpa0809 <- tables2008_2009$course %.% 
           filter(grade==8) %.% 
           group_by(sasid) %.% 
           dplyr::summarise(gpa8th = mean(gpa, na.rm=TRUE))
gpa0809$sasid <- as.character(gpa0809$sasid)
hs0910 <- left_join(hs0910, gpa0809)

# Course Failures
fails0607 <- tables2006_2007$course %.% 
             filter(grade == 8) %.%
             group_by(sasid, courseno) %.% 
             dplyr::summarise(gpa = mean(gpa, na.rm=TRUE)) %.% 
             filter(gpa <= 1.0) %.% 
             dplyr::summarise(fails = n())

fails0708 <- tables2007_2008$course %.% 
             filter(grade == 8) %.%
             group_by(sasid, courseno) %.% 
             dplyr::summarise(gpa = mean(gpa, na.rm=TRUE)) %.% 
             filter(gpa <= 1.0) %.% 
             dplyr::summarise(fails = n())

fails0809 <- tables2008_2009$course %.% 
             filter(grade == 8) %.%
             group_by(sasid, courseno) %.% 
             dplyr::summarise(gpa = mean(gpa, na.rm=TRUE)) %.% 
             filter(gpa <= 1.0) %.% 
             dplyr::summarise(fails = n())

fails0607$sasid <- as.character(fails0607$sasid)
fails0708$sasid <- as.character(fails0708$sasid)
fails0809$sasid <- as.character(fails0809$sasid)

hs0708 <- left_join(hs0708, fails0607)
hs0708$fails <- with(hs0708, ifelse(is.na(fails) & !is.na(gpa8th), 0, fails))
hs0809 <- left_join(hs0809, fails0708)
hs0809$fails <- with(hs0809, ifelse(is.na(fails) & !is.na(gpa8th), 0, fails))
hs0910 <- left_join(hs0910, fails0809)
hs0910$fails <- with(hs0910, ifelse(is.na(fails) & !is.na(gpa8th), 0, fails))
hscohort <- rbind(hs0708, hs0809, hs0910)
```
## Eighth Grade Model
### Defining the Sample
The goal of each model is to maximize the applicability of the model to maximize the number of future non-graduates as at-risk while minimizing model complexity and overall inaccuracy. The Eighth Grade Model (8GM) for predicting high school readiness uses data from students only collected in the eighth grade year. It is preferable to use only one year of data prior to entering high school to ensure the largest possible sample. Requiring additional years of data will lead to more students with an "incomplete" record containing all of the elements required to predict their probability of graduating. Defining the sample cohort for each model necessarily excludes some students because of incompleteness. 

Each cohort must have enough time to complete high school from eighth grade in order to model graduation probabilities. Our model does not specify graduation as needing to happen "on-time", or 4 years after first entering high school. However, in Providence, few students graduate in 5 or 6 years (reference TK). Therefore, we use three cohorts of students for the 8GM starting with students who enter high school in the 2007-2008 school year (expected graduation 2010-2011) through students who enter high school in the 2010-2011 school year (expected graduation 2012-2013). These are the three most recent cohorts of PPSD graduates [^cohort definition]. 

[cohort definition]: We define the graduating class for each cohort based on the National Governor's Association for cohort-adjusted graduation rates. For example, students who enter PPSD for the first time in 9th grade in the 2007-2008 school year, 10th grade in the 2008-2009 school year, 11th grade in the 2009-2010 school year, and 12th grade in the 2010-2011 school year are all part of the high school 2007-2008 cohort.

In the three most recent cohorts, there were 7,506 students. However, many of these students are excluded from the 8GM. The first exclusion comes from students who did not attend 8th grade in a PPSD school. As a result, these students do not have data from 8th grade available to the district prior to entering high school. 

There are two ways to understand the coverage of the 8GM. First, we want to understand what proportion of all students will the model be based upon. There are three ways students are excluded from the model.

1. Does the 8th grade student attend high school in Providence?
2. Did the student attrite from the data set, e.g. transfer out of the district before recording their ultimate high school outcome?
3. Does the student have a complete set of 8th grade data required by the model?

The first two questions are easily answered prior to model selection, while the third will be specific to each model. In Table 1, we show the proportion of 8th grade students who attend Providence high schools and the proportion of 8th grade students who do not transfer out by cohort.

| High School Cohort | High School Attendance        || Attrition           || Remaining ||
|                    |  In PPSD (%) | Out of PPSD (%) | Yes (%)     | No (%) |  (%) | (N) |
| :----------        | :-------:    | :-----------:   |  :-----:    | :--:   | :--: | :-: |
| 2007-2008          | 84.2      | 15.8            | 17.3    | 82.7   | 69.7   | 1499 |
| 2008-2009          | 86.6      | 13.4            | 16.7    | 83.3   | 72.1   | 1496 |
| 2009-2010          | 85.2      | 14.8            | 19.9    | 80.1   | 68.2   | 1245 | 

As demonstrated in Table 1, approximately 85% of all 8th grade PPSD students will attend at least some of high school in the district. Therefore, a large portion of these students will remain in the district to benefit from early identification of risk. 

The model for predicting graduation based on 8th grade data is built only with students who attend a Providence Public School as their final high school prior to graduating, dropping out, or transferring to a GED program (non-attrition). These students are excluded because we have no way of knowing whether or not these students ultimately graduate and their graduating is impacted substantially by non-Providence schools. Although they are excluded from the model, we can predict the likelihood that these students will graduate. Because students who are mobile tend to be disproportionately disadvantaged relative to their peers, it is likely that our model for these students is *positively biased*, i.e. these students will have higher probabilities of successfully graduating than is likely true because peers with similar observable characteristics have some unobserved advantages which resulted in being less mobile.

However, we can check to see whether or not students who transfer out are similar across observable characteristics such as race/ethnicity, course failures, grade point average, attendance, within-year school mobility, IEP status, and LEP status. If students who transfer out of PPSD appear similar across all of thes observable characteristics, then we can be less concerned about the positive bias of our estimates for students that transfer out.

```{r TransferCompare, results='asis'}
race <- with(hscohort, as.data.frame(prop.table(table(race, transfer_out), 2)))
race$transfer_out <- ifelse(race$transfer_out=='N', 
                        'Remains in PPSD', 
                        'Transfers Out of PPSD')
ggplot(data = race, aes(race, Freq)) + 
geom_bar(stat='identity') + 
geom_text(aes(label=percent(Freq)), vjust=-.4) +
scale_y_continuous('', labels = percent_format(), limits=c(0, .7)) +
scale_x_discrete('') +
theme(axis.text.x = element_text(angle = 45, hjust=1)) +
ggtitle('Race of Students by Attrition for\n Most Recent Three High School Cohorts') +
facet_wrap(~transfer_out)

grades <- with(hscohort, as.data.frame(prop.table(table(cut(gpa8th, 
                                                            breaks=seq(0,4,.5)), 
                                                        transfer_out), 2)))
grades$transfer_out <- ifelse(grades$transfer_out=='N', 
                              'Remains in PPSD', 
                              'Transfers Out of PPSD')
names(grades)[1] <- 'GPA'

ggplot(data = grades, aes(GPA, Freq)) + 
geom_bar(stat='identity') + 
geom_text(aes(label=percent(Freq)), vjust=-.4) +
scale_y_continuous('', labels = percent_format(), limits=c(0, .25)) +
scale_x_discrete('') +
theme(axis.text.x = element_text(angle = 45, hjust=1)) +
ggtitle('GPA of Students by Attrition for\n Most Recent Three High School Cohorts') +
facet_wrap(~transfer_out)

mobility <- with(hscohort, as.data.frame(prop.table(table(moves, transfer_out), 
                                                    2)))
mobility$transfer_out <- ifelse(mobility$transfer_out=='N', 
                                'Remains in PPSD', 
                                'Transfers Out of PPSD')
ggplot(data = mobility, aes(moves, Freq)) + 
geom_bar(stat='identity') + 
geom_text(aes(label=percent(Freq)), vjust=-.4) +
scale_y_continuous('', labels = percent_format(), limits=c(0, 1)) +
scale_x_discrete('') +
ggtitle('School Changes in 8th Grade of Students by Attrition for\n Most Recent Three High School Cohorts') +
facet_wrap(~transfer_out)
```



```{r RunModel}
hscohort <- filter(hscohort, transfer_out=='N')
hscohort$schoolyear_first <- as.factor(hscohort$schoolyear_first)
# hscohort$graduated <- ifelse(hscohort$graduated == 'Y', 1, 
#                              ifelse(hscohort$graduated == 'N', 0, NA))
hscohort$graduated <- as.factor(hscohort$graduated)
hscohort <- na.omit(hscohort)
# hscohort$testgrade_N <- NULL
# hscohort$transfer_out <- NULL
# hscohort$still_enrl <- NULL
# hscohort$ged <- NULL
# hscohort$dropout <- NULL
# hscohort$disappear <- NULL
# hscohort$exit_type_last <-NULL
# hscohort$exit_type_first <-NULL
# hscohort$grade_first <-NULL
require(caret)
trainIndex <- createDataPartition(hscohort$graduated,
                                  p = .8, list=FALSE)
hscohort_train <- hscohort[trainIndex,]
hscohort_test <- hscohort[-trainIndex,]

model.1 <- train(graduated~ attendnormal + gpa8th + reanormal + matnormal + 
                 I(sex=='Male') + I(ageHS>190), 
                 data=hscohort_train,
                 method='glm',
                 tuneLength = 10,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary),
                 metric='ROC')

model.2 <- train(graduated~ attendnormal + gpa8th + reanormal + matnormal + 
                 I(sex=='Male') + I(ageHS>190) + fails + moves + iep, 
                 data=hscohort_train,
                 method='ctree',
                 tuneLength = 10,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary),
                 metric='ROC')



summary(resamples(list(glm = model.1, forrest = model.2)))

# basemodel8thgrade <- glm(as.numeric(as.factor(graduated))-1 ~
#                          attendnormal + gpa8th + matnormal + reanormal +
#                          I(ageHS<190),
#                          data=hscohort, family=binomial(link='logit'))
# require(lme4)
# mixedmodel8thgrade <- glmer(as.numeric(as.factor(graduated))-1 ~ 
#                             attendnormal + gpa8th + reanormal + matnormal +
#                             I(ageHS<190) + (1 | schoolyear_first),
#                             data=hscohort, family=binomial(link='logit'))
# summary(basemodel8thgrade)
```
Predictive models are traditionally evaluated on their ability to correctly classify, or sort, students so that predicted outcomes match the actual outcomes. Our model outputs a probability of graduating for each student that can take on any value between 0 and 1. In order to sort students into those who are at risk of failing to graduate and those who are not, we have to select threshold probabilities above which students are not considered at risk and below which they are.

Thresholds for predictive data are often set at the point with the highest *accuracy*. Accuracy is highest where the proportion of students who are correctly classified as graduating or not graduating is the greatest. Therefore, accuracy values *true positives*, identifying students who will graduate, the same as *true negatives*, identifying students who will not graduate. Beacuse we want to intervene on the behalf of students who are falling behind, accuracy alone may not be the best way to set thresholds. Instead, we want to maximize the *true negative rate*, ensuring we capture as many students who fail to graduate as possible, while maintaining the best accuracy possible. In practice, this means the best cutoff thresholds for high risk may have slightly less than the maximum accuracy.

The Rhode Island Department of Education (RIDE) has been developing an Early Warning System using statewide data. They have set thresholds for high, moderate, and low risk by examining the true negative rate and accuracy. The true negative rate for high, moderate, and low risk are 0.8, 0.7, and 0.6.

```{r ConfusionMatrixforPrediction}
m1_predict <- predict(model.1, newdata = hscohort_test, type='prob')
m2_predict <- predict(model.2, newdata = hscohort_test, type='prob')
# Using type = 'prob' gives probabiliy of Y or N classification. No type would
# classify using 0.5 as the cutoff. Using the below, I can check various cutoffs
# by changing the 0.5 which tweaks sensitivity versus specificity.
m1_predict_class <- ifelse(m1_predict$Y > 0.5, 'Y', 'N')
m2_predict_class <- ifelse(m2_predict$Y > 0.5, 'Y', 'N')
confusionMatrix(m1_predict_class, hscohort_test$graduated, positive='Y')
confusionMatrix(m2_predict_class, hscohort_test$graduated, positive='Y')
```

**Need to update this section with the new numbers**

In examining the results of our predictive model, we find that at a true negative rate of 0.8, the accuracy of our classifier is 71%. The maximum accuracy is approximately 73.5%, at which the true negative rate is 0.69. Therefore, we feel our data supports using the 0.8 threshold for high risk because the modest tradeoff in accuracy is more than made up by the increase in true negative rate.

There are two key ways to compare the model developed in this work to the RIDE Early Warning System aggregate indicator. The first measure is *coverage*, or what proportion of total drop outs are identified by the measure. For the same reasons we are maximizing the *true negative rate*, we want to be sure that our risk thresholds identify as many of the students who ultimately fail to graduate as possible. Our model captures 37% of all drop outs in the 8th grade, a consderable improvement on the state's model which captures fewer than 20% of all drop outs. The state's model, however, is slightly more accurate, at approximately 80% versus 71%. We believe this model represents a better tradeoff between accuracy and coverage. Many more students would be incorrectly identified as in need of supports under the state model in order to capture 37% of all drop outs.

## Ninth Grade Model

The model used to predict graduation for ninth grade students is restricted to first-time ninth grade students who do not transfer out of Providence Public Schools.

Because of the exclusion of students who transfer out, we may be concerned that we are biasing our model since students who transfer out may represent more vulnerable students who are less likely to graduate than their peers. A quick check to see if this is accurate is to examine whether students who transfer out are dramatically different in key ways from those who remain. (I could do a more extensive chart here) One of the key early indicators of likelihood to graduate is 9th grade retention. There is a massive differential in graduation rates between students who are retained versus those who are not (approximately 15% versus nearly 60%).

However, students who transfer out are only retained at moderately higher rates which is unlikely to represent any true relationship. For example, for first-time high school freshman in 2007-2008, 14% of students who remained in Providence Public schools for the entirety of their high school enrollment were retained in 9th grade compared to ~16.5% of those who transfer out of Providence Public Schools.


```{r FirstQuarter9thGrade}
# First Quarter Grades
gpa_qtr1_0708 <- tables2007_2008$course %.% 
                 filter(grade == 9 & sasid %in% hscohort$sasid) %.% 
                 group_by(sasid, variable) %.% 
                 summarize(gpa_qtr1_9th = mean(gpa, na.rm=TRUE)) %.%
                 filter(variable == 'cum_qtr1') %.%
                 select(sasid, gpa_qtr1_9th)
gpa_qtr1_0809 <- tables2008_2009$course %.% 
                 filter(grade == 9 & sasid %in% hscohort$sasid) %.% 
                 group_by(sasid, variable) %.% 
                 summarize(gpa_qtr1_9th = mean(gpa, na.rm=TRUE)) %.%
                 filter(variable == 'cum_qtr1') %.%
                 select(sasid, gpa_qtr1_9th)
gpa_qtr1_0910 <- tables2009_2010$course %.% 
                 filter(grade == 9 & sasid %in% hscohort$sasid) %.% 
                 group_by(sasid, variable) %.% 
                 summarize(gpa_qtr1_9th = mean(gpa, na.rm=TRUE)) %.%
                 filter(variable == 'cum_qtr1') %.%
                 select(sasid, gpa_qtr1_9th)

# First Quarter Course Failures
fails_qtr1_0708 <- tables2007_2008$course %.% 
                   filter(grade == 9 & sasid %in% hscohort$sasid) %.%
                   group_by(sasid, variable, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0 & variable == 'cum_qtr1') %.% 
                   summarize(fails_qtr1 = n())

fails_qtr1_0809 <- tables2008_2009$course %.% 
                   filter(grade == 9 & sasid %in% hscohort$sasid & 
                          !sasid %in% gpa_qtr1_0708) %.%
                   group_by(sasid, variable, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0 & variable == 'cum_qtr1') %.% 
                   summarize(fails_qtr1 = n())

fails_qtr1_0910 <- tables2009_2010$course %.% 
                   filter(grade == 9 & sasid %in% hscohort$sasid &
                          !sasid %in% gpa_qtr1_0809) %.%
                   group_by(sasid, variable, courseno) %.% 
                   summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
                   filter(gpa <= 1.0 & variable == 'cum_qtr1') %.% 
                   summarize(fails_qtr1 = n())


hscohort <- left_join(hscohort, 
                      rbind(gpa_qtr1_0708, gpa_qtr1_0809, gpa_qtr1_0910) %.%
                      select(sasid, gpa_qtr1_9th))

hscohort <- left_join(hscohort, 
                      rbind(fails_qtr1_0708, fails_qtr1_0809, 
                            fails_qtr1_0910) %.%
                      select(sasid, fails_qtr1))

```

```{r FirstQuarter9thpredictions}
# Fresh this because of new missing
hscohort <- na.omit(hscohort)
trainIndex <- createDataPartition(hscohort$graduated,
                                  p = .8, list=FALSE)
hscohort_train <- hscohort[trainIndex,]
hscohort_test <- hscohort[-trainIndex,]

model.orig <- train(graduated ~ attendnormal + gpa8th + #reanormal + matnormal + 
                                I(sex=='Male') + I(ageHS>190), 
                    data=hscohort_train,
                    method='glm',
                    tuneLength = 10,
                    trControl = trainControl(method = "repeatedcv", number = 10,
                                             repeats = 10, classProbs=TRUE,
                                             summaryFunction = twoClassSummary),
                    metric='ROC')
model.qtr1 <- train(graduated ~ attendnormal + gpa8th + #reanormal + matnormal + 
                                I(sex=='Male') + I(ageHS>190) + gpa_qtr1_9th +
                                fails_qtr1, 
                    data=hscohort_train,
                    method='glm',
                    tuneLength = 10,
                    trControl = trainControl(method = "repeatedcv", number = 10,
                                             repeats = 10, classProbs=TRUE,
                                             summaryFunction = twoClassSummary),
                    metric='ROC')
summary(resamples(list(initial = model.orig, updated_qtr1 = model.qtr1)))
```

```{r NinthGradeModel}
hs0708 <- subset(person, (schoolyear_first=='2007_2008' & grade_first==9) | 
                         (schoolyear_first=='2008_2009' & grade_first==10) | 
                         (schoolyear_first=='2009_2010' & grade_first==11) | 
                         (schoolyear_first=='2010_2011' & grade_first==12))
hs0708$retained <- ifelse(hs0708$sasid %in% 
                          filter(hs0708, 
                                 grade_first == 9 & 
                                 sasid %in% filter(tables2008_2009$person_annual, 
                                                   grade == 9)$sasid)$sasid,
                          'Y', 'N')

  
hs0809 <- subset(person, (schoolyear_first=='2008_2009' & grade_first==9) | 
                         (schoolyear_first=='2009_2010' & grade_first==10) | 
                         (schoolyear_first=='2010_2011' & grade_first==11) | 
                         (schoolyear_first=='2011_2012' & grade_first==12))

hs0809$retained <- ifelse(hs0809$sasid %in% 
                          filter(hs0809, 
                                 grade_first == 9 & 
                                 sasid %in% filter(tables2009_2010$person_annual, 
                                                   grade == 9)$sasid)$sasid,
                          'Y', 'N')
hs0910 <- subset(person, (schoolyear_first=='2009_2010' & grade_first==9) | 
                         (schoolyear_first=='2010_2011' & grade_first==10) | 
                         (schoolyear_first=='2011_2012' & grade_first==11) | 
                         (schoolyear_first=='2012_2013' & grade_first==12))
hs0910$retained <- ifelse(hs0910$sasid %in% 
                          filter(hs0910, 
                                 grade_first == 9 & 
                                 sasid %in% filter(tables2010_2011$person_annual, 
                                                   grade == 9)$sasid)$sasid,
                          'Y', 'N')

hs0708$sasid <- as.character(hs0708$sasid)
hs0809$sasid <- as.character(hs0809$sasid)
hs0910$sasid <- as.character(hs0910$sasid)

# Attendance is same as previous code for cohorts except that I use the school
# year that is the same as the grade_first value so that it represents 9th grade
# attendance not 8th grade.

hs0708 <- left_join(hs0708, attendance %.% filter(schoolyear == '2007_2008')
                                       %.% select(sasid, attendance, tardy, 
                                                  suspended))
hs0809 <- left_join(hs0809, attendance %.% filter(schoolyear == '2008_2009')
                                       %.% select(sasid, attendance, tardy, 
                                                  suspended))
hs0910 <- left_join(hs0910, attendance %.% filter(schoolyear == '2009_2010')
                                       %.% select(sasid, attendance, tardy, 
                                                  suspended))
hs0708 <- mutate(hs0708, attendnormal = (attendance - 
                                         mean(attendance, na.rm=TRUE)) / 
                                        sd(attendance, na.rm=TRUE))
hs0809 <- mutate(hs0809, attendnormal = (attendance - 
                                         mean(attendance, na.rm=TRUE)) / 
                                        sd(attendance, na.rm=TRUE))
hs0910 <- mutate(hs0910, attendnormal = (attendance - 
                                         mean(attendance, na.rm=TRUE)) / 
                                        sd(attendance, na.rm=TRUE))
# Calculate age when student enters 9th grade for the first time.
hs0708 <- mutate(hs0708, ageHS = age_calc(dob, as.Date('2007-09-01'), 
                                          units='months'))
hs0809 <- mutate(hs0809, ageHS = age_calc(dob, as.Date('2008-09-01'), 
                                          units='months'))
hs0910 <- mutate(hs0910, ageHS = age_calc(dob, as.Date('2009-09-01'), 
                                          units='months'))


# GPA in 8th grade tables already exist
hs0708 <- left_join(hs0708, gpa0607)
hs0809 <- left_join(hs0809, gpa0708)
hs0910 <- left_join(hs0910, gpa0809)
rm(gpa0607)
rm(gpa0708)
rm(gpa0809)

# GPA in 9th grade mimic 8th grade calculations
gpa0708 <- tables2007_2008$course %.% 
           filter(grade == 9) %.% 
           group_by(sasid) %.% 
           summarize(gpa9th = mean(gpa, na.rm=TRUE))
gpa0708$sasid <- as.character(gpa0708$sasid)
hs0708 <- left_join(hs0708, gpa0708)

gpa0809 <- tables2008_2009$course %.% 
           filter(grade == 9) %.% 
           group_by(sasid) %.% 
           summarize(gpa9th = mean(gpa, na.rm=TRUE))
hs0809 <- left_join(hs0809, gpa0809)

gpa0910 <- tables2009_2010$course %.% 
           filter(grade==9) %.% 
           group_by(sasid) %.% 
           summarize(gpa9th = mean(gpa, na.rm=TRUE))
gpa0910$sasid <- as.character(gpa0910$sasid)
hs0910 <- left_join(hs0910, gpa0910)

# Course Failures
fails0708 <- tables2007_2008$course %.% 
             filter(grade == 9) %.%
             group_by(sasid, courseno) %.% 
             summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
             filter(gpa <= 1.0) %.% 
             summarize(fails = n())

fails0809 <- tables2008_2009$course %.% 
             filter(grade == 9) %.%
             group_by(sasid, courseno) %.% 
             summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
             filter(gpa <= 1.0) %.% 
             summarize(fails = n())

fails0910 <- tables2009_2010$course %.% 
             filter(grade == 9) %.%
             group_by(sasid, courseno) %.% 
             summarize(gpa = mean(gpa, na.rm=TRUE)) %.% 
             filter(gpa <= 1.0) %.% 
             summarize(fails = n())

fails0708$sasid <- as.character(fails0708$sasid)
fails0809$sasid <- as.character(fails0809$sasid)
fails0910$sasid <- as.character(fails0910$sasid)

hs0708 <- left_join(hs0708, fails0708)
hs0708$fails <- with(hs0708, ifelse(is.na(fails) & !is.na(gpa9th), 0, fails))
hs0809 <- left_join(hs0809, fails0809)
hs0809$fails <- with(hs0809, ifelse(is.na(fails) & !is.na(gpa9th), 0, fails))
hs0910 <- left_join(hs0910, fails0910)
hs0910$fails <- with(hs0910, ifelse(is.na(fails) & !is.na(gpa9th), 0, fails))

# Mobility Calculations
mobile0708 <-  moves_calc(filter(tables2007_2008$enrollment, 
                                sasid %in% hs0708$sasid))
mobile0708$sasid <- as.character(mobile0708$sasid)
hs0708 <- left_join(hs0708, mobile0708)

mobile0809 <-  moves_calc(filter(tables2008_2009$enrollment, 
                                sasid %in% hs0809$sasid))
mobile0809$sasid <- as.character(mobile0809$sasid)
hs0809 <- left_join(hs0809, mobile0809)

mobile0910 <-  moves_calc(filter(tables2009_2010$enrollment, 
                                sasid %in% hs0910$sasid))
mobile0910$sasid <- as.character(mobile0910$sasid)
hs0910 <- left_join(hs0910, mobile0910)
```

```{r Grade9Model}
# descriminate outcome analysis range of scores for suspensions cluster use outcome for 
# differentiation in the independent variable
# k-means clustering -- try the 5 credits model
hscohort <- rbind(hs0708, hs0809, hs0910)
hscohort <- filter(hscohort, transfer_out=='N')
hscohort$schoolyear_first <- as.factor(hscohort$schoolyear_first)
hscohort$graduated <- as.factor(hscohort$graduated)
hscohort <- na.omit(hscohort)
trainIndex <- createDataPartition(hscohort$graduated,
                                  p = .8, list=FALSE)
hscohort_train <- hscohort[trainIndex,]
hscohort_test <- hscohort[-trainIndex,]

model.1 <- train(graduated ~ attendnormal + gpa8th + gpa9th + fails + retained + 
                         I(moves>1) + suspended*I(iep=='Y') + I(ageHS>190) +
                         I(schno_first=='164'), 
                 data=hscohort_train,
                 method='glm',
                 tuneLength = 10,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary),
                 metric='ROC')

model.2 <- train(graduated ~ attendnormal + gpa8th + gpa9th + fails + retained + 
                         I(moves>1) + suspended*I(iep=='Y') + I(ageHS>190) +
                         I(schno_first=='164'), 
                 data=hscohort_train,
                 method='ctree',
                 tuneLength = 10,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary),
                 metric='ROC')

summary(resamples(list(glm = model.1, forrest = model.2)))

#summary(basemodel9thgrade)
# plot(roc(graduated ~ predict(basemodel9thgrade, newdata = hscohort, 
#                                     type='response'), hscohort), print.auc=TRUE)

```


```{r TenthGradeModel}
hs0607 <- subset(person, (schoolyear_first=='2006_2007' & grade_first==9) | 
                         (schoolyear_first=='2007_2008' & grade_first==10) | 
                         (schoolyear_first=='2008_2009' & grade_first==11) | 
                         (schoolyear_first=='2009_2010' & grade_first==12))
hs0708 <- subset(person, (schoolyear_first=='2007_2008' & grade_first==9) | 
                         (schoolyear_first=='2008_2009' & grade_first==10) | 
                         (schoolyear_first=='2009_2010' & grade_first==11) | 
                         (schoolyear_first=='2010_2011' & grade_first==12))
hs0809 <- subset(person, (schoolyear_first=='2008_2009' & grade_first==9) | 
                         (schoolyear_first=='2009_2010' & grade_first==10) | 
                         (schoolyear_first=='2010_2011' & grade_first==11) | 
                         (schoolyear_first=='2011_2012' & grade_first==12))
hs0910 <- subset(person, (schoolyear_first=='2009_2010' & grade_first==9) | 
                         (schoolyear_first=='2010_2011' & grade_first==10) | 
                         (schoolyear_first=='2011_2012' & grade_first==11) | 
                         (schoolyear_first=='2012_2013' & grade_first==12))

# Repeated 9th grade
hs0607 <- left_join(hs0607, 
                    retained_calc(x = annual_demos, sid = 'sasid', 
                                  grade = 'grade', grade_value = 9))
names(hs0607)[length(names(hs0607))] <- 'retained9th'
hs0708 <- left_join(hs0708, 
                    retained_calc(x = annual_demos, sid = 'sasid', 
                                  grade = 'grade', grade_value = 9))
names(hs0708)[length(names(hs0708))] <- 'retained9th'

hs0809 <- left_join(hs0809, 
                    retained_calc(x = annual_demos, sid = 'sasid', 
                                  grade = 'grade', grade_value = 9))
names(hs0809)[length(names(hs0809))] <- 'retained9th'

hs0910 <- left_join(hs0910, 
                    retained_calc(x = annual_demos, sid = 'sasid', 
                                  grade = 'grade', grade_value = 9))
names(hs0910)[length(names(hs0910))] <- 'retained9th'

# Repeated 10th grade
hs0607 <- left_join(hs0607, 
                    retained_calc(x = annual_demos, sid = 'sasid', 
                                  grade = 'grade', grade_value = 10))
names(hs0607)[length(names(hs0607))] <- 'retained10th'
hs0708 <- left_join(hs0708, 
                    retained_calc(x = annual_demos, sid = 'sasid', 
                                  grade = 'grade', grade_value = 10))
names(hs0708)[length(names(hs0708))] <- 'retained10th'

hs0809 <- left_join(hs0809, 
                    retained_calc(x = annual_demos, sid = 'sasid', 
                                  grade = 'grade', grade_value = 10))
names(hs0809)[length(names(hs0809))] <- 'retained10th'

hs0910 <- left_join(hs0910, 
                    retained_calc(x = annual_demos, sid = 'sasid', 
                                  grade = 'grade', grade_value = 10))
names(hs0910)[length(names(hs0910))] <- 'retained10th'



hs0607$sasid <- as.character(hs0607$sasid)
hs0708$sasid <- as.character(hs0708$sasid)
hs0809$sasid <- as.character(hs0809$sasid)
hs0910$sasid <- as.character(hs0910$sasid)

# Attendance is for the second year in the system... but this may not be 10th
# grade for students who were not promoted...

hs0607 <- left_join(hs0607, attendance %.% 
                            filter(grade == 10) %.%
                            group_by(sasid) %.% 
                            filter(row_number(desc(schoolyear))==1) %.%
                            select(sasid, attendance, tardy, suspended))
hs0708 <- left_join(hs0708, attendance %.% 
                            filter(grade == 10) %.%
                            group_by(sasid) %.% 
                            filter(row_number(desc(schoolyear))==1) %.%
                            select(sasid, attendance, tardy, suspended))
hs0809 <- left_join(hs0809, attendance %.% 
                            filter(grade == 10) %.%
                            group_by(sasid) %.% 
                            filter(row_number(desc(schoolyear))==1) %.%
                            select(sasid, attendance, tardy, suspended))
hs0910 <- left_join(hs0910, attendance %.% 
                            filter(grade == 10) %.%
                            group_by(sasid) %.% 
                            filter(row_number(desc(schoolyear))==1) %.%
                            select(sasid, attendance, tardy, suspended))

hs0607 <- mutate(hs0607, attendnormal = scale(attendance))
hs0708 <- mutate(hs0708, attendnormal = scale(attendance))
hs0809 <- mutate(hs0809, attendnormal = scale(attendance))
hs0910 <- mutate(hs0910, attendnormal = scale(attendance))

# Calculate age when student enters 9th grade for the first time.
hs0607 <- mutate(hs0607, ageHS= age_calc(dob, as.Date('2006-09-01'),
                                         units='months'))
hs0708 <- mutate(hs0708, ageHS = age_calc(dob, as.Date('2007-09-01'), 
                                          units='months'))
hs0809 <- mutate(hs0809, ageHS = age_calc(dob, as.Date('2008-09-01'), 
                                          units='months'))
hs0910 <- mutate(hs0910, ageHS = age_calc(dob, as.Date('2009-09-01'), 
                                          units='months'))

# GPA tables
gpa <- rbind(tables2007_2008$course,
             tables2008_2009$course,
             tables2009_2010$course,
             tables2010_2011$course,
             tables2011_2012$course) %.%
             filter(grade == 10) %.%
             group_by(sasid, schoolyear) %.%
             summarize(gpa10th = mean(gpa, na.rm=TRUE)) %.%
             filter(row_number(schoolyear)==1) %.%
             select(sasid, gpa10th)

fails <- rbind(tables2007_2008$course,
               tables2008_2009$course,
               tables2009_2010$course,
               tables2010_2011$course,
               tables2011_2012$course) %.%
         filter(grade == 10) %.%
         group_by(sasid) %.%
         filter(schoolyear == min(schoolyear)) %.%
         group_by(sasid, courseno) %.%
         summarize(gpa10th = mean(gpa, na.rm=TRUE)) %.%
         filter(gpa10th <= 1.0) %.%
         group_by(sasid) %.%
         summarize(fails = n()) %.%
         select(sasid, fails)

# Mobility Calculations
mobile0607 <- moves_calc(filter(tables2007_2008$enrollment,
                                grade == 10))
mobile0607$schoolyear <- '2007_2008'
mobile0708 <- moves_calc(filter(tables2008_2009$enrollment,
                                grade == 10))
mobile0708$schoolyear <- '2008_2009'
mobile0809 <- moves_calc(filter(tables2009_2010$enrollment,
                                grade == 10))
mobile0809$schoolyear <- '2009_2010'
mobile0910 <- moves_calc(filter(tables2010_2011$enrollment,
                                grade == 10))
mobile0910$schoolyear <- '2010_2011'
mobile1011 <- moves_calc(filter(tables2011_2012$enrollment,
                                grade == 10))
mobile1011$schoolyear <- '2011_2012'

mobile <- rbind(mobile0607, mobile0708, mobile0809, mobile0910, mobile1011) %.%
          group_by(sasid) %.%
          filter(schoolyear == min(schoolyear))
mobile$sasid <- as.character(mobile$sasid)
```

```{r Model10}
hscohort <- rbind(hs0607, hs0708, hs0809, hs0910)
hscohort <- left_join(hscohort, gpa)
hscohort <- left_join(hscohort, fails)
hscohort <- left_join(hscohort, mobile)
hscohort <- filter(hscohort, transfer_out=='N')
hscohort$graduated <- as.factor(hscohort$graduated)
hscohort <- na.omit(hscohort)
trainIndex <- createDataPartition(hscohort$graduated,
                                  p = .8, list=FALSE)
hscohort_train <- hscohort[trainIndex,]
hscohort_test <- hscohort[-trainIndex,]

model.1 <- train(graduated ~ attendnormal + gpa10th + retained9th + 
                             retained10th + fails + I(moves>=1) + I(ageHS>190) +
                             I(schno_first=='164'), 
                 data=hscohort_train,
                 method='glm',
                 tuneLength = 10,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary),
                 metric='ROC')

model.2 <- train(graduated ~ attendnormal + gpa10th + retained9th + 
                             retained10th + fails + I(moves>=1) + I(ageHS>190) +
                             I(schno_first=='164'), 
                 data=hscohort_train,
                 method='ctree',
                 tuneLength = 10,
                 trControl = trainControl(method = "repeatedcv", number = 10,
                                          repeats = 10, classProbs=TRUE,
                                          summaryFunction = twoClassSummary),
                 metric='ROC')

summary(resamples(list(glm = model.1, forrest = model.2)))

# basemodel10thgrade <- glm(as.numeric(as.factor(graduated))-1 ~ 
#                          attendnormal + gpa10th + retained9th + retained10th +
#                          fails + I(moves>=1) + suspended*I(iep=='Y') + I(ageHS>190) +
#                          I(schno_first=='164'),
#                          data=hscohort, family=binomial(link='logit'))
```